<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Backtesting - Analytics Dashboard</title>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/themes/dark.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            /* Dark Theme Colors */
            --bg-primary: #0f1419;
            --bg-secondary: #1a1f2e;
            --bg-tertiary: #242837;
            --bg-card: #1e2332;
            --bg-hover: #2a3042;
            
            /* Accent Colors */
            --accent-blue: #00d4ff;
            --accent-green: #00ff88;
            --accent-red: #ff3366;
            --accent-purple: #9945ff;
            --accent-orange: #ff9500;
            --accent-yellow: #ffeb3b;
            
            /* Text Colors */
            --text-primary: #ffffff;
            --text-secondary: #8892b0;
            --text-muted: #495670;
            
            /* Gradients */
            --gradient-blue: linear-gradient(135deg, #667eea 0%, #00d4ff 100%);
            --gradient-green: linear-gradient(135deg, #00ff88 0%, #00d4aa 100%);
            --gradient-red: linear-gradient(135deg, #ff3366 0%, #ff6b6b 100%);
            --gradient-purple: linear-gradient(135deg, #9945ff 0%, #c770ff 100%);
            
            /* Shadows */
            --shadow-sm: 0 2px 4px rgba(0, 0, 0, 0.3);
            --shadow-md: 0 4px 6px rgba(0, 0, 0, 0.4);
            --shadow-lg: 0 10px 15px rgba(0, 0, 0, 0.5);
            --shadow-xl: 0 20px 25px rgba(0, 0, 0, 0.6);
            
            /* Glassmorphism */
            --glass-bg: rgba(255, 255, 255, 0.05);
            --glass-border: rgba(255, 255, 255, 0.1);
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            position: relative;
            overflow-x: hidden;
        }

        /* Animated Background */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(circle at 20% 50%, rgba(0, 212, 255, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 80%, rgba(153, 69, 255, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 40% 20%, rgba(0, 255, 136, 0.1) 0%, transparent 50%);
            z-index: -1;
            animation: backgroundShift 20s ease-in-out infinite;
        }

        @keyframes backgroundShift {
            0%, 100% { transform: rotate(0deg) scale(1); }
            50% { transform: rotate(180deg) scale(1.1); }
        }

        /* Animated Grid Pattern */
        body::after {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: 
                linear-gradient(rgba(0, 212, 255, 0.03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(0, 212, 255, 0.03) 1px, transparent 1px);
            background-size: 50px 50px;
            z-index: -1;
            animation: gridMove 10s linear infinite;
        }

        @keyframes gridMove {
            0% { transform: translate(0, 0); }
            100% { transform: translate(50px, 50px); }
        }

        /* Container */
        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
            position: relative;
            z-index: 1;
        }

        /* Module Header */
        .module-header {
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            border: 1px solid var(--glass-border);
            border-radius: 20px;
            padding: 25px 30px;
            margin-bottom: 30px;
            animation: slideDown 0.5s ease;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
        }

        .module-title {
            font-size: 28px;
            font-weight: 700;
            background: var(--gradient-blue);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .module-title i {
            font-size: 24px;
        }

        .module-description {
            color: var(--text-secondary);
            font-size: 14px;
            margin-top: 5px;
        }

        .header-actions {
            display: flex;
            gap: 12px;
        }

        /* Tabs */
        .tabs-container {
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            border: 1px solid var(--glass-border);
            border-radius: 20px;
            margin-bottom: 30px;
            overflow: hidden;
            animation: fadeInUp 0.6s ease;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .tabs {
            display: flex;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--glass-border);
        }

        .tab {
            flex: 1;
            padding: 18px 20px;
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .tab:hover {
            background: var(--bg-hover);
            color: var(--text-primary);
        }

        .tab.active {
            color: var(--accent-blue);
            background: var(--bg-card);
        }

        .tab.active::after {
            content: '';
            position: absolute;
            bottom: -1px;
            left: 0;
            right: 0;
            height: 2px;
            background: var(--gradient-blue);
        }

        .tab-content {
            padding: 30px;
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Cards */
        .card {
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            border: 1px solid var(--glass-border);
            border-radius: 16px;
            padding: 25px;
            margin-bottom: 20px;
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
            border-color: var(--accent-blue);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--glass-border);
        }

        .card-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .card-title i {
            color: var(--accent-blue);
        }

        /* Forms */
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: var(--text-secondary);
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 12px 16px;
            background: var(--bg-secondary);
            border: 1px solid var(--glass-border);
            border-radius: 10px;
            color: var(--text-primary);
            font-size: 14px;
            transition: all 0.3s;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--accent-blue);
            background: var(--bg-tertiary);
            box-shadow: 0 0 0 3px rgba(0, 212, 255, 0.1);
        }

        .form-group input::placeholder {
            color: var(--text-muted);
        }

        /* Signal Checkboxes */
        .signal-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 12px;
            margin-top: 10px;
        }

        .signal-item {
            position: relative;
        }

        .signal-item input[type="checkbox"] {
            position: absolute;
            opacity: 0;
            cursor: pointer;
        }

        .signal-label {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 10px 15px;
            background: var(--bg-secondary);
            border: 1px solid var(--glass-border);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 14px;
            font-weight: 500;
        }

        .signal-item input[type="checkbox"]:checked + .signal-label {
            background: var(--gradient-blue);
            border-color: transparent;
            color: white;
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .signal-label:hover {
            background: var(--bg-hover);
            border-color: var(--accent-blue);
        }

        /* Buttons */
        .btn {
            padding: 12px 24px;
            background: var(--gradient-blue);
            border: none;
            border-radius: 10px;
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-secondary {
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            border: 1px solid var(--glass-border);
        }

        .btn-secondary:hover {
            background: var(--bg-hover);
        }

        .btn-danger {
            background: var(--gradient-red);
        }

        .btn-group {
            display: flex;
            gap: 12px;
            margin-top: 20px;
        }

        /* Results Section */
        .results-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            padding: 20px;
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 2px;
            background: var(--gradient-blue);
        }

        .stat-title {
            font-size: 12px;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }

        .stat-value {
            font-size: 24px;
            font-weight: 700;
            color: var(--text-primary);
        }

        .stat-value.positive {
            color: var(--accent-green);
        }

        .stat-value.negative {
            color: var(--accent-red);
        }

        /* Charts */
        .chart-container {
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            border: 1px solid var(--glass-border);
            border-radius: 16px;
            padding: 25px;
            margin-bottom: 20px;
            height: 400px;
            position: relative;
        }

        /* Table */
        .table-wrapper {
            overflow-x: auto;
            margin-top: 20px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            text-align: left;
            padding: 12px;
            background: var(--bg-secondary);
            color: var(--text-secondary);
            font-weight: 600;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        td {
            padding: 14px 12px;
            border-bottom: 1px solid var(--glass-border);
            font-size: 14px;
            color: var(--text-primary);
        }

        tbody tr {
            transition: all 0.3s ease;
        }

        tbody tr:hover {
            background: var(--bg-hover);
        }

        /* Progress Bar */
        .progress-container {
            width: 100%;
            height: 6px;
            background: var(--bg-secondary);
            border-radius: 3px;
            overflow: hidden;
            margin-bottom: 20px;
        }

        .progress-bar {
            height: 100%;
            background: var(--gradient-blue);
            border-radius: 3px;
            transition: width 0.3s ease;
            position: relative;
        }

        .progress-bar::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            bottom: 0;
            right: 0;
            background: linear-gradient(
                90deg,
                transparent,
                rgba(255, 255, 255, 0.3),
                transparent
            );
            animation: shimmer 2s infinite;
        }

        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        /* Loading State */
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 60px;
            color: var(--text-muted);
        }

        .spinner {
            border: 3px solid rgba(0, 212, 255, 0.2);
            border-top: 3px solid var(--accent-blue);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Alert Messages */
        .alert {
            padding: 16px 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 12px;
            animation: slideInRight 0.5s ease;
        }

        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .alert-success {
            background: rgba(0, 255, 136, 0.1);
            border: 1px solid rgba(0, 255, 136, 0.3);
            color: var(--accent-green);
        }

        .alert-error {
            background: rgba(255, 51, 102, 0.1);
            border: 1px solid rgba(255, 51, 102, 0.3);
            color: var(--accent-red);
        }

        .alert-info {
            background: rgba(0, 212, 255, 0.1);
            border: 1px solid rgba(0, 212, 255, 0.3);
            color: var(--accent-blue);
        }

        /* Floating particles */
        .particles {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 0;
        }

        .particle {
            position: absolute;
            background: var(--accent-blue);
            border-radius: 50%;
            opacity: 0.3;
            animation: float 20s infinite linear;
        }

        @keyframes float {
            0% {
                transform: translateY(100vh) translateX(0);
                opacity: 0;
            }
            10% {
                opacity: 0.3;
            }
            90% {
                opacity: 0.3;
            }
            100% {
                transform: translateY(-100vh) translateX(100px);
                opacity: 0;
            }
        }

        /* Responsive */
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }

            .form-grid {
                grid-template-columns: 1fr;
            }

            .results-grid {
                grid-template-columns: 1fr 1fr;
            }

            .tabs {
                overflow-x: auto;
            }

            .tab {
                min-width: 120px;
            }
        }
    </style>
</head>
<body>
    <!-- Floating Particles -->
    <div class="particles">
        <div class="particle" style="width: 4px; height: 4px; left: 10%; animation-delay: 0s;"></div>
        <div class="particle" style="width: 3px; height: 3px; left: 20%; animation-delay: 2s;"></div>
        <div class="particle" style="width: 5px; height: 5px; left: 30%; animation-delay: 4s;"></div>
        <div class="particle" style="width: 2px; height: 2px; left: 40%; animation-delay: 6s;"></div>
        <div class="particle" style="width: 4px; height: 4px; left: 50%; animation-delay: 8s;"></div>
        <div class="particle" style="width: 3px; height: 3px; left: 60%; animation-delay: 10s;"></div>
        <div class="particle" style="width: 5px; height: 5px; left: 70%; animation-delay: 12s;"></div>
        <div class="particle" style="width: 2px; height: 2px; left: 80%; animation-delay: 14s;"></div>
    </div>

    <div class="container">
        <!-- Module Header -->
        <div class="module-header">
            <div class="header-content">
                <div>
                    <h1 class="module-title">
                        <i class="fas fa-chart-line"></i>
                        Backtesting Analytics
                    </h1>
                    <p class="module-description">Test your trading strategies with historical data</p>
                </div>
                <div class="header-actions">
                    <button class="btn btn-secondary" onclick="window.location.href='/'">
                        <i class="fas fa-arrow-left"></i> Back
                    </button>
                </div>
            </div>
        </div>

        <!-- Tabs -->
        <div class="tabs-container">
            <div class="tabs">
                <div class="tab active" onclick="switchTab(event, 'setup')">
                    <i class="fas fa-cog"></i> Setup
                </div>
                <div class="tab" onclick="switchTab(event, 'results')">
                    <i class="fas fa-chart-bar"></i> Results
                </div>
                <div class="tab" onclick="switchTab(event, 'trades')">
                    <i class="fas fa-list"></i> Trades
                </div>
                <div class="tab" onclick="switchTab(event, 'analysis')">
                    <i class="fas fa-analytics"></i> Analysis
                </div>
            </div>

            <!-- Setup Tab -->
            <div id="setup" class="tab-content active">
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">
                            <i class="fas fa-calendar"></i>
                            Date Range Selection
                        </div>
                    </div>
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="fromDate">From Date</label>
                            <input type="text" id="fromDate" placeholder="Select start date">
                        </div>
                        <div class="form-group">
                            <label for="toDate">To Date</label>
                            <input type="text" id="toDate" placeholder="Select end date">
                        </div>
                        <div class="form-group">
                            <label for="timeframe">Timeframe</label>
                            <select id="timeframe">
                                <option value="5min">5 Minutes</option>
                                <option value="15min">15 Minutes</option>
                                <option value="30min">30 Minutes</option>
                                <option value="1hour">1 Hour</option>
                                <option value="daily">Daily</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <div class="card-title">
                            <i class="fas fa-signal"></i>
                            Signal Selection
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Select Signals to Test</label>
                        <div class="signal-grid">
                            <div class="signal-item">
                                <input type="checkbox" id="s1" checked>
                                <label for="s1" class="signal-label">S1</label>
                            </div>
                            <div class="signal-item">
                                <input type="checkbox" id="s2">
                                <label for="s2" class="signal-label">S2</label>
                            </div>
                            <div class="signal-item">
                                <input type="checkbox" id="s3">
                                <label for="s3" class="signal-label">S3</label>
                            </div>
                            <div class="signal-item">
                                <input type="checkbox" id="s4">
                                <label for="s4" class="signal-label">S4</label>
                            </div>
                            <div class="signal-item">
                                <input type="checkbox" id="s5">
                                <label for="s5" class="signal-label">S5</label>
                            </div>
                            <div class="signal-item">
                                <input type="checkbox" id="s6">
                                <label for="s6" class="signal-label">S6</label>
                            </div>
                            <div class="signal-item">
                                <input type="checkbox" id="s7">
                                <label for="s7" class="signal-label">S7</label>
                            </div>
                            <div class="signal-item">
                                <input type="checkbox" id="s8">
                                <label for="s8" class="signal-label">S8</label>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <div class="card-title">
                            <i class="fas fa-sliders-h"></i>
                            Trading Parameters
                        </div>
                    </div>
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="capital">Initial Capital</label>
                            <input type="number" id="capital" value="500000" placeholder="Enter capital">
                        </div>
                        <div class="form-group">
                            <label for="lotSize">Lot Size</label>
                            <input type="number" id="lotSize" value="10" placeholder="Enter lot size">
                        </div>
                        <div class="form-group">
                            <label for="stopLoss">Stop Loss (%)</label>
                            <input type="number" id="stopLoss" value="2" step="0.1" placeholder="Enter stop loss">
                        </div>
                        <div class="form-group">
                            <label for="target">Target (%)</label>
                            <input type="number" id="target" value="5" step="0.1" placeholder="Enter target">
                        </div>
                    </div>

                    <div class="btn-group">
                        <button class="btn" onclick="runBacktest()">
                            <i class="fas fa-play"></i> Run Backtest
                        </button>
                        <button class="btn btn-secondary" onclick="resetForm()">
                            <i class="fas fa-redo"></i> Reset
                        </button>
                    </div>
                </div>
            </div>

            <!-- Results Tab -->
            <div id="results" class="tab-content">
                <div class="progress-container">
                    <div class="progress-bar" style="width: 0%"></div>
                </div>

                <div class="results-grid">
                    <div class="stat-card">
                        <div class="stat-title">Total P&L</div>
                        <div class="stat-value positive" id="totalPnl">₹0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-title">Win Rate</div>
                        <div class="stat-value" id="winRate">0%</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-title">Total Trades</div>
                        <div class="stat-value" id="totalTrades">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-title">Max Drawdown</div>
                        <div class="stat-value negative" id="maxDrawdown">₹0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-title">Sharpe Ratio</div>
                        <div class="stat-value" id="sharpeRatio">0.00</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-title">Profit Factor</div>
                        <div class="stat-value" id="profitFactor">0.00</div>
                    </div>
                </div>

                <div class="chart-container">
                    <canvas id="equityCurve"></canvas>
                </div>

                <div class="chart-container">
                    <canvas id="monthlyReturns"></canvas>
                </div>
            </div>

            <!-- Trades Tab -->
            <div id="trades" class="tab-content">
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">
                            <i class="fas fa-history"></i>
                            Trade History
                        </div>
                    </div>
                    <div class="table-wrapper">
                        <table>
                            <thead>
                                <tr>
                                    <th>Date/Time</th>
                                    <th>Signal</th>
                                    <th>Symbol</th>
                                    <th>Type</th>
                                    <th>Entry</th>
                                    <th>Exit</th>
                                    <th>Quantity</th>
                                    <th>P&L</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody id="tradesTableBody">
                                <tr>
                                    <td colspan="9" style="text-align: center; color: var(--text-muted);">
                                        No trades to display. Run backtest first.
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Analysis Tab -->
            <div id="analysis" class="tab-content">
                <div class="loading">
                    <div class="spinner"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Initialize date pickers
        flatpickr("#fromDate", {
            theme: "dark",
            dateFormat: "Y-m-d",
            defaultDate: new Date(Date.now() - 30 * 24 * 60 * 60 * 1000)
        });

        flatpickr("#toDate", {
            theme: "dark",
            dateFormat: "Y-m-d",
            defaultDate: new Date()
        });

        // Chart configuration
        Chart.defaults.color = '#8892b0';
        Chart.defaults.borderColor = 'rgba(255, 255, 255, 0.1)';

        // Switch tabs
        function switchTab(event, tabName) {
            // Update tab buttons
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.currentTarget.classList.add('active');

            // Update tab content
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(tabName).classList.add('active');

            // Initialize charts if results tab
            if (tabName === 'results') {
                initializeCharts();
            }
        }

        // Initialize charts
        function initializeCharts() {
            // Equity Curve
            const equityCtx = document.getElementById('equityCurve').getContext('2d');
            new Chart(equityCtx, {
                type: 'line',
                data: {
                    labels: generateDateLabels(),
                    datasets: [{
                        label: 'Equity Curve',
                        data: generateMockEquityData(),
                        borderColor: '#00d4ff',
                        backgroundColor: 'rgba(0, 212, 255, 0.1)',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });

            // Monthly Returns
            const monthlyCtx = document.getElementById('monthlyReturns').getContext('2d');
            new Chart(monthlyCtx, {
                type: 'bar',
                data: {
                    labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'],
                    datasets: [{
                        label: 'Monthly Returns',
                        data: [12, -5, 8, 15, -3, 10],
                        backgroundColor: function(context) {
                            const value = context.parsed.y;
                            return value < 0 ? 'rgba(255, 51, 102, 0.5)' : 'rgba(0, 255, 136, 0.5)';
                        }
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });
        }

        // Generate mock data
        function generateDateLabels() {
            const labels = [];
            for (let i = 0; i < 30; i++) {
                const date = new Date(Date.now() - (30 - i) * 24 * 60 * 60 * 1000);
                labels.push(date.toLocaleDateString());
            }
            return labels;
        }

        function generateMockEquityData() {
            const data = [];
            let equity = 500000;
            for (let i = 0; i < 30; i++) {
                equity += (Math.random() - 0.45) * 10000;
                data.push(equity);
            }
            return data;
        }

        // Run backtest
        async function runBacktest() {
            const progressBar = document.querySelector('.progress-bar');
            progressBar.style.width = '0%';

            // Collect form data
            const fromDate = document.getElementById('fromDate').value;
            const toDate = document.getElementById('toDate').value;
            const signals = [];
            
            for (let i = 1; i <= 8; i++) {
                if (document.getElementById(`s${i}`).checked) {
                    signals.push(`S${i}`);
                }
            }

            const params = {
                from_date: fromDate,
                to_date: toDate,
                signals_to_test: signals,
                initial_capital: parseFloat(document.getElementById('capital').value),
                lot_size: parseInt(document.getElementById('lotSize').value),
                stop_loss: parseFloat(document.getElementById('stopLoss').value),
                target: parseFloat(document.getElementById('target').value)
            };

            // Animate progress
            let progress = 0;
            const progressInterval = setInterval(() => {
                progress += 10;
                progressBar.style.width = progress + '%';
                if (progress >= 90) {
                    clearInterval(progressInterval);
                }
            }, 200);

            try {
                const API_BASE = window.location.protocol === 'file:' ? 'http://localhost:8000' : '';
                const response = await fetch(`${API_BASE}/backtest`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(params)
                });

                const data = await response.json();
                
                // Complete progress
                clearInterval(progressInterval);
                progressBar.style.width = '100%';

                // Update results
                updateResults(data);

                // Switch to results tab
                document.querySelector('.tab:nth-child(2)').click();

            } catch (error) {
                console.error('Backtest failed:', error);
                clearInterval(progressInterval);
                progressBar.style.width = '0%';
            }
        }

        // Update results
        function updateResults(data) {
            if (data.summary) {
                document.getElementById('totalPnl').textContent = formatCurrency(data.summary.total_pnl);
                document.getElementById('winRate').textContent = (data.summary.win_rate || 0).toFixed(1) + '%';
                document.getElementById('totalTrades').textContent = data.summary.total_trades || 0;
                document.getElementById('maxDrawdown').textContent = formatCurrency(data.summary.max_drawdown || 0);
                document.getElementById('sharpeRatio').textContent = (data.summary.sharpe_ratio || 0).toFixed(2);
                document.getElementById('profitFactor').textContent = (data.summary.profit_factor || 0).toFixed(2);

                // Update value colors
                const pnlElement = document.getElementById('totalPnl');
                pnlElement.className = data.summary.total_pnl >= 0 ? 'stat-value positive' : 'stat-value negative';
            }

            // Update trades table
            if (data.trades && data.trades.length > 0) {
                updateTradesTable(data.trades);
            }
        }

        // Update trades table
        function updateTradesTable(trades) {
            const tbody = document.getElementById('tradesTableBody');
            tbody.innerHTML = trades.map(trade => `
                <tr>
                    <td>${new Date(trade.entry_time).toLocaleString()}</td>
                    <td><span style="color: var(--accent-blue)">${trade.signal}</span></td>
                    <td>${trade.symbol}</td>
                    <td>${trade.trade_type}</td>
                    <td>₹${trade.entry_price.toFixed(2)}</td>
                    <td>₹${trade.exit_price.toFixed(2)}</td>
                    <td>${trade.quantity}</td>
                    <td class="${trade.pnl >= 0 ? 'positive' : 'negative'}">
                        ${trade.pnl >= 0 ? '+' : ''}₹${Math.abs(trade.pnl).toFixed(2)}
                    </td>
                    <td>
                        <span style="color: ${trade.status === 'WIN' ? 'var(--accent-green)' : 'var(--accent-red)'}">
                            ${trade.status}
                        </span>
                    </td>
                </tr>
            `).join('');
        }

        // Format currency
        function formatCurrency(value) {
            const prefix = value >= 0 ? '+' : '';
            return `${prefix}₹${Math.abs(value).toLocaleString()}`;
        }

        // Reset form
        function resetForm() {
            document.getElementById('fromDate').value = '';
            document.getElementById('toDate').value = '';
            document.getElementById('capital').value = '500000';
            document.getElementById('lotSize').value = '10';
            document.getElementById('stopLoss').value = '2';
            document.getElementById('target').value = '5';
            
            // Reset checkboxes
            document.querySelectorAll('.signal-item input').forEach(cb => {
                cb.checked = false;
            });
            document.getElementById('s1').checked = true;
        }
    </script>
</body>
</html>
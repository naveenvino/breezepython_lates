<!DOCTYPE html>
<html>
<head>
    <title>Debug Candle Monitor</title>
    <style>
        body { font-family: monospace; padding: 20px; }
        .section { margin: 20px 0; padding: 10px; border: 1px solid #ccc; }
        .success { color: green; }
        .error { color: red; }
        pre { background: #f0f0f0; padding: 10px; overflow-x: auto; }
    </style>
</head>
<body>
    <h1>Debug Candle Monitor</h1>
    
    <div class="section">
        <h2>1. Test API Endpoints</h2>
        <button onclick="testAPIs()">Test APIs</button>
        <div id="api-results"></div>
    </div>
    
    <div class="section">
        <h2>2. Test Display Logic</h2>
        <button onclick="testDisplay()">Test Display</button>
        <div id="display-results"></div>
    </div>
    
    <div class="section">
        <h2>3. Live Test</h2>
        <div>Current NIFTY: <span id="testCurrentNifty">--</span></div>
        <div>Last 1H Close: <span id="testLastClose">--</span></div>
        <button onclick="updateDisplay()">Update Now</button>
    </div>

    <script>
        async function testAPIs() {
            const resultsDiv = document.getElementById('api-results');
            resultsDiv.innerHTML = '<h3>Testing APIs...</h3>';
            
            // Test NIFTY spot
            try {
                const spotRes = await fetch('http://localhost:8000/api/live/nifty-spot');
                const spotData = await spotRes.json();
                
                resultsDiv.innerHTML += `
                    <h4>NIFTY Spot API:</h4>
                    <pre>${JSON.stringify(spotData, null, 2)}</pre>
                    <p>Success: ${spotData.success ? '✅' : '❌'}</p>
                    <p>Has data: ${spotData.data ? '✅' : '❌'}</p>
                    <p>LTP: ${spotData.data?.ltp || 'NOT FOUND'}</p>
                    <p>is_real: ${spotData.data?.is_real}</p>
                    <p>is_mock: ${spotData.data?.is_mock}</p>
                `;
            } catch (e) {
                resultsDiv.innerHTML += `<p class="error">NIFTY Spot Error: ${e}</p>`;
            }
            
            // Test hourly candle
            try {
                const candleRes = await fetch('http://localhost:8000/api/breeze/hourly-candle');
                const candleData = await candleRes.json();
                
                resultsDiv.innerHTML += `
                    <h4>Hourly Candle API:</h4>
                    <pre>${JSON.stringify(candleData, null, 2)}</pre>
                    <p>Success: ${candleData.success ? '✅' : '❌'}</p>
                    <p>Has candle: ${candleData.candle ? '✅' : '❌'}</p>
                    <p>Close: ${candleData.candle?.close || 'NOT FOUND'}</p>
                    <p>Source: ${candleData.source}</p>
                `;
            } catch (e) {
                resultsDiv.innerHTML += `<p class="error">Hourly Candle Error: ${e}</p>`;
            }
        }
        
        async function testDisplay() {
            const resultsDiv = document.getElementById('display-results');
            resultsDiv.innerHTML = '<h3>Testing Display Logic...</h3>';
            
            // Fetch data
            const spotRes = await fetch('http://localhost:8000/api/live/nifty-spot');
            const spotData = await spotRes.json();
            
            const candleRes = await fetch('http://localhost:8000/api/breeze/hourly-candle');
            const candleData = await candleRes.json();
            
            // Test validation logic
            resultsDiv.innerHTML += '<h4>Validation Tests:</h4>';
            
            // Test 1: Check is_real vs is_mock
            const isRealCheck = spotData.data?.is_real || !spotData.data?.is_mock;
            resultsDiv.innerHTML += `<p>is_real check: ${isRealCheck ? '✅ PASS' : '❌ FAIL'}</p>`;
            
            // Test 2: Check LTP value
            const ltp = spotData.data?.ltp;
            const ltpValid = ltp && ltp > 15000 && ltp < 35000;
            resultsDiv.innerHTML += `<p>LTP (${ltp}) valid range [15000-35000]: ${ltpValid ? '✅ PASS' : '❌ FAIL'}</p>`;
            
            // Test 3: Check candle close
            const close = candleData.candle?.close;
            const closeValid = close && close > 0;
            resultsDiv.innerHTML += `<p>Candle close (${close}) > 0: ${closeValid ? '✅ PASS' : '❌ FAIL'}</p>`;
            
            // Test 4: Final validation
            const spotValid = spotData.success && spotData.data && isRealCheck && ltpValid;
            const candleValid = candleData.success && closeValid;
            
            resultsDiv.innerHTML += `<h4>Final Validation:</h4>`;
            resultsDiv.innerHTML += `<p>Spot data valid: ${spotValid ? '✅ PASS' : '❌ FAIL'}</p>`;
            resultsDiv.innerHTML += `<p>Candle data valid: ${candleValid ? '✅ PASS' : '❌ FAIL'}</p>`;
        }
        
        async function updateDisplay() {
            try {
                // Fetch spot
                const spotRes = await fetch('http://localhost:8000/api/live/nifty-spot');
                const spotData = await spotRes.json();
                
                // Fetch candle
                const candleRes = await fetch('http://localhost:8000/api/breeze/hourly-candle');
                const candleData = await candleRes.json();
                
                // Update display
                const spotEl = document.getElementById('testCurrentNifty');
                const closeEl = document.getElementById('testLastClose');
                
                if (spotData.success && spotData.data && spotData.data.ltp) {
                    spotEl.textContent = spotData.data.ltp.toFixed(2);
                    spotEl.className = 'success';
                } else {
                    spotEl.textContent = 'No data';
                    spotEl.className = 'error';
                }
                
                if (candleData.success && candleData.candle && candleData.candle.close) {
                    closeEl.textContent = candleData.candle.close.toFixed(2);
                    closeEl.className = 'success';
                } else {
                    closeEl.textContent = 'No data';
                    closeEl.className = 'error';
                }
                
            } catch (e) {
                console.error('Update error:', e);
            }
        }
        
        // Auto-update every 5 seconds
        setInterval(updateDisplay, 5000);
        updateDisplay(); // Initial update
    </script>
</body>
</html>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="cache-control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="pragma" content="no-cache">
    <meta http-equiv="expires" content="0">
    <title>Unified Trading Platform</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Authentication Scripts -->
    <script>
        // Simple auth bypass for local development
        // Only redirect to login if auth scripts are available and not localhost
        if (window.location.hostname !== 'localhost' && window.location.protocol !== 'file:') {
            // Load auth scripts only for production
            const authCheck = document.createElement('script');
            authCheck.src = '/static/js/auth-check.js';
            authCheck.onerror = function() {
                console.log('Auth scripts not found - running without authentication');
            };
            document.head.appendChild(authCheck);
            
            const authManager = document.createElement('script');
            authManager.src = '/static/js/auth-manager.js';
            document.head.appendChild(authManager);
        } else {
            console.log('Local development mode - authentication bypassed');
        }
    </script>
    <style>
        :root {
            --primary: #667eea;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --info: #3b82f6;
            --bg-primary: #0a0e27;
            --bg-secondary: #151932;
            --bg-hover: #1e2139;
            --text-primary: #e0e6ed;
            --text-secondary: #8892b0;
            --border: #2a2f4a;
            --header-height: 60px;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Inter', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            height: 100vh;
            overflow: hidden;
        }
        
        /* Top Navigation Header */
        .top-nav {
            height: var(--header-height);
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            padding: 0 20px;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        }
        
        .logo-section {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-right: 40px;
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 20px;
            font-weight: bold;
            color: var(--primary);
            text-decoration: none;
        }
        
        /* Illuminati Eye Symbol */
        .illuminati-eye {
            position: relative;
            width: 32px;
            height: 32px;
            display: inline-block;
            animation: mysticalGlow 3s ease-in-out infinite;
        }
        
        .illuminati-eye svg {
            width: 100%;
            height: 100%;
            filter: drop-shadow(0 0 8px rgba(255, 215, 0, 0.6));
        }
        
        @keyframes mysticalGlow {
            0%, 100% {
                filter: drop-shadow(0 0 8px rgba(255, 215, 0, 0.6));
                transform: scale(1);
            }
            50% {
                filter: drop-shadow(0 0 15px rgba(255, 215, 0, 0.9));
                transform: scale(1.05);
            }
        }
        
        @keyframes eyeBlink {
            0%, 90%, 100% {
                transform: scaleY(1);
            }
            95% {
                transform: scaleY(0.1);
            }
        }
        
        .illuminati-eye:hover svg {
            filter: drop-shadow(0 0 20px rgba(255, 215, 0, 1));
            animation: eyePulse 0.5s ease-in-out;
        }
        
        @keyframes eyePulse {
            0%, 100% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.1);
            }
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 20px;
            font-weight: bold;
            color: var(--primary);
            text-decoration: none;
        }
        
        /* Main Navigation Menu */
        .nav-menu {
            display: flex;
            flex: 1;
            height: 100%;
        }
        
        .nav-dropdown {
            position: relative;
            height: 100%;
        }
        
        .nav-dropdown-trigger {
            display: flex;
            align-items: center;
            gap: 6px;
            height: 100%;
            padding: 0 20px;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s;
            border: none;
            background: transparent;
            font-size: 14px;
            font-weight: 500;
            position: relative;
        }
        
        .nav-dropdown-trigger:hover {
            color: var(--text-primary);
            background: var(--bg-hover);
        }
        
        .nav-dropdown-trigger.active {
            color: var(--primary);
            background: var(--bg-hover);
        }
        
        .nav-dropdown-trigger.active::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--primary);
        }
        
        .nav-dropdown-trigger i {
            font-size: 12px;
            opacity: 0.7;
        }
        
        /* Dropdown Menus */
        .dropdown-menu {
            position: absolute;
            top: 100%;
            left: 0;
            min-width: 220px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 8px 0;
            margin-top: 4px;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: all 0.2s;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            z-index: 1001;
        }
        
        .nav-dropdown:hover .dropdown-menu,
        .dropdown-menu:hover {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }
        
        .dropdown-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 20px;
            color: var(--text-secondary);
            text-decoration: none;
            transition: all 0.2s;
            font-size: 14px;
            cursor: pointer;
        }
        
        .dropdown-item:hover {
            background: var(--bg-hover);
            color: var(--primary);
        }
        
        .dropdown-item.active {
            color: var(--primary);
            background: rgba(102, 126, 234, 0.1);
        }
        
        .dropdown-item i {
            width: 16px;
            font-size: 14px;
            opacity: 0.8;
        }
        
        .dropdown-divider {
            height: 1px;
            background: var(--border);
            margin: 8px 0;
        }
        
        /* Special dropdown for Analytics (wider) */
        .nav-dropdown.analytics .dropdown-menu {
            min-width: 280px;
        }
        
        /* Header Actions (right side) */
        .header-actions {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .search-box {
            position: relative;
            margin-right: 20px;
        }
        
        .search-box input {
            background: var(--bg-hover);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 8px 36px 8px 12px;
            width: 250px;
            color: var(--text-primary);
            font-size: 14px;
            transition: all 0.2s;
        }
        
        .search-box input:focus {
            outline: none;
            border-color: var(--primary);
            width: 300px;
        }
        
        .search-box i {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-secondary);
            font-size: 14px;
        }
        
        .btn-icon {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 36px;
            height: 36px;
            border: none;
            background: transparent;
            color: var(--text-secondary);
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .btn-icon:hover {
            background: var(--bg-hover);
            color: var(--text-primary);
        }
        
        .notification-badge {
            position: relative;
        }
        
        /* Main Content Area */
        .main-content {
            margin-top: var(--header-height);
            height: calc(100vh - var(--header-height));
            background: var(--bg-primary);
            display: flex;
            flex-direction: column;
        }
        
        /* Breadcrumb Bar */
        .breadcrumb-bar {
            background: var(--bg-secondary);
            padding: 12px 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .breadcrumb {
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--text-secondary);
            font-size: 14px;
        }
        
        .breadcrumb a {
            color: var(--text-secondary);
            text-decoration: none;
            transition: color 0.2s;
        }
        
        .breadcrumb a:hover {
            color: var(--primary);
        }
        
        .breadcrumb .separator {
            opacity: 0.5;
        }
        
        .page-actions {
            display: flex;
            gap: 8px;
        }
        
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn-primary {
            background: var(--primary);
            color: white;
        }
        
        .btn-primary:hover {
            background: #5a67d8;
        }
        
        /* Content Area */
        .content-area {
            flex: 1;
            padding: 0;
            overflow: hidden;
            background: var(--bg-primary);
        }
        
        .iframe-container {
            width: 100%;
            height: 100%;
        }
        
        .iframe-container iframe {
            width: 100%;
            height: 100%;
            border: none;
        }
        
        /* Mobile Menu Toggle */
        .mobile-menu-toggle {
            display: none;
            background: transparent;
            border: none;
            color: var(--text-primary);
            font-size: 20px;
            cursor: pointer;
            padding: 8px;
        }
        
        /* Dashboard Welcome Screen */
        #dashboard-content {
            display: none;
            padding: 40px;
            height: 100%;
            overflow-y: auto;
        }
        
        #dashboard-content.active {
            display: block;
        }
        
        .welcome-header {
            margin-bottom: 40px;
        }
        
        .welcome-title {
            font-size: 32px;
            font-weight: bold;
            margin-bottom: 8px;
            background: linear-gradient(135deg, var(--primary), #a78bfa);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .welcome-subtitle {
            color: var(--text-secondary);
            font-size: 16px;
        }
        
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 24px;
        }
        
        .dashboard-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 24px;
            transition: all 0.3s;
        }
        
        .dashboard-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }
        
        .card-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 16px;
        }
        
        .card-icon {
            width: 48px;
            height: 48px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }
        
        .card-icon.primary {
            background: rgba(102, 126, 234, 0.2);
            color: var(--primary);
        }
        
        .card-icon.success {
            background: rgba(16, 185, 129, 0.2);
            color: var(--success);
        }
        
        .card-icon.warning {
            background: rgba(245, 158, 11, 0.2);
            color: var(--warning);
        }
        
        .card-icon.danger {
            background: rgba(239, 68, 68, 0.2);
            color: var(--danger);
        }
        
        .card-title {
            font-size: 18px;
            font-weight: 600;
        }
        
        .card-value {
            font-size: 32px;
            font-weight: bold;
            margin-bottom: 8px;
        }
        
        .card-description {
            color: var(--text-secondary);
            font-size: 14px;
        }
        
        /* Responsive Design */
        @media (max-width: 768px) {
            .mobile-menu-toggle {
                display: block;
            }
            
            .nav-menu {
                position: fixed;
                top: var(--header-height);
                left: -100%;
                width: 280px;
                height: calc(100vh - var(--header-height));
                background: var(--bg-secondary);
                border-right: 1px solid var(--border);
                flex-direction: column;
                padding: 20px 0;
                transition: left 0.3s;
                overflow-y: auto;
            }
            
            .nav-menu.active {
                left: 0;
            }
            
            .nav-dropdown {
                width: 100%;
                height: auto;
            }
            
            .nav-dropdown-trigger {
                width: 100%;
                justify-content: space-between;
                padding: 12px 20px;
            }
            
            .dropdown-menu {
                position: static;
                opacity: 1;
                visibility: visible;
                transform: none;
                box-shadow: none;
                border: none;
                padding-left: 20px;
                display: none;
            }
            
            .nav-dropdown.active .dropdown-menu {
                display: block;
            }
            
            .search-box {
                display: none;
            }
            
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
        }
        
        /* Loading Spinner */
        .loading-spinner {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 40px;
            height: 40px;
            border: 3px solid var(--border);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: translate(-50%, -50%) rotate(360deg); }
        }

        /* Broker Connection Status Bar */
        .broker-status-bar {
            background: linear-gradient(90deg, var(--bg-secondary) 0%, rgba(21, 25, 50, 0.95) 100%);
            border-bottom: 1px solid var(--border);
            padding: 8px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: fixed;
            top: var(--header-height);
            left: 0;
            right: 0;
            z-index: 999;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }

        .status-container {
            display: flex;
            align-items: center;
            gap: 20px;
            flex: 1;
        }
        
        .datetime-container {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-left: auto;
            padding: 4px 12px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .datetime-container .date {
            color: var(--text-primary);
            font-weight: 500;
            font-family: 'Courier New', monospace;
            letter-spacing: 0.5px;
        }
        
        .datetime-container .time {
            color: var(--primary);
            font-weight: 600;
            font-family: 'Courier New', monospace;
            font-size: 13px;
        }
        
        .datetime-container i {
            color: var(--primary);
            font-size: 11px;
        }

        .broker-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .indicator-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #f59e0b;
            animation: pulse 2s infinite;
        }

        .indicator-dot.connected {
            background: #10b981;
            animation: none;
            box-shadow: 0 0 10px rgba(16, 185, 129, 0.5);
        }

        .indicator-dot.disconnected {
            background: #ef4444;
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0%, 100% { 
                opacity: 1;
                transform: scale(1);
            }
            50% { 
                opacity: 0.6;
                transform: scale(1.2);
            }
        }

        .broker-text {
            color: var(--text-secondary);
            font-size: 12px;
            font-weight: 400;
            margin-left: 5px;
        }

        .broker-details {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 13px;
        }

        .broker-name {
            padding: 3px 10px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 11px;
            letter-spacing: 0.5px;
            margin: 0 5px;
            background: rgba(102, 126, 234, 0.15);
            border: 1px solid rgba(102, 126, 234, 0.3);
            color: var(--primary);
        }
        
        .broker-name.zerodha {
            background: rgba(102, 126, 234, 0.15);
            border: 1px solid rgba(102, 126, 234, 0.3);
            color: var(--primary);
        }
        
        .broker-name.breeze {
            background: rgba(102, 126, 234, 0.15);
            border: 1px solid rgba(102, 126, 234, 0.3);
            color: var(--primary);
        }

        .divider {
            color: var(--border);
        }

        .market-status {
            padding: 3px 10px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
            letter-spacing: 0.5px;
            background: rgba(239, 68, 68, 0.15);
            border: 1px solid rgba(239, 68, 68, 0.3);
            color: #ef4444;
        }

        .market-status.open {
            background: rgba(16, 185, 129, 0.15);
            border: 1px solid rgba(16, 185, 129, 0.3);
            color: #10b981;
        }
        
        .market-status.pre-market {
            background: rgba(251, 191, 36, 0.15);
            border: 1px solid rgba(251, 191, 36, 0.3);
            color: #fbbf24;
        }
        
        .market-status.post-market {
            background: rgba(251, 146, 60, 0.15);
            border: 1px solid rgba(251, 146, 60, 0.3);
            color: #fb923c;
        }
        
        .market-status.error {
            background: rgba(107, 114, 128, 0.15);
            border: 1px solid rgba(107, 114, 128, 0.3);
            color: #6b7280;
            font-style: italic;
        }


        /* Adjust main content for status bar */
        .main-content {
            margin-top: 35px;
        }
        
        /* Auto Login Buttons */
        .auto-login-btn {
            padding: 4px 12px;
            margin-left: 8px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 20px;
            color: white;
            font-size: 11px;
            font-weight: 600;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 5px;
            transition: all 0.3s ease;
            box-shadow: 0 2px 5px rgba(102, 126, 234, 0.3);
        }
        
        .auto-login-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 10px rgba(102, 126, 234, 0.5);
        }
        
        .auto-login-btn i {
            font-size: 10px;
        }
        
        .auto-login-btn.login-both {
            margin-left: 15px;
            background: linear-gradient(135deg, #f59e0b 0%, #ef4444 100%);
            box-shadow: 0 2px 5px rgba(245, 158, 11, 0.3);
        }
        
        .auto-login-btn.login-both:hover {
            box-shadow: 0 4px 10px rgba(245, 158, 11, 0.5);
        }
        
        /* Auth Status Styles - Top Right Corner */
        #auth-status {
            color: var(--text-primary);
            font-size: 14px;
            display: inline-flex;
            align-items: center;
            gap: 10px;
            margin-right: 10px;
        }
        
        #auth-status .btn-sm {
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            background: var(--primary);
            color: white;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.3s ease;
        }
        
        #auth-status .btn-sm:hover {
            background: #5a67d8;
            transform: translateY(-1px);
        }
        
        /* Override for logout button specifically */
        #auth-status button[onclick*="Logout"] {
            background: #ef4444 !important;
        }
        
        #auth-status button[onclick*="Logout"]:hover {
            background: #dc2626 !important;
        }
        
        /* Latency Badge Styles */
        .latency-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 3px 8px;
            margin-left: 8px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            font-size: 11px;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        
        .latency-badge i {
            font-size: 10px;
        }
        
        .latency-badge.excellent {
            color: #10b981;
            background: rgba(16, 185, 129, 0.1);
            border: 1px solid rgba(16, 185, 129, 0.3);
        }
        
        .latency-badge.good {
            color: #f59e0b;
            background: rgba(245, 158, 11, 0.1);
            border: 1px solid rgba(245, 158, 11, 0.3);
        }
        
        .latency-badge.slow {
            color: #f97316;
            background: rgba(249, 115, 22, 0.1);
            border: 1px solid rgba(249, 115, 22, 0.3);
        }
        
        .latency-badge.poor {
            color: #ef4444;
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.3);
        }
        
        .latency-value {
            font-family: 'Courier New', monospace;
            font-weight: 600;
        }
        
        /* Performance Metrics */
        .performance-metrics {
            display: flex;
            align-items: center;
            gap: 15px;
            font-size: 12px;
            color: var(--text-secondary);
        }
        
        .metric-item {
            display: flex;
            align-items: center;
            gap: 5px;
            padding: 4px 10px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 20px;
            transition: all 0.2s ease;
            cursor: pointer;
        }
        
        .metric-item:hover {
            background: rgba(102, 126, 234, 0.1);
            color: var(--primary);
            transform: translateY(-1px);
        }
        
        .metric-item i {
            font-size: 11px;
            opacity: 0.8;
        }
        
        .metric-item span {
            font-weight: 600;
            font-family: 'Courier New', monospace;
        }
        
        /* API Status Indicator */
        .api-status {
            position: relative;
            padding-left: 20px !important;
        }
        
        .api-indicator-dot {
            position: absolute;
            left: 8px;
            top: 50%;
            transform: translateY(-50%);
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: #6b7280;
            animation: pulse 2s infinite;
        }
        
        .api-indicator-dot.online {
            background-color: #10b981;
            animation: pulse-online 2s infinite;
        }
        
        .api-indicator-dot.offline {
            background-color: #ef4444;
            animation: none;
        }
        
        .api-indicator-dot.checking {
            background-color: #f59e0b;
            animation: pulse-checking 1s infinite;
        }
        
        @keyframes pulse-online {
            0% {
                box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.7);
            }
            70% {
                box-shadow: 0 0 0 10px rgba(16, 185, 129, 0);
            }
            100% {
                box-shadow: 0 0 0 0 rgba(16, 185, 129, 0);
            }
        }
        
        @keyframes pulse-checking {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.5;
            }
        }

        /* Search Dropdown Styles */
        .search-dropdown {
            position: absolute;
            top: calc(100% + 8px);
            left: 0;
            right: 0;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 8px;
            max-height: 400px;
            overflow-y: auto;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            z-index: 1002;
            display: none;
        }

        .search-dropdown.active {
            display: block;
        }

        .search-result {
            padding: 12px 16px;
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            transition: all 0.2s;
            border-bottom: 1px solid rgba(42, 47, 74, 0.5);
        }

        .search-result:hover,
        .search-result.selected {
            background: var(--bg-hover);
            color: var(--primary);
        }

        .search-result-icon {
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(102, 126, 234, 0.1);
            border-radius: 6px;
            color: var(--primary);
        }

        .search-result-content {
            flex: 1;
        }

        .search-result-title {
            font-weight: 500;
            font-size: 14px;
            margin-bottom: 2px;
        }

        .search-result-description {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .search-result-type {
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            background: rgba(102, 126, 234, 0.2);
            color: var(--primary);
        }

        /* Notification Panel Styles */
        .notification-panel {
            position: absolute;
            top: calc(100% + 12px);
            right: 0;
            width: 380px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            z-index: 1002;
            display: none;
            max-height: 500px;
            overflow: hidden;
        }

        .notification-panel.active {
            display: block;
        }

        .notification-header {
            padding: 16px 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .notification-title {
            font-weight: 600;
            font-size: 16px;
        }

        .notification-actions {
            display: flex;
            gap: 8px;
        }

        .notification-action {
            padding: 4px 8px;
            background: transparent;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            border-radius: 4px;
            font-size: 12px;
            transition: all 0.2s;
        }

        .notification-action:hover {
            background: var(--bg-hover);
            color: var(--primary);
        }

        .notification-list {
            max-height: 350px;
            overflow-y: auto;
        }

        .notification-item {
            padding: 16px 20px;
            border-bottom: 1px solid rgba(42, 47, 74, 0.5);
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }

        .notification-item:hover {
            background: var(--bg-hover);
        }

        .notification-item.unread {
            background: rgba(102, 126, 234, 0.05);
        }

        .notification-item.unread::before {
            content: '';
            position: absolute;
            left: 8px;
            top: 50%;
            transform: translateY(-50%);
            width: 4px;
            height: 4px;
            background: var(--primary);
            border-radius: 50%;
        }

        .notification-icon {
            width: 36px;
            height: 36px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            background: rgba(102, 126, 234, 0.1);
            border-radius: 8px;
            margin-right: 12px;
            vertical-align: middle;
        }

        .notification-icon.success {
            background: rgba(16, 185, 129, 0.1);
            color: var(--success);
        }

        .notification-icon.warning {
            background: rgba(245, 158, 11, 0.1);
            color: var(--warning);
        }

        .notification-icon.danger {
            background: rgba(239, 68, 68, 0.1);
            color: var(--danger);
        }

        .notification-content {
            display: inline-block;
            vertical-align: middle;
            flex: 1;
        }

        .notification-message {
            font-size: 14px;
            margin-bottom: 4px;
        }

        .notification-time {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .notification-empty {
            padding: 40px;
            text-align: center;
            color: var(--text-secondary);
        }

        .notification-empty i {
            font-size: 48px;
            opacity: 0.3;
            margin-bottom: 12px;
        }
    </style>
</head>
<body>
    <!-- Top Navigation Header -->
    <header class="top-nav">
        <div class="logo-section">
            <button class="mobile-menu-toggle" onclick="toggleMobileMenu()">
                <i class="fas fa-bars"></i>
            </button>
            <a href="#" class="logo" onclick="loadDashboard()">
                <div class="illuminati-eye">
                    <svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
                        <!-- Radiating rays -->
                        <g stroke="#FFD700" stroke-width="1.5" opacity="0.7">
                            <line x1="50" y1="5" x2="50" y2="0" stroke-linecap="round"/>
                            <line x1="30" y1="12" x2="25" y2="7" stroke-linecap="round"/>
                            <line x1="70" y1="12" x2="75" y2="7" stroke-linecap="round"/>
                            <line x1="18" y1="28" x2="11" y2="23" stroke-linecap="round"/>
                            <line x1="82" y1="28" x2="89" y2="23" stroke-linecap="round"/>
                            <line x1="15" y1="50" x2="8" y2="50" stroke-linecap="round"/>
                            <line x1="85" y1="50" x2="92" y2="50" stroke-linecap="round"/>
                            <line x1="25" y1="72" x2="18" y2="77" stroke-linecap="round"/>
                            <line x1="75" y1="72" x2="82" y2="77" stroke-linecap="round"/>
                        </g>
                        
                        <!-- Triangle/Pyramid -->
                        <polygon points="50,15 85,85 15,85" 
                                fill="none" 
                                stroke="#FFD700" 
                                stroke-width="2.5"/>
                        
                        <!-- Eye outer shape -->
                        <ellipse cx="50" cy="52" rx="22" ry="13" 
                                fill="none" 
                                stroke="#FFD700" 
                                stroke-width="2"/>
                        
                        <!-- Eye inner -->
                        <ellipse cx="50" cy="52" rx="22" ry="13" 
                                fill="rgba(255, 215, 0, 0.1)"/>
                        
                        <!-- Iris -->
                        <circle cx="50" cy="52" r="10" 
                               fill="#667eea" 
                               stroke="#FFD700" 
                               stroke-width="1"/>
                        
                        <!-- Pupil -->
                        <circle cx="50" cy="52" r="5" 
                               fill="#0a0e27"
                               style="animation: eyeBlink 10s ease-in-out infinite;"/>
                        
                        <!-- Light reflection -->
                        <circle cx="52" cy="50" r="2" 
                               fill="rgba(255, 255, 255, 0.8)"/>
                    </svg>
                </div>
                <span>AlphaOne</span>
            </a>
        </div>
        
        <nav class="nav-menu" id="navMenu">
            <!-- Trading Dropdown -->
            <div class="nav-dropdown">
                <button class="nav-dropdown-trigger">
                    <span>Trading</span>
                    <i class="fas fa-chevron-down"></i>
                </button>
                <div class="dropdown-menu">
                    <a class="dropdown-item" data-page="live_trading_pro_complete.html" data-title="Live Trading Pro" onclick="loadPage(this)">
                        <i class="fas fa-play-circle"></i>
                        <span>Live Trading Pro</span>
                    </a>
                    <a class="dropdown-item" data-page="tradingview_pro.html" data-title="TradingView Pro" onclick="loadPage(this)">
                        <i class="fas fa-chart-line"></i>
                        <span>TradingView Pro</span>
                    </a>
                    <a class="dropdown-item" data-page="tradingview_monitor.html" data-title="Live Monitor" onclick="loadPage(this)">
                        <i class="fas fa-desktop"></i>
                        <span>Live Monitor</span>
                    </a>
                    <a class="dropdown-item" data-page="paper_trading.html" data-title="Paper Trading" onclick="loadPage(this)">
                        <i class="fas fa-flask"></i>
                        <span>Paper Trading</span>
                    </a>
                    <a class="dropdown-item" data-page="positions.html" data-title="Positions" onclick="loadPage(this)">
                        <i class="fas fa-wallet"></i>
                        <span>Positions</span>
                    </a>
                    <a class="dropdown-item" data-page="option_chain.html" data-title="Option Chain" onclick="loadPage(this)">
                        <i class="fas fa-th"></i>
                        <span>Option Chain</span>
                    </a>
                    <a class="dropdown-item" data-page="backtest.html" data-title="Backtesting" onclick="loadPage(this)">
                        <i class="fas fa-history"></i>
                        <span>Backtesting</span>
                    </a>
                    <a class="dropdown-item" data-page="signals.html" data-title="Signals" onclick="loadPage(this)">
                        <i class="fas fa-signal"></i>
                        <span>Signals</span>
                    </a>
                </div>
            </div>
            
            <!-- Analytics Dropdown -->
            <div class="nav-dropdown analytics">
                <button class="nav-dropdown-trigger">
                    <span>Analytics</span>
                    <i class="fas fa-chevron-down"></i>
                </button>
                <div class="dropdown-menu">
                    <a class="dropdown-item" data-page="trade_journal_dashboard.html" data-title="Trade Journey" onclick="loadPage(this)">
                        <i class="fas fa-route"></i>
                        <span>Trade Journey</span>
                    </a>
                    <a class="dropdown-item" data-page="ml_validation_form.html" data-title="ML Validation" onclick="loadPage(this)">
                        <i class="fas fa-check-circle"></i>
                        <span>ML Validation</span>
                    </a>
                    <a class="dropdown-item" data-page="ml_analysis.html" data-title="ML Analysis" onclick="loadPage(this)">
                        <i class="fas fa-brain"></i>
                        <span>ML Analysis</span>
                    </a>
                    <a class="dropdown-item" data-page="ml_optimization.html" data-title="ML Optimization" onclick="loadPage(this)">
                        <i class="fas fa-chart-area"></i>
                        <span>ML Optimization</span>
                    </a>
                    <div class="dropdown-divider"></div>
                    <a class="dropdown-item" data-page="expiry_comparison.html" data-title="Expiry Comparison" onclick="loadPage(this)">
                        <i class="fas fa-calendar-check"></i>
                        <span>Expiry Comparison</span>
                    </a>
                    <a class="dropdown-item" data-page="performance_dashboard.html" data-title="Performance Dashboard" onclick="loadPage(this)">
                        <i class="fas fa-chart-line"></i>
                        <span>Performance Dashboard</span>
                    </a>
                    <a class="dropdown-item" data-page="risk_dashboard.html" data-title="Risk Management" onclick="loadPage(this)">
                        <i class="fas fa-shield-alt"></i>
                        <span>Risk Management</span>
                    </a>
                </div>
            </div>
            
            <!-- System Dropdown -->
            <div class="nav-dropdown">
                <button class="nav-dropdown-trigger">
                    <span>System</span>
                    <i class="fas fa-chevron-down"></i>
                </button>
                <div class="dropdown-menu">
                    <a class="dropdown-item" data-page="integrated_trading_dashboard.html" data-title="Trading Engine" onclick="loadPage(this)">
                        <i class="fas fa-cogs"></i>
                        <span>Trading Engine</span>
                    </a>
                    <a class="dropdown-item" data-page="monitoring_dashboard.html" data-title="System Monitoring" onclick="loadPage(this)">
                        <i class="fas fa-heartbeat"></i>
                        <span>System Monitoring</span>
                    </a>
                    <a class="dropdown-item" data-page="test_websocket.html" data-title="WebSocket Dashboard" onclick="loadPage(this)">
                        <i class="fas fa-plug"></i>
                        <span>WebSocket Dashboard</span>
                    </a>
                    <a class="dropdown-item" data-page="trade_journal_dashboard.html" data-title="Trade Journal" onclick="loadPage(this)">
                        <i class="fas fa-book"></i>
                        <span>Trade Journal</span>
                    </a>
                </div>
            </div>
            
            <!-- Data Dropdown -->
            <div class="nav-dropdown">
                <button class="nav-dropdown-trigger">
                    <span>Data</span>
                    <i class="fas fa-chevron-down"></i>
                </button>
                <div class="dropdown-menu">
                    <a class="dropdown-item" data-page="data_collection.html" data-title="Data Collection" onclick="loadPage(this)">
                        <i class="fas fa-download"></i>
                        <span>Data Collection</span>
                    </a>
                    <a class="dropdown-item" data-page="data_management.html" data-title="Data Management" onclick="loadPage(this)">
                        <i class="fas fa-database"></i>
                        <span>Data Management</span>
                    </a>
                    <a class="dropdown-item" data-page="holidays.html" data-title="Market Holidays" onclick="loadPage(this)">
                        <i class="fas fa-calendar"></i>
                        <span>Market Holidays</span>
                    </a>
                    <a class="dropdown-item" data-page="margin_calculator.html" data-title="Margin Calculator" onclick="loadPage(this)">
                        <i class="fas fa-calculator"></i>
                        <span>Margin Calculator</span>
                    </a>
                </div>
            </div>
            
            <!-- Auth Dropdown -->
            <div class="nav-dropdown">
                <button class="nav-dropdown-trigger">
                    <span>Auth</span>
                    <i class="fas fa-chevron-down"></i>
                </button>
                <div class="dropdown-menu">
                    <a class="dropdown-item" data-page="auto_login_dashboard.html" data-title="Auto Login" onclick="loadPage(this)">
                        <i class="fas fa-robot"></i>
                        <span>Auto Login</span>
                    </a>
                    <a class="dropdown-item" data-page="scheduler_dashboard.html" data-title="Scheduler" onclick="loadPage(this)">
                        <i class="fas fa-clock"></i>
                        <span>Scheduler</span>
                    </a>
                </div>
            </div>
            
            <!-- Settings -->
            <div class="nav-dropdown">
                <button class="nav-dropdown-trigger" onclick="loadPageDirect('settings.html', 'Settings')">
                    <span>Settings</span>
                </button>
            </div>
        </nav>
        
        <!-- Header Actions (Right Side) -->
        <div class="header-actions">
            <div class="search-box">
                <input type="text" placeholder="Search..." id="globalSearch">
                <i class="fas fa-search"></i>
                <div class="search-dropdown" id="searchDropdown"></div>
            </div>
            
            <button class="btn-icon" title="Notification Settings" onclick="toggleNotificationSettings()" id="notificationSettingsBtn">
                <i class="fas fa-cog"></i>
            </button>
            
            <div style="position: relative;">
                <button class="btn-icon notification-badge" title="Notifications" onclick="toggleNotifications()" id="notificationBtn">
                    <i class="fas fa-bell"></i>
                </button>
                <div class="notification-panel" id="notificationPanel">
                    <div class="notification-header">
                        <span class="notification-title">Notifications</span>
                        <div class="notification-actions">
                            <button class="notification-action" onclick="markAllAsRead()">
                                <i class="fas fa-check"></i> Mark all read
                            </button>
                            <button class="notification-action" onclick="clearNotifications()">
                                <i class="fas fa-trash"></i> Clear
                            </button>
                        </div>
                    </div>
                    <div class="notification-list" id="notificationList">
                        <div class="notification-empty">
                            <i class="fas fa-bell-slash"></i>
                            <p>No notifications yet</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Authentication Status (moved to top-right corner) -->
            <div id="auth-status" style="display: inline-flex; align-items: center; gap: 10px; margin: 0 15px;">
                <!-- Auth status will be injected here -->
            </div>
            
            <button class="btn-icon" onclick="toggleFullScreen()" title="Fullscreen">
                <i class="fas fa-expand"></i>
            </button>
            
            <button class="btn-icon" onclick="refreshCurrentPage()" title="Refresh">
                <i class="fas fa-sync-alt"></i>
            </button>
        </div>
    </header>
    
    <!-- Notification Settings Modal -->
    <div id="notificationSettingsModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.7); z-index: 10000; align-items: center; justify-content: center;">
        <div style="background: var(--bg-secondary); border-radius: 12px; padding: 30px; max-width: 500px; width: 90%; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5); border: 1px solid var(--border);">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
                <h2 style="color: var(--text-primary); font-size: 24px; margin: 0;">
                    <i class="fas fa-bell" style="color: var(--primary); margin-right: 10px;"></i>
                    Notification Settings
                </h2>
                <button onclick="closeNotificationSettings()" style="background: transparent; border: none; color: var(--text-secondary); font-size: 24px; cursor: pointer;">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div style="background: var(--bg-hover); border-radius: 8px; padding: 20px; margin-bottom: 20px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <div>
                        <h3 style="color: var(--text-primary); font-size: 16px; margin: 0 0 5px 0;">Browser Notifications</h3>
                        <p style="color: var(--text-secondary); font-size: 14px; margin: 0;">Receive alerts for trades, signals, and system events</p>
                    </div>
                    <label class="notification-toggle-switch" style="position: relative; display: inline-block; width: 60px; height: 28px;">
                        <input type="checkbox" id="notificationToggle" onchange="toggleNotificationPermission()" style="opacity: 0; width: 0; height: 0;">
                        <span class="notification-slider" style="position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: 0.4s; border-radius: 28px;">
                            <span style="position: absolute; content: ''; height: 20px; width: 20px; left: 4px; bottom: 4px; background-color: white; transition: 0.4s; border-radius: 50%;"></span>
                        </span>
                    </label>
                </div>
                
                <div id="notificationStatus" style="padding: 10px; background: rgba(0, 0, 0, 0.2); border-radius: 6px; margin-top: 15px;">
                    <p style="color: var(--text-secondary); font-size: 13px; margin: 0;">
                        <i class="fas fa-info-circle" style="margin-right: 8px;"></i>
                        <span id="notificationStatusText">Checking notification status...</span>
                    </p>
                </div>
            </div>
            
            <div style="background: rgba(102, 126, 234, 0.1); border: 1px solid rgba(102, 126, 234, 0.3); border-radius: 8px; padding: 15px;">
                <p style="color: var(--text-primary); font-size: 13px; margin: 0;">
                    <i class="fas fa-lightbulb" style="color: var(--warning); margin-right: 8px;"></i>
                    <strong>Tip:</strong> Enable notifications to receive real-time alerts for:
                </p>
                <ul style="color: var(--text-secondary); font-size: 13px; margin: 10px 0 0 25px; padding: 0;">
                    <li>Trade executions and signals</li>
                    <li>Market status changes</li>
                    <li>System alerts and errors</li>
                    <li>Position updates and P&L changes</li>
                </ul>
            </div>
        </div>
    </div>

    <style>
        .notification-toggle-switch input:checked + .notification-slider {
            background-color: var(--success);
        }
        
        .notification-toggle-switch input:checked + .notification-slider span {
            transform: translateX(32px);
        }
        
        .notification-toggle-switch .notification-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: 0.4s;
            border-radius: 28px;
        }
        
        .notification-toggle-switch .notification-slider span {
            position: absolute;
            height: 20px;
            width: 20px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: 0.4s;
            border-radius: 50%;
        }
    </style>
    
    <!-- Broker Connection Status Bar -->
    <div class="broker-status-bar" id="brokerStatusBar">
        <div class="status-container">
            <!-- Zerodha Status -->
            <div class="broker-indicator">
                <div class="indicator-dot" id="zerodhaIndicator"></div>
                <span class="broker-name zerodha">ZERODHA</span>
                <span class="broker-text" id="zerodhaText">Checking...</span>
                <span class="latency-badge" id="zerodhaLatency" title="API Latency">
                    <i class="fas fa-signal"></i>
                    <span class="latency-value">--ms</span>
                </span>
                <button class="auto-login-btn" id="zerodhaLoginBtn" style="display:none;" onclick="loginZerodha()">
                    <i class="fas fa-sign-in-alt"></i> Login
                </button>
            </div>
            
            <!-- Breeze Status -->
            <div class="broker-indicator">
                <div class="indicator-dot" id="breezeIndicator"></div>
                <span class="broker-name breeze">BREEZE</span>
                <span class="broker-text" id="breezeText">Checking...</span>
                <span class="latency-badge" id="breezeLatency" title="API Latency">
                    <i class="fas fa-signal"></i>
                    <span class="latency-value">--ms</span>
                </span>
                <button class="auto-login-btn" id="breezeLoginBtn" style="display:none;" onclick="loginBreeze()">
                    <i class="fas fa-sign-in-alt"></i> Login
                </button>
            </div>
            
            <!-- Login Both Button (shows when both are disconnected) -->
            <button class="auto-login-btn login-both" id="loginBothBtn" style="display:none;" onclick="loginBoth()">
                <i class="fas fa-sign-in-alt"></i> Login Both
            </button>
            
            
            <!-- Performance Metrics -->
            <div class="performance-metrics">
                <span class="metric-item" title="API Requests per second">
                    <i class="fas fa-tachometer-alt"></i>
                    <span id="apiThroughput">--</span> req/s
                </span>
                <span class="metric-item" title="Average Response Time">
                    <i class="fas fa-hourglass-half"></i>
                    <span id="avgResponseTime">--</span>ms
                </span>
                <span class="metric-item" title="System Load">
                    <i class="fas fa-microchip"></i>
                    <span id="systemLoad">--</span>%
                </span>
                <span class="metric-item api-status" id="apiStatus" title="API Server Status">
                    <div class="api-indicator-dot" id="apiIndicator"></div>
                    <i class="fas fa-server"></i>
                    <span id="apiStatusText">API: Checking</span>
                </span>
            </div>
            
            <span class="divider">|</span>
            
            <!-- Market Status -->
            <div class="broker-details">
                <span class="market-status error" id="marketStatus">STATUS: N/A</span>
            </div>
        </div>
        
        <!-- Date and Time (Right Corner) -->
        <div class="datetime-container">
            <i class="fas fa-calendar-alt"></i>
            <span class="date" id="currentDate">----/--/--</span>
            <span class="divider">|</span>
            <i class="fas fa-clock"></i>
            <span class="time" id="brokerTime">--:--:--</span>
        </div>
    </div>
    
    <!-- Main Content Area -->
    <div class="main-content">
        <!-- Breadcrumb Bar -->
        <div class="breadcrumb-bar">
            <div class="breadcrumb" id="breadcrumb">
                <a href="#" onclick="loadDashboard()">Home</a>
                <span class="separator">/</span>
                <span id="currentPage">Dashboard</span>
            </div>
            <div class="page-actions" id="pageActions">
                <!-- Dynamic page actions will be added here -->
            </div>
        </div>
        
        <!-- Content Area -->
        <div class="content-area">
            <!-- Dashboard Content (Home Page) -->
            <div id="dashboard-content" class="active">
                <div class="welcome-header">
                    <h1 class="welcome-title">Welcome to AlphaOne Platform</h1>
                    <p class="welcome-subtitle">Your comprehensive trading and analytics dashboard</p>
                </div>
                
                <div class="dashboard-grid">
                    <div class="dashboard-card" onclick="loadPageDirect('live_trading_pro_complete.html', 'Live Trading Pro')">
                        <div class="card-header">
                            <div class="card-icon primary">
                                <i class="fas fa-play-circle"></i>
                            </div>
                            <h3 class="card-title">Live Trading</h3>
                        </div>
                        <div class="card-value">Active</div>
                        <p class="card-description">Real-time trading with advanced features</p>
                    </div>
                    
                    <div class="dashboard-card" onclick="loadPageDirect('tradingview_pro.html', 'TradingView Pro')">
                        <div class="card-header">
                            <div class="card-icon success">
                                <i class="fas fa-chart-line"></i>
                            </div>
                            <h3 class="card-title">TradingView Pro</h3>
                        </div>
                        <div class="card-value">Ready</div>
                        <p class="card-description">Alert-based automated trading</p>
                    </div>
                    
                    <div class="dashboard-card" onclick="loadPageDirect('backtest.html', 'Backtesting')">
                        <div class="card-header">
                            <div class="card-icon success">
                                <i class="fas fa-history"></i>
                            </div>
                            <h3 class="card-title">Backtesting</h3>
                        </div>
                        <div class="card-value">Ready</div>
                        <p class="card-description">Test your strategies with historical data</p>
                    </div>
                    
                    <div class="dashboard-card" onclick="loadPageDirect('ml_analysis.html', 'ML Analysis')">
                        <div class="card-header">
                            <div class="card-icon warning">
                                <i class="fas fa-brain"></i>
                            </div>
                            <h3 class="card-title">ML Analytics</h3>
                        </div>
                        <div class="card-value">3 Models</div>
                        <p class="card-description">Machine learning powered insights</p>
                    </div>
                    
                    <div class="dashboard-card" onclick="loadPageDirect('data_collection.html', 'Data Collection')">
                        <div class="card-header">
                            <div class="card-icon danger">
                                <i class="fas fa-database"></i>
                            </div>
                            <h3 class="card-title">Data Management</h3>
                        </div>
                        <div class="card-value">2.3 GB</div>
                        <p class="card-description">Collect and manage market data</p>
                    </div>
                </div>
            </div>
            
            <!-- Dynamic Page Content (iframe) -->
            <div class="iframe-container" id="pageContent" style="display: none;">
                <div class="loading-spinner"></div>
                <iframe id="contentFrame"></iframe>
            </div>
        </div>
    </div>
    
    <script>
        const API_BASE = window.location.protocol === 'file:' ? 'http://localhost:8000' : '';
        // State Management
        let currentPage = 'dashboard';
        let isMobileMenuOpen = false;

        // Search functionality
        const searchableItems = [
            // Pages
            { title: 'Live Trading Pro', description: 'Real-time trading interface', type: 'Page', icon: 'fa-play-circle', page: 'live_trading_pro_complete.html' },
            { title: 'Paper Trading', description: 'Practice trading without risk', type: 'Page', icon: 'fa-flask', page: 'paper_trading.html' },
            { title: 'Positions', description: 'View open positions', type: 'Page', icon: 'fa-wallet', page: 'positions.html' },
            { title: 'Option Chain', description: 'Options trading interface', type: 'Page', icon: 'fa-th', page: 'option_chain.html' },
            { title: 'Backtesting', description: 'Test strategies with historical data', type: 'Page', icon: 'fa-history', page: 'backtest.html' },
            { title: 'Signals', description: 'Trading signal alerts', type: 'Page', icon: 'fa-signal', page: 'signals.html' },
            { title: 'ML Analysis', description: 'Machine learning analytics', type: 'Page', icon: 'fa-brain', page: 'ml_analysis.html' },
            { title: 'Data Collection', description: 'Collect market data', type: 'Page', icon: 'fa-download', page: 'data_collection.html' },
            { title: 'Settings', description: 'Application settings', type: 'Page', icon: 'fa-cog', page: 'settings.html' },
            // Symbols
            { title: 'NIFTY', description: 'NIFTY 50 Index', type: 'Symbol', icon: 'fa-chart-line' },
            { title: 'BANKNIFTY', description: 'Bank NIFTY Index', type: 'Symbol', icon: 'fa-university' },
            { title: 'FINNIFTY', description: 'Financial Services Index', type: 'Symbol', icon: 'fa-coins' },
            // Actions
            { title: 'Start Auto Login', description: 'Login to all brokers', type: 'Action', icon: 'fa-sign-in-alt', action: 'loginBoth' },
            { title: 'Refresh Data', description: 'Refresh current page', type: 'Action', icon: 'fa-sync-alt', action: 'refreshCurrentPage' },
            { title: 'Toggle Fullscreen', description: 'Enter/exit fullscreen', type: 'Action', icon: 'fa-expand', action: 'toggleFullScreen' }
        ];

        let searchSelectedIndex = -1;
        let searchResults = [];

        function fuzzySearch(query, items) {
            if (!query) return [];
            query = query.toLowerCase();
            return items
                .map(item => {
                    const title = item.title.toLowerCase();
                    const desc = item.description.toLowerCase();
                    let score = 0;
                    if (title.includes(query)) score += 10;
                    if (title.startsWith(query)) score += 5;
                    if (desc.includes(query)) score += 3;
                    const words = query.split(' ');
                    words.forEach(word => {
                        if (title.includes(word)) score += 2;
                        if (desc.includes(word)) score += 1;
                    });
                    return { ...item, score };
                })
                .filter(item => item.score > 0)
                .sort((a, b) => b.score - a.score)
                .slice(0, 8);
        }

        function renderSearchResults(results) {
            const dropdown = document.getElementById('searchDropdown');
            if (results.length === 0) {
                dropdown.innerHTML = '<div class="search-no-results">No results found</div>';
            } else {
                dropdown.innerHTML = results.map((item, index) => `
                    <div class="search-result ${index === searchSelectedIndex ? 'selected' : ''}" 
                         data-index="${index}"
                         onclick="selectSearchResult(${index})">
                        <div class="search-result-icon">
                            <i class="fas ${item.icon || 'fa-file'}"></i>
                        </div>
                        <div class="search-result-content">
                            <div class="search-result-title">${item.title}</div>
                            <div class="search-result-description">${item.description}</div>
                        </div>
                        <div class="search-result-type">${item.type}</div>
                    </div>
                `).join('');
            }
            dropdown.classList.add('active');
        }

        function selectSearchResult(index) {
            const result = searchResults[index];
            if (!result) return;

            // Perform action
            if (result.page) {
                loadPageDirect(result.page, result.title);
            } else if (result.action) {
                window[result.action]();
            } else if (result.type === 'Symbol') {
                // Open option chain with symbol
                loadPageDirect('option_chain.html', 'Option Chain');
                setTimeout(() => {
                    const iframe = document.getElementById('contentFrame');
                    if (iframe && iframe.contentWindow) {
                        iframe.contentWindow.postMessage({ type: 'setSymbol', symbol: result.title }, '*');
                    }
                }, 1000);
            }

            // Clear search
            document.getElementById('globalSearch').value = '';
            document.getElementById('searchDropdown').classList.remove('active');
        }

        // Notification System
        class NotificationCenter {
            constructor() {
                // Load notifications from localStorage but filter out old/dummy ones
                const storedNotifications = JSON.parse(localStorage.getItem('notifications') || '[]');
                
                // Filter out dummy/test notifications and keep only recent real ones
                this.notifications = storedNotifications.filter(n => {
                    // Remove notifications with dummy/test keywords
                    const isDummy = n.message && (
                        n.message.includes('Test') ||
                        n.message.includes('test') ||
                        n.message.includes('Sample') ||
                        n.message.includes('sample') ||
                        n.message.includes('Demo') ||
                        n.message.includes('demo')
                    );
                    
                    // Keep only notifications from last 24 hours
                    const isRecent = n.timestamp && 
                        (new Date() - new Date(n.timestamp)) < 24 * 60 * 60 * 1000;
                    
                    return !isDummy && isRecent;
                });
                
                this.unreadCount = 0;
                this.init();
            }

            init() {
                // Clear any existing dummy notifications on init
                this.clearDummyNotifications();
                this.updateUI();
                this.startPolling();
                this.setupWebSocket();
            }

            add(notification) {
                notification.id = Date.now();
                notification.timestamp = new Date().toISOString();
                notification.unread = true;
                this.notifications.unshift(notification);
                this.notifications = this.notifications.slice(0, 50);
                this.save();
                this.updateUI();
                this.showBrowserNotification(notification);
            }

            markAsRead(id) {
                const notification = this.notifications.find(n => n.id === id);
                if (notification) {
                    notification.unread = false;
                    this.save();
                    this.updateUI();
                }
            }

            markAllAsRead() {
                this.notifications.forEach(n => n.unread = false);
                this.save();
                this.updateUI();
            }

            clear() {
                this.notifications = [];
                this.save();
                this.updateUI();
            }
            
            clearDummyNotifications() {
                // Remove all dummy/test notifications
                this.notifications = this.notifications.filter(n => {
                    const isDummy = n.message && (
                        n.message.toLowerCase().includes('test') ||
                        n.message.toLowerCase().includes('sample') ||
                        n.message.toLowerCase().includes('demo') ||
                        n.message.toLowerCase().includes('dummy')
                    );
                    return !isDummy;
                });
                this.save();
                this.updateUI();
            }

            save() {
                localStorage.setItem('notifications', JSON.stringify(this.notifications));
            }

            updateUI() {
                const list = document.getElementById('notificationList');
                const badge = document.querySelector('.notification-badge');
                
                this.unreadCount = this.notifications.filter(n => n.unread).length;
                
                // Update badge
                if (this.unreadCount > 0) {
                    badge.classList.add('has-notifications');
                    if (!badge.querySelector('.badge-count')) {
                        const count = document.createElement('span');
                        count.className = 'badge-count';
                        count.style.cssText = 'position:absolute;top:-4px;right:-4px;background:#ef4444;color:white;border-radius:10px;padding:2px 6px;font-size:10px;';
                        badge.appendChild(count);
                    }
                    badge.querySelector('.badge-count').textContent = this.unreadCount;
                } else {
                    badge.classList.remove('has-notifications');
                    const count = badge.querySelector('.badge-count');
                    if (count) count.remove();
                }

                // Update list
                if (this.notifications.length === 0) {
                    list.innerHTML = `
                        <div class="notification-empty">
                            <i class="fas fa-bell-slash"></i>
                            <p>No notifications yet</p>
                        </div>
                    `;
                } else {
                    list.innerHTML = this.notifications.map(n => `
                        <div class="notification-item ${n.unread ? 'unread' : ''}" onclick="notificationCenter.handleClick(${n.id})">
                            <span class="notification-icon ${n.type || 'info'}">
                                <i class="fas ${this.getIcon(n.type)}"></i>
                            </span>
                            <span class="notification-content">
                                <div class="notification-message">${n.message}</div>
                                <div class="notification-time">${this.formatTime(n.timestamp)}</div>
                            </span>
                        </div>
                    `).join('');
                }
            }

            getIcon(type) {
                const icons = {
                    'success': 'fa-check-circle',
                    'warning': 'fa-exclamation-triangle',
                    'danger': 'fa-times-circle',
                    'info': 'fa-info-circle',
                    'trade': 'fa-exchange-alt',
                    'order': 'fa-shopping-cart',
                    'signal': 'fa-signal'
                };
                return icons[type] || 'fa-bell';
            }

            formatTime(timestamp) {
                const date = new Date(timestamp);
                const now = new Date();
                const diff = Math.floor((now - date) / 1000);
                
                if (diff < 60) return 'Just now';
                if (diff < 3600) return `${Math.floor(diff / 60)} min ago`;
                if (diff < 86400) return `${Math.floor(diff / 3600)} hours ago`;
                return date.toLocaleDateString();
            }

            handleClick(id) {
                this.markAsRead(id);
                const notification = this.notifications.find(n => n.id === id);
                if (notification && notification.link) {
                    loadPageDirect(notification.link, notification.linkTitle || 'Page');
                    toggleNotifications();
                }
            }

            showBrowserNotification(notification) {
                if ('Notification' in window && Notification.permission === 'granted') {
                    new Notification('AlphaOne Platform', {
                        body: notification.message,
                        icon: '/favicon.ico',
                        badge: '/favicon.ico'
                    });
                }
            }

            startPolling() {
                // Disabled polling for now as endpoint doesn't exist
                // Real notifications come from monitoring functions
                // This prevents unnecessary API calls to non-existent endpoint
                
                // Clean up any dummy notifications periodically
                setInterval(() => {
                    this.clearDummyNotifications();
                }, 60000); // Clean up every minute
            }

            setupWebSocket() {
                // WebSocket disabled - not implemented yet
                // Will use polling only for notifications
            }
        }

        let notificationCenter;

        function toggleNotifications() {
            const panel = document.getElementById('notificationPanel');
            panel.classList.toggle('active');
        }

        function markAllAsRead() {
            notificationCenter.markAllAsRead();
        }

        function clearNotifications() {
            notificationCenter.clear();
        }
        
        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            // Check if there's a saved page state
            const savedPage = localStorage.getItem('currentPage');
            const savedTitle = localStorage.getItem('currentPageTitle');
            
            if (savedPage && savedTitle) {
                // Restore the previous page
                loadPageDirect(savedPage, savedTitle);
            } else {
                // Set initial state to dashboard
                updateBreadcrumb('Dashboard');
            }
            
            // Initialize broker status bar
            updateBrokerStatus();
            updateBrokerTime();
            setInterval(updateBrokerTime, 1000); // Update time every second
            checkBrokerConnection();
            setInterval(checkBrokerConnection, 10000); // Check connection every 10 seconds
            
            // Initialize Zerodha and Breeze status checks
            // Add small delay to ensure DOM is fully loaded and force fresh check
            setTimeout(() => {
                // Clear any cached status first
                const zerodhaText = document.getElementById('zerodhaText');
                const breezeText = document.getElementById('breezeText');
                if (zerodhaText) zerodhaText.textContent = 'Checking...';
                if (breezeText) breezeText.textContent = 'Checking...';
                
                // Force fresh status check with random parameter to bypass any proxy cache
                const bustCache = Date.now() + Math.random();
                window.checkZerodhaConnectionWithCache = () => checkZerodhaConnection(bustCache);
                window.checkBreezeConnectionWithCache = () => checkBreezeConnection(bustCache);
                
                checkZerodhaConnection();
                checkBreezeConnection();
            }, 100);
            
            // Refresh status checks every 15 seconds
            setInterval(() => {
                checkZerodhaConnection();
                checkBreezeConnection();
            }, 15000);
            
            // Initialize performance monitoring
            initPerformanceMonitoring();
            setInterval(updatePerformanceMetrics, 5000); // Update metrics every 5 seconds
            
            // Initialize API status monitoring
            checkAPIStatus(); // Check immediately
            setInterval(checkAPIStatus, 10000); // Check every 10 seconds
            
            // Handle dropdown clicks for mobile
            if (window.innerWidth <= 768) {
                setupMobileDropdowns();
            }
            
            // Initialize notification center
            notificationCenter = new NotificationCenter();
            
            // FORCE CLEAR ALL NOTIFICATIONS - Remove any dummy/test data
            // This ensures we only show real notifications from actual trading events
            setTimeout(() => {
                // Clear localStorage completely
                localStorage.removeItem('notifications');
                localStorage.removeItem('notificationCount');
                
                // Clear notification center
                notificationCenter.notifications = [];
                notificationCenter.unreadCount = 0;
                notificationCenter.save();
                notificationCenter.updateUI();
                
                // Update UI to show empty state
                const notificationList = document.getElementById('notificationList');
                if (notificationList) {
                    notificationList.innerHTML = `
                        <div class="notification-empty">
                            <i class="fas fa-bell-slash"></i>
                            <p>No notifications yet</p>
                            <small>Real trading events will appear here</small>
                        </div>
                    `;
                }
                
                console.log(' Cleared all notifications - only real trading events will be shown');
                
                // Add global function to manually clear all notifications from console
                window.clearAllNotifications = () => {
                    localStorage.clear();
                    notificationCenter.notifications = [];
                    notificationCenter.save();
                    notificationCenter.updateUI();
                    console.log('All notifications and localStorage cleared!');
                    return 'Cleared successfully';
                };
                console.log('To manually clear all notifications, run: clearAllNotifications()');
            }, 100);

            // Check if user has enabled notifications in settings
            const notificationsEnabled = localStorage.getItem('notificationsEnabled') === 'true';
            
            // Only request permission if user has explicitly enabled notifications
            if (notificationsEnabled && 'Notification' in window && Notification.permission === 'default') {
                Notification.requestPermission();
            }
            
            // Initialize notification settings UI
            initializeNotificationSettings();

            // Initialize real-time notification monitoring
            initializeRealTimeNotifications();

            // Setup search input
            document.getElementById('globalSearch').addEventListener('input', function(e) {
                handleSearch(e.target.value);
            });

            document.getElementById('globalSearch').addEventListener('keydown', function(e) {
                const dropdown = document.getElementById('searchDropdown');
                if (!dropdown.classList.contains('active')) return;

                if (e.key === 'ArrowDown') {
                    e.preventDefault();
                    searchSelectedIndex = Math.min(searchSelectedIndex + 1, searchResults.length - 1);
                    renderSearchResults(searchResults);
                } else if (e.key === 'ArrowUp') {
                    e.preventDefault();
                    searchSelectedIndex = Math.max(searchSelectedIndex - 1, -1);
                    renderSearchResults(searchResults);
                } else if (e.key === 'Enter') {
                    e.preventDefault();
                    if (searchSelectedIndex >= 0) {
                        selectSearchResult(searchSelectedIndex);
                    }
                } else if (e.key === 'Escape') {
                    e.preventDefault();
                    dropdown.classList.remove('active');
                    this.blur();
                }
            });

            // Close search on click outside
            document.addEventListener('click', function(e) {
                if (!e.target.closest('.search-box')) {
                    document.getElementById('searchDropdown').classList.remove('active');
                }
            });

            // Close notification panel on click outside
            document.addEventListener('click', function(e) {
                if (!e.target.closest('#notificationBtn') && !e.target.closest('#notificationPanel')) {
                    document.getElementById('notificationPanel').classList.remove('active');
                }
            });
        });
        
        // Page Loading
        window.loadPage = function(element) {
            const page = element.dataset.page;
            const title = element.dataset.title;
            
            // Update active states
            document.querySelectorAll('.dropdown-item').forEach(item => {
                item.classList.remove('active');
            });
            element.classList.add('active');
            
            // Update parent dropdown
            const parentDropdown = element.closest('.nav-dropdown');
            document.querySelectorAll('.nav-dropdown-trigger').forEach(trigger => {
                trigger.classList.remove('active');
            });
            if (parentDropdown) {
                parentDropdown.querySelector('.nav-dropdown-trigger').classList.add('active');
            }
            
            // Load page
            loadPageContent(page, title);
            
            // Close mobile menu if open
            if (isMobileMenuOpen) {
                toggleMobileMenu();
            }
        }
        
        window.loadPageDirect = function(page, title) {
            // Clear dropdown active states
            document.querySelectorAll('.dropdown-item').forEach(item => {
                item.classList.remove('active');
            });
            
            // Find and activate the correct menu item
            const menuItem = document.querySelector(`[data-page="${page}"]`);
            if (menuItem) {
                menuItem.classList.add('active');
                const parentDropdown = menuItem.closest('.nav-dropdown');
                if (parentDropdown) {
                    document.querySelectorAll('.nav-dropdown-trigger').forEach(trigger => {
                        trigger.classList.remove('active');
                    });
                    parentDropdown.querySelector('.nav-dropdown-trigger').classList.add('active');
                }
            }
            
            loadPageContent(page, title);
        }
        
        window.loadPageContent = function(page, title) {
            currentPage = page;
            
            // Save current page to localStorage
            localStorage.setItem('currentPage', page);
            localStorage.setItem('currentPageTitle', title);
            
            // Hide dashboard, show iframe
            document.getElementById('dashboard-content').classList.remove('active');
            document.getElementById('pageContent').style.display = 'block';
            
            // Update breadcrumb
            updateBreadcrumb(title);
            
            // Load content
            const iframe = document.getElementById('contentFrame');
            iframe.src = page;
            
            // Handle iframe load
            iframe.onload = function() {
                document.querySelector('.loading-spinner').style.display = 'none';
            };
            
            // Show spinner
            document.querySelector('.loading-spinner').style.display = 'block';
        }
        
        window.loadDashboard = function() {
            currentPage = 'dashboard';
            
            // Clear saved page state
            localStorage.removeItem('currentPage');
            localStorage.removeItem('currentPageTitle');
            
            // Clear active states
            document.querySelectorAll('.dropdown-item, .nav-dropdown-trigger').forEach(item => {
                item.classList.remove('active');
            });
            
            // Show dashboard, hide iframe
            document.getElementById('dashboard-content').classList.add('active');
            document.getElementById('pageContent').style.display = 'none';
            
            // Update breadcrumb
            updateBreadcrumb('Dashboard');
        }
        
        // Breadcrumb Management
        function updateBreadcrumb(pageName) {
            document.getElementById('currentPage').textContent = pageName;
            
            // Update page title
            document.title = `${pageName} - AlphaOne Platform`;
        }
        
        // Mobile Menu
        window.toggleMobileMenu = function() {
            const navMenu = document.getElementById('navMenu');
            isMobileMenuOpen = !isMobileMenuOpen;
            
            if (isMobileMenuOpen) {
                navMenu.classList.add('active');
            } else {
                navMenu.classList.remove('active');
            }
        }
        
        function setupMobileDropdowns() {
            document.querySelectorAll('.nav-dropdown-trigger').forEach(trigger => {
                trigger.addEventListener('click', function(e) {
                    if (window.innerWidth <= 768) {
                        e.preventDefault();
                        const dropdown = this.closest('.nav-dropdown');
                        dropdown.classList.toggle('active');
                    }
                });
            });
        }
        
        // Utility Functions
        function refreshCurrentPage() {
            if (currentPage === 'dashboard') {
                location.reload();
            } else {
                const iframe = document.getElementById('contentFrame');
                iframe.src = iframe.src;
            }
        }
        
        function toggleFullScreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen();
            } else {
                document.exitFullscreen();
            }
        }
        
        function handleSearch(query) {
            if (!query) {
                document.getElementById('searchDropdown').classList.remove('active');
                return;
            }
            searchResults = fuzzySearch(query, searchableItems);
            searchSelectedIndex = -1;
            renderSearchResults(searchResults);
        }
        
        // Handle window resize
        window.addEventListener('resize', function() {
            if (window.innerWidth > 768 && isMobileMenuOpen) {
                toggleMobileMenu();
            }
        });
        
        // Keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            // Alt + H = Home
            if (e.altKey && e.key === 'h') {
                e.preventDefault();
                loadDashboard();
            }
            // Alt + S = Search focus
            if (e.altKey && e.key === 's') {
                e.preventDefault();
                document.getElementById('globalSearch').focus();
            }
            // F5 = Refresh current page
            if (e.key === 'F5') {
                e.preventDefault();
                refreshCurrentPage();
            }
        });

        // Broker Status Functions
        async function updateBrokerTime() {
            try {
                // Fetch internet time from API
                const response = await fetch(`${API_BASE}/time/internet`, {
                    method: 'GET',
                    cache: 'no-cache'
                });
                
                if (response.ok) {
                    const data = await response.json();
                    
                    // Update time
                    const brokerTimeEl = document.getElementById('brokerTime');
                    if (brokerTimeEl) {
                        brokerTimeEl.textContent = data.time;
                    }
                    
                    // Update date
                    const currentDateEl = document.getElementById('currentDate');
                    if (currentDateEl) {
                        currentDateEl.textContent = data.date;
                    }
                    
                    // Update market status
                    const marketStatusEl = document.getElementById('marketStatus');
                    if (marketStatusEl) {
                        if (data.is_market_hours) {
                            marketStatusEl.textContent = 'MARKET OPEN';
                            marketStatusEl.classList.add('open');
                            marketStatusEl.classList.remove('error');
                        } else {
                            marketStatusEl.textContent = 'MARKET CLOSED';
                            marketStatusEl.classList.remove('open', 'error');
                        }
                    }
                } else {
                    // Fallback to system time if API fails
                    updateBrokerTimeLocal();
                    // Show N/A for market status when API not available
                    const marketStatusEl = document.getElementById('marketStatus');
                    if (marketStatusEl) {
                        marketStatusEl.textContent = 'STATUS: N/A';
                        marketStatusEl.classList.add('error');
                        marketStatusEl.classList.remove('open');
                    }
                }
            } catch (error) {
                console.log('Failed to fetch internet time, using local time:', error);
                // Fallback to system time
                updateBrokerTimeLocal();
            }
        }
        
        // Fallback function using local system time
        function updateBrokerTimeLocal() {
            const now = new Date();
            
            // Format time
            const timeString = now.toLocaleTimeString('en-IN', { 
                hour12: false,
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
            
            // Format date as YYYY-MM-DD
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const dateString = `${year}-${month}-${day}`;
            
            // Update time
            const brokerTimeEl = document.getElementById('brokerTime');
            if (brokerTimeEl) {
                brokerTimeEl.textContent = timeString;
            }
            
            // Update date
            const currentDateEl = document.getElementById('currentDate');
            if (currentDateEl) {
                currentDateEl.textContent = dateString;
            }
            
            // Calculate market status based on current IST time
            const marketStatusEl = document.getElementById('marketStatus');
            if (marketStatusEl) {
                // Get IST time
                const istTime = new Date(now.toLocaleString("en-US", {timeZone: "Asia/Kolkata"}));
                const hour = istTime.getHours();
                const minute = istTime.getMinutes();
                const dayOfWeek = istTime.getDay(); // 0=Sunday, 6=Saturday
                
                // Market hours: 9:15 AM to 3:30 PM IST, Monday-Friday
                const isWeekday = dayOfWeek >= 1 && dayOfWeek <= 5;
                const currentTimeMinutes = hour * 60 + minute;
                const marketOpenTime = 9 * 60 + 15; // 9:15 in minutes
                const marketCloseTime = 15 * 60 + 30; // 15:30 in minutes
                
                if (!isWeekday) {
                    marketStatusEl.textContent = 'WEEKEND';
                    marketStatusEl.classList.remove('open');
                    marketStatusEl.classList.add('error');
                } else if (currentTimeMinutes >= marketOpenTime && currentTimeMinutes <= marketCloseTime) {
                    marketStatusEl.textContent = 'MARKET OPEN';
                    marketStatusEl.classList.add('open');
                    marketStatusEl.classList.remove('error');
                } else if (currentTimeMinutes < marketOpenTime) {
                    marketStatusEl.textContent = 'PRE-MARKET';
                    marketStatusEl.classList.remove('open', 'error');
                } else {
                    marketStatusEl.textContent = 'MARKET CLOSED';
                    marketStatusEl.classList.remove('open', 'error');
                }
            }
        }

        async function checkBrokerConnection() {
            // Use unified status check for better performance and consistency
            checkUnifiedStatus();
        }
        
        async function checkUnifiedStatus() {
            try {
                // Single API call for all status information
                const response = await fetch(`${API_BASE}/status/all`, {
                    method: 'GET',
                    cache: 'no-cache'
                });
                
                if (response.ok) {
                    const data = await response.json();
                    
                    // Update Zerodha/Kite status
                    const zerodhaIndicator = document.getElementById('zerodhaIndicator');
                    const zerodhaText = document.getElementById('zerodhaText');
                    const zerodhaLatency = document.getElementById('zerodhaLatency');
                    
                    if (data.kite) {
                        if (zerodhaIndicator) {
                            zerodhaIndicator.className = data.kite.connected ? 'indicator-dot connected' : 'indicator-dot disconnected';
                        }
                        if (zerodhaText) {
                            zerodhaText.textContent = data.kite.display_text || (data.kite.connected ? 'Connected' : 'Session Expired');
                        }
                        if (zerodhaLatency) {
                            zerodhaLatency.querySelector('.latency-value').textContent = data.kite.token_expiry || '--ms';
                        }
                    }
                    
                    // Update Breeze status
                    const breezeIndicator = document.getElementById('breezeIndicator');
                    const breezeText = document.getElementById('breezeText');
                    const breezeLatency = document.getElementById('breezeLatency');
                    
                    if (data.breeze) {
                        if (breezeIndicator) {
                            breezeIndicator.className = data.breeze.connected ? 'indicator-dot connected' : 'indicator-dot disconnected';
                        }
                        if (breezeText) {
                            breezeText.textContent = data.breeze.display_text || (data.breeze.connected ? 'Connected' : 'OTP Required');
                        }
                        if (breezeLatency) {
                            breezeLatency.querySelector('.latency-value').textContent = data.breeze.token_expiry || '--ms';
                        }
                    }
                    
                    // Update market status
                    const marketStatusEl = document.getElementById('marketStatus');
                    if (marketStatusEl && data.market) {
                        marketStatusEl.textContent = data.market.status;
                        marketStatusEl.className = data.market.is_open ? 'status open' : 'status error';
                    }
                } else {
                    // If API call fails, fall back to individual checks
                    checkZerodhaConnection();
                    checkBreezeConnection();
                }
            } catch (error) {
                console.error('Unified status check failed:', error);
                // Fall back to individual checks
                checkZerodhaConnection();
                checkBreezeConnection();
            }
        }
        
        async function checkZerodhaConnection() {
            const indicatorDot = document.getElementById('zerodhaIndicator');
            const statusText = document.getElementById('zerodhaText');
            const loginBtn = document.getElementById('zerodhaLoginBtn');
            const latencyBadge = document.getElementById('zerodhaLatency');
            
            // Set checking state immediately
            if (statusText) statusText.textContent = 'Connecting...';
            
            const startTime = performance.now();
            try {
                // Create timeout controller with shorter timeout
                const controller = new AbortController();
                const timeoutId = setTimeout(() => {
                    controller.abort();
                }, 5000); // 5 second timeout
                
                // First try the auto-login status which works correctly
                const response = await fetch(`${API_BASE}/auth/auto-login/status?t=${Date.now()}`, {
                    method: 'GET',
                    signal: controller.signal,
                    cache: 'no-cache',
                    headers: {
                        'Cache-Control': 'no-cache',
                        'Pragma': 'no-cache'
                    }
                });
                
                clearTimeout(timeoutId);
                const latency = Math.round(performance.now() - startTime);
                
                let isConnected = false;
                
                if (response.ok) {
                    const data = await response.json();
                    // Check if it's auto-login status response
                    if (data.kite) {
                        // Use auto-login status format
                        const kiteData = data.kite;
                        
                        // Also validate the session actually works
                        let sessionValid = false;
                        try {
                            const validateResponse = await fetch(`${API_BASE}/session/validate?api_type=kite&t=${Date.now()}`, {
                                method: 'GET',
                                cache: 'no-cache'
                            });
                            if (validateResponse.ok) {
                                const validateData = await validateResponse.json();
                                sessionValid = validateData.is_valid === true;
                            }
                        } catch (e) {
                            console.log('Kite session validation failed:', e);
                        }
                        
                        // Only show connected if session is both reported as connected AND valid
                        if (kiteData.connected === true && sessionValid) {
                            indicatorDot.className = 'indicator-dot connected';
                            statusText.textContent = 'Connected';
                            isConnected = true;
                            
                            // Update latency badge
                            updateLatencyBadge(latencyBadge, latency);
                            trackAPILatency('zerodha', latency);
                        } else if (kiteData.connected === true && !sessionValid) {
                            indicatorDot.className = 'indicator-dot disconnected';
                            statusText.textContent = 'Session Invalid';
                            latencyBadge.querySelector('.latency-value').textContent = '--ms';
                        } else {
                            indicatorDot.className = 'indicator-dot disconnected';
                            statusText.textContent = 'Session Expired';
                            latencyBadge.querySelector('.latency-value').textContent = '--ms';
                        }
                    } else if (data.is_connected || data.status === 'connected') {
                        indicatorDot.className = 'indicator-dot connected';
                        statusText.textContent = 'Connected';
                        isConnected = true;
                        
                        // Update latency badge
                        updateLatencyBadge(latencyBadge, latency);
                        trackAPILatency('zerodha', latency);
                    } else {
                        indicatorDot.className = 'indicator-dot disconnected';
                        statusText.textContent = data.reason || 'Disconnected';
                        latencyBadge.querySelector('.latency-value').textContent = '--ms';
                    }
                } else {
                    indicatorDot.className = 'indicator-dot disconnected';
                    statusText.textContent = 'Offline';
                    latencyBadge.querySelector('.latency-value').textContent = '--ms';
                }
                
                // Show/hide login button for Zerodha
                loginBtn.style.display = isConnected ? 'none' : 'inline-flex';
                
                // Update combined login button visibility
                updateCombinedLoginButton();
                
                return isConnected;
            } catch (error) {
                console.log('Zerodha connection check error:', error.message);
                if (indicatorDot) indicatorDot.className = 'indicator-dot disconnected';
                if (statusText) {
                    // Check if it's a timeout or network error
                    if (error.name === 'AbortError') {
                        statusText.textContent = 'Timeout';
                    } else if (error.message && error.message.includes('Failed to fetch')) {
                        statusText.textContent = 'API Offline';
                    } else {
                        statusText.textContent = 'Disconnected';
                    }
                }
                if (loginBtn) loginBtn.style.display = 'inline-flex';
                if (latencyBadge) {
                    const latencyValue = latencyBadge.querySelector('.latency-value');
                    if (latencyValue) latencyValue.textContent = '--ms';
                    latencyBadge.className = 'latency-badge poor';
                }
                updateCombinedLoginButton();
                return false;
            }
        }
        
        async function checkBreezeConnection() {
            const indicatorDot = document.getElementById('breezeIndicator');
            const statusText = document.getElementById('breezeText');
            const loginBtn = document.getElementById('breezeLoginBtn');
            const latencyBadge = document.getElementById('breezeLatency');
            
            // Set checking state immediately
            if (statusText) statusText.textContent = 'Connecting...';
            
            const startTime = performance.now();
            try {
                // Create timeout controller with shorter timeout
                const controller = new AbortController();
                const timeoutId = setTimeout(() => {
                    controller.abort();
                }, 5000); // 5 second timeout
                
                // First try auto-login status for consistency
                const response = await fetch(`${API_BASE}/auth/auto-login/status?t=${Date.now()}`, {
                    method: 'GET',
                    signal: controller.signal,
                    cache: 'no-cache',
                    headers: {
                        'Cache-Control': 'no-cache',
                        'Pragma': 'no-cache'
                    }
                });
                
                clearTimeout(timeoutId);
                const latency = Math.round(performance.now() - startTime);
                
                let isConnected = false;
                
                if (response.ok) {
                    const data = await response.json();
                    // Check auto-login status for Breeze
                    if (data.breeze) {
                        const breezeData = data.breeze;
                        
                        // Also validate the session actually works
                        let sessionValid = false;
                        try {
                            const validateResponse = await fetch(`${API_BASE}/session/validate?api_type=breeze&t=${Date.now()}`, {
                                method: 'GET',
                                cache: 'no-cache'
                            });
                            if (validateResponse.ok) {
                                const validateData = await validateResponse.json();
                                sessionValid = validateData.is_valid === true;
                            }
                        } catch (e) {
                            console.log('Session validation failed:', e);
                        }
                        
                        // Only show connected if session is both active AND valid
                        if (breezeData.session_active && !breezeData.otp_required && sessionValid) {
                            indicatorDot.className = 'indicator-dot connected';
                            statusText.textContent = 'Connected';
                            isConnected = true;
                            
                            // Update latency badge
                            updateLatencyBadge(latencyBadge, latency);
                            trackAPILatency('breeze', latency);
                        } else if (!sessionValid && breezeData.session_active) {
                            indicatorDot.className = 'indicator-dot disconnected';
                            statusText.textContent = 'Session Invalid';
                            latencyBadge.querySelector('.latency-value').textContent = '--ms';
                        } else if (breezeData.otp_required) {
                            indicatorDot.className = 'indicator-dot disconnected';
                            statusText.textContent = 'OTP Required';
                            latencyBadge.querySelector('.latency-value').textContent = '--ms';
                        } else {
                            indicatorDot.className = 'indicator-dot disconnected';
                            statusText.textContent = 'Session Expired';
                            latencyBadge.querySelector('.latency-value').textContent = '--ms';
                        }
                    }
                } else {
                    indicatorDot.className = 'indicator-dot disconnected';
                    statusText.textContent = 'Offline';
                    latencyBadge.querySelector('.latency-value').textContent = '--ms';
                }
                
                // Show/hide login button for Breeze
                loginBtn.style.display = isConnected ? 'none' : 'inline-flex';
                
                // Update combined login button visibility
                updateCombinedLoginButton();
                
                return isConnected;
            } catch (error) {
                console.log('Breeze connection check error:', error.message);
                if (indicatorDot) indicatorDot.className = 'indicator-dot disconnected';
                if (statusText) {
                    // Check if it's a timeout or network error
                    if (error.name === 'AbortError') {
                        statusText.textContent = 'Timeout';
                    } else if (error.message && error.message.includes('Failed to fetch')) {
                        statusText.textContent = 'API Offline';
                    } else {
                        statusText.textContent = 'Disconnected';
                    }
                }
                if (loginBtn) loginBtn.style.display = 'inline-flex';
                if (latencyBadge) {
                    const latencyValue = latencyBadge.querySelector('.latency-value');
                    if (latencyValue) latencyValue.textContent = '--ms';
                    latencyBadge.className = 'latency-badge poor';
                }
                updateCombinedLoginButton();
                return false;
            }
        }

        function updateBrokerStatus() {
            // Initial status check for both brokers
            checkBrokerConnection();
        }
        
        function updateCombinedLoginButton() {
            const zerodhaBtn = document.getElementById('zerodhaLoginBtn');
            const breezeBtn = document.getElementById('breezeLoginBtn');
            const loginBothBtn = document.getElementById('loginBothBtn');
            
            // Check if both individual buttons are visible (both disconnected)
            const bothDisconnected = zerodhaBtn.style.display !== 'none' && breezeBtn.style.display !== 'none';
            
            if (bothDisconnected) {
                // Hide individual buttons and show combined button
                zerodhaBtn.style.display = 'none';
                breezeBtn.style.display = 'none';
                loginBothBtn.style.display = 'inline-flex';
            } else {
                // Show individual buttons as needed, hide combined button
                loginBothBtn.style.display = 'none';
            }
        }
        
        // Auto-login functions
        async function loginZerodha() {
            try {
                // Open auto-login page in a new tab for Zerodha
                window.open('auto_login_dashboard.html?broker=zerodha', '_blank');
                
                // Alternative: Direct API call for auto-login
                const response = await fetch(`${API_BASE}/auth/auto-login/kite`, {
                    method: 'POST'
                });
                
                if (response.ok) {
                    console.log('Zerodha auto-login initiated');
                    // Recheck connection after a delay
                    setTimeout(() => checkZerodhaConnection(), 3000);
                }
            } catch (error) {
                console.error('Zerodha login error:', error);
            }
        }
        
        async function loginBreeze() {
            try {
                // Open auto-login page in a new tab for Breeze
                window.open('auto_login_dashboard.html?broker=breeze', '_blank');
                
                // Alternative: Direct API call for auto-login
                const response = await fetch(`${API_BASE}/auth/auto-login/breeze`, {
                    method: 'POST'
                });
                
                if (response.ok) {
                    console.log('Breeze auto-login initiated');
                    // Recheck connection after a delay
                    setTimeout(() => checkBreezeConnection(), 3000);
                }
            } catch (error) {
                console.error('Breeze login error:', error);
            }
        }
        
        async function loginBoth() {
            try {
                // Open auto-login page for both brokers
                window.open('auto_login_dashboard.html?broker=both', '_blank');
                
                // Alternative: Trigger both logins via API
                Promise.all([
                    fetch(`${API_BASE}/auth/auto-login/kite`, { method: 'POST' }),
                    fetch(`${API_BASE}/auth/auto-login/breeze`, { method: 'POST' })
                ]).then(() => {
                    console.log('Both brokers auto-login initiated');
                    // Recheck connections after a delay
                    setTimeout(() => {
                        checkZerodhaConnection();
                        checkBreezeConnection();
                    }, 3000);
                });
            } catch (error) {
                console.error('Login both error:', error);
            }
        }
        
        // Performance Monitoring Functions
        let performanceMetrics = {
            apiCalls: [],
            latencyHistory: {
                zerodha: [],
                breeze: []
            },
            throughput: 0,
            avgResponseTime: 0,
            systemLoad: 0
        };
        
        function initPerformanceMonitoring() {
            // Track all API calls
            const originalFetch = window.fetch;
            window.fetch = function(...args) {
                const startTime = performance.now();
                const url = args[0];
                
                return originalFetch.apply(this, args).then(response => {
                    const duration = performance.now() - startTime;
                    trackAPICall(url, duration, response.ok);
                    return response;
                }).catch(error => {
                    const duration = performance.now() - startTime;
                    trackAPICall(url, duration, false);
                    throw error;
                });
            };
        }
        
        function trackAPICall(url, duration, success) {
            const now = Date.now();
            performanceMetrics.apiCalls.push({
                url,
                duration,
                success,
                timestamp: now
            });
            
            // Keep only last 100 calls
            if (performanceMetrics.apiCalls.length > 100) {
                performanceMetrics.apiCalls.shift();
            }
            
            // Update throughput calculation
            const recentCalls = performanceMetrics.apiCalls.filter(call => 
                now - call.timestamp < 60000 // Last minute
            );
            performanceMetrics.throughput = recentCalls.length / 60; // Calls per second
        }
        
        function trackAPILatency(broker, latency) {
            performanceMetrics.latencyHistory[broker].push({
                value: latency,
                timestamp: Date.now()
            });
            
            // Keep only last 50 measurements
            if (performanceMetrics.latencyHistory[broker].length > 50) {
                performanceMetrics.latencyHistory[broker].shift();
            }
        }
        
        function updateLatencyBadge(badge, latency) {
            const latencyValue = badge.querySelector('.latency-value');
            latencyValue.textContent = `${latency}ms`;
            
            // Update color based on latency
            badge.className = 'latency-badge';
            if (latency < 50) {
                badge.classList.add('excellent');
            } else if (latency < 200) {
                badge.classList.add('good');
            } else if (latency < 500) {
                badge.classList.add('slow');
            } else {
                badge.classList.add('poor');
            }
        }
        
        async function updatePerformanceMetrics() {
            try {
                // Calculate average response time from actual API calls
                if (performanceMetrics.apiCalls.length > 0) {
                    const recentCalls = performanceMetrics.apiCalls.slice(-20);
                    const avgTime = recentCalls.reduce((sum, call) => sum + call.duration, 0) / recentCalls.length;
                    performanceMetrics.avgResponseTime = Math.round(avgTime);
                    document.getElementById('avgResponseTime').textContent = performanceMetrics.avgResponseTime;
                } else {
                    // No API calls yet, show --
                    document.getElementById('avgResponseTime').textContent = '--';
                }
                
                // Calculate real throughput (requests per second in last minute)
                const oneMinuteAgo = Date.now() - 60000;
                const recentAPICalls = performanceMetrics.apiCalls.filter(call => call.timestamp > oneMinuteAgo);
                if (recentAPICalls.length > 0) {
                    const throughput = recentAPICalls.length / 60; // requests per second
                    document.getElementById('apiThroughput').textContent = throughput.toFixed(1);
                } else {
                    // No recent API calls, show 0.0
                    document.getElementById('apiThroughput').textContent = '0.0';
                }
                
                // Get real system metrics from API
                const metricsResponse = await fetch(`${API_BASE}/system/metrics`);
                if (metricsResponse.ok) {
                    const metrics = await metricsResponse.json();
                    
                    // Update system load
                    performanceMetrics.systemLoad = metrics.cpu_usage || 0;
                    document.getElementById('systemLoad').textContent = Math.round(performanceMetrics.systemLoad);
                    
                    // Update other metrics if elements exist
                    if (document.getElementById('memoryUsage')) {
                        document.getElementById('memoryUsage').textContent = Math.round(metrics.memory_usage) + '%';
                    }
                    if (document.getElementById('diskUsage')) {
                        document.getElementById('diskUsage').textContent = Math.round(metrics.disk_usage) + '%';
                    }
                } else {
                    // API not available, show -- for all metrics
                    document.getElementById('systemLoad').textContent = '--';
                    if (document.getElementById('memoryUsage')) {
                        document.getElementById('memoryUsage').textContent = '--';
                    }
                    if (document.getElementById('diskUsage')) {
                        document.getElementById('diskUsage').textContent = '--';
                    }
                }
            } catch (error) {
                console.error('Error updating performance metrics:', error);
                // Show -- when no data available
                document.getElementById('apiThroughput').textContent = '--';
                document.getElementById('avgResponseTime').textContent = '--';
                document.getElementById('systemLoad').textContent = '--';
                if (document.getElementById('memoryUsage')) {
                    document.getElementById('memoryUsage').textContent = '--';
                }
                if (document.getElementById('diskUsage')) {
                    document.getElementById('diskUsage').textContent = '--';
                }
            }
        }
        
        // Check API Status
        async function checkAPIStatus() {
            const indicator = document.getElementById('apiIndicator');
            const statusText = document.getElementById('apiStatusText');
            
            try {
                // Set checking state
                if (indicator) indicator.className = 'api-indicator-dot checking';
                if (statusText) statusText.textContent = 'API: Checking';
                
                // Create timeout controller
                const controller = new AbortController();
                const timeoutId = setTimeout(() => {
                    controller.abort();
                }, 5000); // 5 second timeout for API health
                
                const response = await fetch(`${API_BASE}/health`, {
                    method: 'GET',
                    signal: controller.signal,
                    cache: 'no-cache'
                });
                
                clearTimeout(timeoutId);
                
                if (response.ok) {
                    const data = await response.json();
                    if (data.status === 'healthy' || data.status === 'ok') {
                        indicator.className = 'api-indicator-dot online';
                        statusText.textContent = 'API: Online';
                        
                        // Check if API was previously offline and send notification
                        if (window.apiWasOffline) {
                            showNotification('API server is back online', 'success');
                            window.apiWasOffline = false;
                        }
                    } else {
                        indicator.className = 'api-indicator-dot offline';
                        statusText.textContent = 'API: Error';
                        window.apiWasOffline = true;
                    }
                } else {
                    indicator.className = 'api-indicator-dot offline';
                    statusText.textContent = 'API: Offline';
                    window.apiWasOffline = true;
                }
            } catch (error) {
                // API is not reachable
                console.log('API status check error:', error.message);
                if (indicator) indicator.className = 'api-indicator-dot offline';
                if (statusText) {
                    if (error.name === 'AbortError') {
                        statusText.textContent = 'API: Timeout';
                    } else {
                        statusText.textContent = 'API: Offline';
                    }
                }
                
                // Send notification if this is the first time detecting offline
                if (!window.apiWasOffline) {
                    showNotification('API server is not responding', 'error');
                    window.apiWasOffline = true;
                }
            }
        }
        
        // Real-Time Trading Notifications System
        let notificationState = {
            lastSignal: null,
            lastPnl: 0,
            lastPositionCount: 0,
            brokerStatus: { zerodha: false, breeze: false },
            marketOpen: false,
            lastOrderId: null,
            signalCooldown: {},
            dailyHighPnl: 0,
            dailyLowPnl: 0,
            latencyAlerted: {}
        };

        // Initialize real-time notification system
        function initializeRealTimeNotifications() {
            // Start monitoring different aspects
            monitorTradingSignals();
            monitorOrdersAndPositions();
            monitorPnL();
            monitorMarketStatus();
            
            // Set up intervals for different monitoring frequencies
            setInterval(checkSignals, 10000); // Check signals every 10 seconds
            setInterval(checkPositionsAndOrders, 5000); // Check positions every 5 seconds
            setInterval(checkPnL, 3000); // Check P&L every 3 seconds
            setInterval(checkMarketTiming, 60000); // Check market timing every minute
            
            // Check for performance alerts
            setInterval(() => {
                // Check latency alerts
                Object.keys(performanceMetrics.latencyHistory).forEach(broker => {
                    const history = performanceMetrics.latencyHistory[broker];
                    if (history.length > 0) {
                        const latestLatency = history[history.length - 1].value;
                        if (latestLatency > 500 && !notificationState.latencyAlerted[broker]) {
                            notificationCenter.add({
                                type: 'warning',
                                message: ` High ${broker.toUpperCase()} latency: ${latestLatency}ms`,
                                link: 'monitoring_dashboard.html',
                                linkTitle: 'System Monitoring'
                            });
                            notificationState.latencyAlerted[broker] = true;
                            setTimeout(() => {
                                notificationState.latencyAlerted[broker] = false;
                            }, 300000); // Reset after 5 minutes
                        }
                    }
                });
                
                // Check system load
                if (performanceMetrics.systemLoad > 80) {
                    notificationCenter.add({
                        type: 'danger',
                        message: ` High system load: ${Math.round(performanceMetrics.systemLoad)}%`,
                        link: 'performance_dashboard.html',
                        linkTitle: 'Performance Dashboard'
                    });
                }
                
                // Check API throughput
                if (performanceMetrics.throughput > 50) {
                    notificationCenter.add({
                        type: 'info',
                        message: ` High API throughput: ${performanceMetrics.throughput.toFixed(1)} req/s`,
                        link: 'performance_dashboard.html',
                        linkTitle: 'View Metrics'
                    });
                }
            }, 30000); // Check every 30 seconds
        }

        // Monitor Trading Signals (S1-S8)
        async function monitorTradingSignals() {
            try {
                const response = await fetch(`${API_BASE}/signals/detect`);
                if (response.ok) {
                    const data = await response.json();
                    if (data.signal && data.signal !== notificationState.lastSignal) {
                        const signalDescriptions = {
                            'S1': 'Bear Trap (Bullish) - Sell PUT',
                            'S2': 'Support Hold (Bullish) - Sell PUT',
                            'S3': 'Resistance Hold (Bearish) - Sell CALL',
                            'S4': 'Bias Failure Bull (Bullish) - Sell PUT',
                            'S5': 'Bias Failure Bear (Bearish) - Sell CALL',
                            'S6': 'Weakness Confirmed (Bearish) - Sell CALL',
                            'S7': 'Breakout Confirmed (Bullish) - Sell PUT',
                            'S8': 'Breakdown Confirmed (Bearish) - Sell CALL'
                        };
                        
                        const isBullish = ['S1', 'S2', 'S4', 'S7'].includes(data.signal);
                        const icon = isBullish ? '' : '';
                        
                        notificationCenter.add({
                            type: isBullish ? 'success' : 'warning',
                            message: `${icon} ${data.signal} Signal: ${signalDescriptions[data.signal]}${data.stop_loss ? ` | SL: ${data.stop_loss}` : ''}`,
                            link: 'signals.html',
                            linkTitle: 'Trade Now'
                        });
                        
                        notificationState.lastSignal = data.signal;
                        notificationState.signalCooldown[data.signal] = Date.now();
                    }
                }
            } catch (error) {
                console.error('Signal monitoring error:', error);
            }
        }

        async function checkSignals() {
            // Only check if market is open
            const now = new Date();
            const hours = now.getHours();
            const minutes = now.getMinutes();
            const isMarketHours = (hours === 9 && minutes >= 15) || (hours > 9 && hours < 15) || (hours === 15 && minutes <= 30);
            
            if (isMarketHours) {
                monitorTradingSignals();
            }
        }

        // Monitor Orders and Positions
        async function monitorOrdersAndPositions() {
            try {
                // Check positions
                const posResponse = await fetch(`${API_BASE}/positions`);
                if (posResponse.ok) {
                    const positions = await posResponse.json();
                    const currentCount = positions.net ? positions.net.length : (Array.isArray(positions) ? positions.length : 0);
                    
                    if (currentCount > notificationState.lastPositionCount) {
                        const latestPosition = Array.isArray(positions) ? positions[positions.length - 1] : positions.net?.[positions.net.length - 1];
                        if (latestPosition) {
                            notificationCenter.add({
                                type: 'info',
                                message: ` Position opened: ${latestPosition.tradingsymbol || 'Options'}`,
                                link: 'positions.html',
                                linkTitle: 'View Positions'
                            });
                        }
                    } else if (currentCount < notificationState.lastPositionCount && currentCount >= 0) {
                        notificationCenter.add({
                            type: 'info',
                            message: ` Position closed`,
                            link: 'positions.html',
                            linkTitle: 'View Summary'
                        });
                    }
                    
                    // Check for positions with significant P&L
                    const positionsList = Array.isArray(positions) ? positions : (positions.net || []);
                    positionsList.forEach(pos => {
                        const pnl = pos.pnl || pos.unrealised || 0;
                        if (pnl < -2000) {
                            const stopLossProximity = Math.abs(pnl / 3000) * 100;
                            if (stopLossProximity > 80 && !pos._alerted) {
                                notificationCenter.add({
                                    type: 'danger',
                                    message: ` ${pos.tradingsymbol} near SL (${stopLossProximity.toFixed(0)}% loss)`,
                                    link: 'positions.html',
                                    linkTitle: 'Manage Position'
                                });
                                pos._alerted = true;
                            }
                        }
                    });
                    
                    notificationState.lastPositionCount = currentCount;
                }

                // Check orders
                const orderResponse = await fetch(`${API_BASE}/orders`);
                if (orderResponse.ok) {
                    const orders = await orderResponse.json();
                    const ordersList = Array.isArray(orders) ? orders : [];
                    
                    ordersList.slice(-5).forEach(order => {
                        if (order.order_id && order.order_id !== notificationState.lastOrderId) {
                            if (order.status === 'COMPLETE') {
                                const side = order.transaction_type === 'BUY' ? ' BUY' : ' SELL';
                                notificationCenter.add({
                                    type: 'success',
                                    message: ` Executed: ${side} ${order.tradingsymbol} @ ${order.price || order.average_price}`,
                                    link: 'positions.html',
                                    linkTitle: 'View Orders'
                                });
                                notificationState.lastOrderId = order.order_id;
                            } else if (order.status === 'REJECTED') {
                                notificationCenter.add({
                                    type: 'danger',
                                    message: ` Rejected: ${order.tradingsymbol} - ${order.status_message || 'Check margin'}`,
                                    link: 'positions.html',
                                    linkTitle: 'Retry Order'
                                });
                            }
                        }
                    });
                }
            } catch (error) {
                console.error('Order/Position monitoring error:', error);
            }
        }

        async function checkPositionsAndOrders() {
            monitorOrdersAndPositions();
        }

        // Monitor P&L
        async function monitorPnL() {
            try {
                const response = await fetch(`${API_BASE}/live/pnl`);
                if (response.ok) {
                    const data = await response.json();
                    const currentPnl = data.total_pnl || data.realised || 0;
                    
                    // Track daily highs and lows
                    if (currentPnl > notificationState.dailyHighPnl) {
                        notificationState.dailyHighPnl = currentPnl;
                        if (currentPnl > 10000) {
                            notificationCenter.add({
                                type: 'success',
                                message: ` Daily High P&L: +${currentPnl.toLocaleString('en-IN')}`,
                                link: 'positions.html',
                                linkTitle: 'View P&L'
                            });
                        }
                    }
                    
                    if (currentPnl < notificationState.dailyLowPnl) {
                        notificationState.dailyLowPnl = currentPnl;
                        if (currentPnl < -5000) {
                            notificationCenter.add({
                                type: 'warning',
                                message: ` Loss Alert: -${Math.abs(currentPnl).toLocaleString('en-IN')}`,
                                link: 'positions.html',
                                linkTitle: 'Risk Management'
                            });
                        }
                    }
                    
                    // Max loss alert
                    if (currentPnl < -8000 && notificationState.lastPnl > -8000) {
                        notificationCenter.add({
                            type: 'danger',
                            message: ` MAX LOSS WARNING: -${Math.abs(currentPnl).toLocaleString('en-IN')} (Limit: 10,000)`,
                            link: 'positions.html',
                            linkTitle: 'CLOSE POSITIONS'
                        });
                    }
                    
                    // Target achieved
                    if (currentPnl > 10000 && notificationState.lastPnl <= 10000) {
                        notificationCenter.add({
                            type: 'success',
                            message: ` TARGET ACHIEVED: +${currentPnl.toLocaleString('en-IN')}`,
                            link: 'positions.html',
                            linkTitle: 'Book Profits'
                        });
                    }
                    
                    notificationState.lastPnl = currentPnl;
                }
            } catch (error) {
                console.error('P&L monitoring error:', error);
            }
        }

        async function checkPnL() {
            const now = new Date();
            const hours = now.getHours();
            const isMarketHours = (hours >= 9 && hours < 16);
            
            if (isMarketHours) {
                monitorPnL();
            }
        }

        // Monitor Market Status
        function monitorMarketStatus() {
            // DISABLED - These are time-based notifications, not real trading events
            // Only real signals and actual trades should generate notifications
            return;
            
            const now = new Date();
            const hours = now.getHours();
            const minutes = now.getMinutes();
            const dayOfWeek = now.getDay();
            
            // Check if it's a weekday
            if (dayOfWeek >= 1 && dayOfWeek <= 5) {
                // Market opening alerts
                if (hours === 9 && minutes === 10) {
                    notificationCenter.add({
                        type: 'info',
                        message: ' Market opens in 5 minutes - Get ready!',
                        link: 'live_trading_pro_complete.html',
                        linkTitle: 'Open Trading'
                    });
                }
                
                if (hours === 9 && minutes === 15 && !notificationState.marketOpen) {
                    notificationCenter.add({
                        type: 'success',
                        message: ' MARKET OPEN - Trading Active',
                        link: 'live_trading_pro_complete.html',
                        linkTitle: 'Start Trading'
                    });
                    notificationState.marketOpen = true;
                    notificationState.dailyHighPnl = 0;
                    notificationState.dailyLowPnl = 0;
                }
                
                // High volatility periods
                if (hours === 9 && minutes === 30) {
                    notificationCenter.add({
                        type: 'warning',
                        message: ' 9:30 AM - High volatility period',
                        link: 'option_chain.html',
                        linkTitle: 'Options Chain'
                    });
                }
                
                if (hours === 14 && minutes === 30) {
                    notificationCenter.add({
                        type: 'warning',
                        message: ' 2:30 PM - US market impact zone',
                        link: 'option_chain.html',
                        linkTitle: 'Monitor Positions'
                    });
                }
                
                // Market closing alerts
                if (hours === 15 && minutes === 15) {
                    notificationCenter.add({
                        type: 'warning',
                        message: ' Market closes in 15 minutes',
                        link: 'positions.html',
                        linkTitle: 'Square Off'
                    });
                }
                
                if (hours === 15 && minutes === 30 && notificationState.marketOpen) {
                    const pnlMessage = notificationState.lastPnl >= 0 
                        ? `+${notificationState.lastPnl.toLocaleString('en-IN')}` 
                        : `-${Math.abs(notificationState.lastPnl).toLocaleString('en-IN')}`;
                    
                    const pnlType = notificationState.lastPnl >= 0 ? 'success' : 'warning';
                    
                    notificationCenter.add({
                        type: pnlType,
                        message: ` MARKET CLOSED - Day P&L: ${pnlMessage}`,
                        link: 'positions.html',
                        linkTitle: 'View Summary'
                    });
                    notificationState.marketOpen = false;
                }
                
                // Weekly expiry alert (Thursday)
                if (day === 4 && hours === 9 && minutes === 0) {
                    notificationCenter.add({
                        type: 'warning',
                        message: ' WEEKLY EXPIRY DAY - High volatility expected',
                        link: 'option_chain.html',
                        linkTitle: 'Options Strategy'
                    });
                }
            }
        }

        async function checkMarketTiming() {
            monitorMarketStatus();
        }
        
        // Function to populate with real trading notifications
        // REMOVED loadRealNotifications - This was adding dummy notifications!
        // Only real trading events from API should generate notifications
        
        window.loadRealNotifications = function() {
            // This function has been disabled
            // It was adding dummy notifications that looked real but weren't
            console.log('loadRealNotifications has been disabled - only real trading events will generate notifications');
        };
        
        // DISABLED auto-load of dummy notifications
        // setTimeout(() => {
        //     if (notificationCenter && notificationCenter.notifications.length <= 2) {
        //         window.loadRealNotifications();
        //     }
        // }, 2000);
        
        // Keyboard shortcut: Ctrl+Shift+N - DISABLED (was loading dummy notifications)
        document.addEventListener('keydown', function(e) {
            if (e.ctrlKey && e.shiftKey && e.key === 'N') {
                e.preventDefault();
                // window.loadRealNotifications(); // DISABLED - was adding dummy notifications
                console.log('Ctrl+Shift+N disabled - was loading dummy notifications');
                document.getElementById('notificationPanel').classList.add('active');
            }
        });
        
        // Ensure logout button appears
        window.addEventListener('load', () => {
            setTimeout(() => {
                const authStatusDiv = document.getElementById('auth-status');
                if (authStatusDiv) {
                    const token = localStorage.getItem('auth_token');
                    const user = localStorage.getItem('auth_user');
                    
                    if (token && user) {
                        // User is logged in, show logout button
                        let username = 'User';
                        try {
                            const userData = JSON.parse(user);
                            username = userData.username || userData.email || 'User';
                        } catch (e) {}
                        
                        authStatusDiv.innerHTML = `
                            <span style="color: #10b981; font-weight: 500;">
                                <i class="fas fa-user-circle"></i> ${username}
                            </span>
                            <button onclick="handleLogout()" style="
                                background: #ef4444;
                                color: white;
                                border: none;
                                padding: 6px 12px;
                                border-radius: 4px;
                                cursor: pointer;
                                font-size: 14px;
                                margin-left: 10px;
                            ">
                                <i class="fas fa-sign-out-alt"></i> Logout
                            </button>
                        `;
                    } else {
                        // User is not logged in
                        authStatusDiv.innerHTML = `
                            <span style="color: #f59e0b;">
                                <i class="fas fa-user-slash"></i> Not logged in
                            </span>
                            <button onclick="window.location.href='/login_secure.html'" style="
                                background: #667eea;
                                color: white;
                                border: none;
                                padding: 6px 12px;
                                border-radius: 4px;
                                cursor: pointer;
                                font-size: 14px;
                                margin-left: 10px;
                            ">
                                <i class="fas fa-sign-in-alt"></i> Login
                            </button>
                        `;
                    }
                }
            }, 500); // Small delay to ensure DOM is ready
        });
        
        // Logout handler
        function handleLogout() {
            // Clear tokens
            localStorage.removeItem('auth_token');
            localStorage.removeItem('auth_user');
            localStorage.removeItem('refresh_token');
            
            // Show message
            alert('Logged out successfully');
            
            // Redirect to login
            window.location.href = '/login_secure.html';
        }
        
        // Add missing showNotification function
        function showNotification(message, type = 'info') {
            console.log(`[${type.toUpperCase()}] ${message}`);
            // You can add more elaborate notification logic here if needed
        }
        
        // Notification Settings Functions
        function toggleNotificationSettings() {
            const modal = document.getElementById('notificationSettingsModal');
            modal.style.display = 'flex';
            updateNotificationStatus();
        }
        
        function closeNotificationSettings() {
            const modal = document.getElementById('notificationSettingsModal');
            modal.style.display = 'none';
        }
        
        function initializeNotificationSettings() {
            // Check if notifications are enabled in localStorage
            const notificationsEnabled = localStorage.getItem('notificationsEnabled') === 'true';
            const toggle = document.getElementById('notificationToggle');
            if (toggle) {
                toggle.checked = notificationsEnabled;
            }
            
            // Update the bell icon color based on notification status
            updateBellIconStatus();
        }
        
        function updateBellIconStatus() {
            const notificationsEnabled = localStorage.getItem('notificationsEnabled') === 'true';
            const bellIcon = document.querySelector('#notificationBtn i');
            
            if (bellIcon) {
                if (notificationsEnabled && 'Notification' in window && Notification.permission === 'granted') {
                    bellIcon.style.color = 'var(--success)';
                } else if (notificationsEnabled) {
                    bellIcon.style.color = 'var(--warning)';
                } else {
                    bellIcon.style.color = 'var(--text-secondary)';
                }
            }
        }
        
        function updateNotificationStatus() {
            const statusText = document.getElementById('notificationStatusText');
            const notificationsEnabled = localStorage.getItem('notificationsEnabled') === 'true';
            
            if (!('Notification' in window)) {
                statusText.textContent = 'Your browser does not support notifications';
                statusText.style.color = 'var(--danger)';
            } else if (notificationsEnabled) {
                if (Notification.permission === 'granted') {
                    statusText.textContent = 'Notifications are enabled and working';
                    statusText.style.color = 'var(--success)';
                } else if (Notification.permission === 'denied') {
                    statusText.textContent = 'Notifications blocked by browser. Please check browser settings.';
                    statusText.style.color = 'var(--danger)';
                } else {
                    statusText.textContent = 'Notifications enabled. Permission will be requested when needed.';
                    statusText.style.color = 'var(--warning)';
                }
            } else {
                statusText.textContent = 'Notifications are disabled. Toggle the switch to enable.';
                statusText.style.color = 'var(--text-secondary)';
            }
        }
        
        async function toggleNotificationPermission() {
            const toggle = document.getElementById('notificationToggle');
            const isEnabled = toggle.checked;
            
            // Save preference to localStorage
            localStorage.setItem('notificationsEnabled', isEnabled.toString());
            
            if (isEnabled) {
                // User enabled notifications
                if ('Notification' in window) {
                    if (Notification.permission === 'default') {
                        // Request permission
                        const permission = await Notification.requestPermission();
                        if (permission === 'granted') {
                            // Show test notification
                            new Notification('Notifications Enabled!', {
                                body: 'You will now receive trading alerts and system notifications.',
                                icon: '/favicon.ico'
                            });
                        } else if (permission === 'denied') {
                            // Permission denied, disable toggle
                            toggle.checked = false;
                            localStorage.setItem('notificationsEnabled', 'false');
                            alert('Notification permission was denied. Please enable notifications in your browser settings.');
                        }
                    } else if (Notification.permission === 'granted') {
                        // Already have permission, show confirmation
                        new Notification('Notifications Re-enabled!', {
                            body: 'You will now receive trading alerts and system notifications.',
                            icon: '/favicon.ico'
                        });
                    } else if (Notification.permission === 'denied') {
                        // Previously denied, can't request again
                        toggle.checked = false;
                        localStorage.setItem('notificationsEnabled', 'false');
                        alert('Notifications are blocked by your browser. Please enable them in browser settings and refresh the page.');
                    }
                }
            } else {
                // User disabled notifications
                console.log('Notifications disabled by user');
            }
            
            // Update status text and bell icon
            updateNotificationStatus();
            updateBellIconStatus();
        }
    </script>
</body>
</html>
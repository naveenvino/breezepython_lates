<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trading Pro Complete - Modern Dark Theme</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/themes/dark.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr">
        const API_BASE = window.location.protocol === 'file:' ? 'http://localhost:8000' : '';</script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            /* Dark Theme Colors */
            --bg-primary: #0f1419;
            --bg-secondary: #1a1f2e;
            --bg-tertiary: #242837;
            --bg-card: #1e2332;
            --bg-hover: #2a3042;
            
            /* Accent Colors */
            --accent-blue: #00d4ff;
            --accent-green: #00ff88;
            --accent-red: #ff3366;
            --accent-purple: #9945ff;
            --accent-orange: #ff9500;
            --accent-yellow: #ffeb3b;
            
            /* Text Colors */
            --text-primary: #ffffff;
            --text-secondary: #8892b0;
            --text-muted: #495670;
            
            /* Gradients */
            --gradient-blue: linear-gradient(135deg, #667eea 0%, #00d4ff 100%);
            --gradient-green: linear-gradient(135deg, #00ff88 0%, #00d4aa 100%);
            --gradient-red: linear-gradient(135deg, #ff3366 0%, #ff6b6b 100%);
            --gradient-purple: linear-gradient(135deg, #9945ff 0%, #c770ff 100%);
            
            /* Shadows */
            --shadow-sm: 0 2px 4px rgba(0, 0, 0, 0.3);
            --shadow-md: 0 4px 6px rgba(0, 0, 0, 0.4);
            --shadow-lg: 0 10px 15px rgba(0, 0, 0, 0.5);
            --shadow-xl: 0 20px 25px rgba(0, 0, 0, 0.6);
            
            /* Glassmorphism */
            --glass-bg: rgba(255, 255, 255, 0.05);
            --glass-border: rgba(255, 255, 255, 0.1);
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            overflow-x: hidden;
            position: relative;
            min-height: 100vh;
        }

        /* Animated Background */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(circle at 20% 50%, rgba(0, 212, 255, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 80%, rgba(153, 69, 255, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 40% 20%, rgba(0, 255, 136, 0.1) 0%, transparent 50%);
            z-index: -1;
            animation: backgroundShift 20s ease-in-out infinite;
        }

        @keyframes backgroundShift {
            0%, 100% { transform: rotate(0deg) scale(1); }
            50% { transform: rotate(180deg) scale(1.1); }
        }

        /* Main Container */
        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Header */
        .header {
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            border: 1px solid var(--glass-border);
            border-radius: 20px;
            padding: 20px 30px;
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 20px;
            flex-wrap: wrap;
        }

        .header-title {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .header-title h1 {
            font-size: 28px;
            font-weight: 700;
            background: var(--gradient-blue);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .live-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: rgba(0, 255, 136, 0.1);
            border: 1px solid var(--accent-green);
            border-radius: 20px;
        }

        .live-dot {
            width: 8px;
            height: 8px;
            background: var(--accent-green);
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(0, 255, 136, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(0, 255, 136, 0); }
            100% { box-shadow: 0 0 0 0 rgba(0, 255, 136, 0); }
        }

        .header-stats {
            display: flex;
            gap: 30px;
        }

        .stat-item {
            text-align: center;
        }

        .stat-label {
            font-size: 11px;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .stat-value {
            font-size: 20px;
            font-weight: 700;
            margin-top: 5px;
        }

        .stat-value.positive {
            color: var(--accent-green);
        }

        .stat-value.negative {
            color: var(--accent-red);
        }

        /* Main Grid */
        .main-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 30px;
        }

        @media (max-width: 1400px) {
            .main-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Glass Card */
        .glass-card {
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            border: 1px solid var(--glass-border);
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 30px;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--glass-border);
        }

        .card-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .card-title i {
            color: var(--accent-blue);
        }

        /* Form Section */
        .form-section {
            margin-bottom: 25px;
        }

        .section-label {
            font-size: 12px;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .section-label i {
            color: var(--accent-purple);
        }

        /* Modern Input */
        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            font-size: 13px;
            color: var(--text-secondary);
            margin-bottom: 8px;
            font-weight: 500;
        }

        .form-control {
            width: 100%;
            padding: 12px 15px;
            background: var(--bg-primary);
            border: 2px solid var(--glass-border);
            border-radius: 10px;
            color: var(--text-primary);
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--accent-blue);
            background: var(--bg-secondary);
            box-shadow: 0 0 0 3px rgba(0, 212, 255, 0.1);
        }

        /* Signal Grid */
        .signals-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .signal-card {
            background: var(--bg-card);
            border: 2px solid var(--glass-border);
            border-radius: 12px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .signal-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 3px;
            background: var(--gradient-blue);
            transform: scaleX(0);
            transition: transform 0.3s ease;
        }

        .signal-card:hover {
            border-color: var(--accent-blue);
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .signal-card.selected {
            border-color: var(--accent-blue);
            background: rgba(0, 212, 255, 0.1);
        }

        .signal-card.selected::before {
            transform: scaleX(1);
        }

        .signal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .signal-name {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .signal-type {
            font-size: 11px;
            padding: 3px 8px;
            border-radius: 12px;
            font-weight: 500;
        }

        .signal-type.bullish {
            background: rgba(0, 255, 136, 0.2);
            color: var(--accent-green);
        }

        .signal-type.bearish {
            background: rgba(255, 51, 102, 0.2);
            color: var(--accent-red);
        }

        .signal-description {
            font-size: 12px;
            color: var(--text-muted);
        }

        /* Position Config Grid */
        .config-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        /* Modern Toggle */
        .toggle-container {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
        }

        .toggle-switch {
            position: relative;
            width: 50px;
            height: 26px;
            cursor: pointer;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--bg-hover);
            border-radius: 13px;
            transition: all 0.3s ease;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 3px;
            bottom: 3px;
            background: var(--text-muted);
            border-radius: 50%;
            transition: all 0.3s ease;
        }

        .toggle-switch input:checked + .toggle-slider {
            background: var(--gradient-blue);
        }

        .toggle-switch input:checked + .toggle-slider:before {
            transform: translateX(24px);
            background: white;
        }

        /* Risk Management */
        .risk-grid {
            display: grid;
            gap: 20px;
        }

        .risk-card {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 20px;
            border: 1px solid var(--glass-border);
            transition: all 0.3s ease;
        }

        .risk-card:hover {
            border-color: var(--accent-blue);
            box-shadow: var(--shadow-lg);
        }

        .risk-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .risk-title {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .risk-icon {
            width: 40px;
            height: 40px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }

        .risk-icon.stop-loss {
            background: rgba(255, 51, 102, 0.2);
            color: var(--accent-red);
        }

        .risk-icon.target {
            background: rgba(0, 255, 136, 0.2);
            color: var(--accent-green);
        }

        .risk-icon.trailing {
            background: rgba(153, 69, 255, 0.2);
            color: var(--accent-purple);
        }

        .risk-inputs {
            display: none;
            animation: slideDown 0.3s ease;
        }

        .risk-inputs.active {
            display: block;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .input-group {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
        }

        .input-field {
            position: relative;
        }

        .input-field input {
            width: 100%;
            padding: 12px 15px;
            background: var(--bg-primary);
            border: 2px solid var(--glass-border);
            border-radius: 10px;
            color: var(--text-primary);
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .input-field input:focus {
            outline: none;
            border-color: var(--accent-blue);
            background: var(--bg-secondary);
        }

        .input-field label {
            position: absolute;
            top: -8px;
            left: 12px;
            background: var(--bg-card);
            padding: 0 6px;
            font-size: 11px;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .value-display {
            margin-top: 8px;
            font-size: 12px;
            color: var(--accent-blue);
            font-weight: 600;
        }

        /* Trail Options */
        .trail-type-select {
            width: 100%;
            padding: 10px;
            background: var(--bg-primary);
            border: 2px solid var(--glass-border);
            border-radius: 10px;
            color: var(--text-primary);
            margin-bottom: 15px;
        }

        /* Info Box */
        .info-box {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            padding: 15px;
            margin-top: 15px;
            display: flex;
            align-items: flex-start;
            gap: 12px;
        }

        .info-box i {
            color: var(--accent-blue);
            font-size: 16px;
            margin-top: 2px;
        }

        .info-text {
            font-size: 13px;
            color: var(--text-secondary);
            line-height: 1.6;
        }

        /* Action Buttons */
        .action-buttons {
            display: flex;
            gap: 15px;
            margin-top: 25px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 12px 24px;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            border: none;
            display: flex;
            align-items: center;
            gap: 8px;
            position: relative;
            overflow: hidden;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            transform: translate(-50%, -50%);
            transition: width 0.5s ease, height 0.5s ease;
        }

        .btn:hover::before {
            width: 300px;
            height: 300px;
        }

        .btn-primary {
            background: var(--gradient-blue);
            color: white;
        }

        .btn-success {
            background: var(--gradient-green);
            color: white;
        }

        .btn-warning {
            background: linear-gradient(135deg, var(--accent-orange), var(--accent-yellow));
            color: white;
        }

        .btn-danger {
            background: var(--gradient-red);
            color: white;
        }

        /* Strategies Table */
        .strategies-table {
            width: 100%;
            margin-top: 20px;
        }

        .strategies-table thead {
            background: var(--bg-secondary);
        }

        .strategies-table th {
            padding: 12px;
            text-align: left;
            font-size: 12px;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 600;
        }

        .strategies-table td {
            padding: 12px;
            border-top: 1px solid var(--glass-border);
            font-size: 14px;
        }

        .strategies-table tbody tr:hover {
            background: var(--bg-hover);
        }

        .status-badge {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
        }

        .status-badge.active {
            background: rgba(0, 255, 136, 0.2);
            color: var(--accent-green);
        }

        .status-badge.stopped {
            background: rgba(255, 51, 102, 0.2);
            color: var(--accent-red);
        }

        .status-badge.paused {
            background: rgba(255, 149, 0, 0.2);
            color: var(--accent-orange);
        }

        /* Live Positions */
        .position-card {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
            border: 1px solid var(--glass-border);
        }

        .position-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .position-symbol {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .position-pnl {
            font-size: 18px;
            font-weight: 700;
        }

        .position-pnl.profit {
            color: var(--accent-green);
        }

        .position-pnl.loss {
            color: var(--accent-red);
        }

        .position-details {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-top: 10px;
        }

        .position-detail {
            text-align: center;
        }

        .position-detail-label {
            font-size: 11px;
            color: var(--text-muted);
            text-transform: uppercase;
        }

        .position-detail-value {
            font-size: 14px;
            color: var(--text-primary);
            font-weight: 500;
            margin-top: 2px;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(10px);
            z-index: 99999;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex !important;
        }

        .modal-content {
            background: var(--bg-secondary);
            border-radius: 20px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            border: 1px solid var(--glass-border);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-title {
            font-size: 20px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .modal-close {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: var(--bg-hover);
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .modal-close:hover {
            background: var(--accent-red);
            color: white;
        }

        /* Loading */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid var(--glass-border);
            border-radius: 50%;
            border-top-color: var(--accent-blue);
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Alert */
        .alert {
            padding: 15px 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 12px;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                transform: translateX(-100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .alert-success {
            background: rgba(0, 255, 136, 0.1);
            border: 1px solid var(--accent-green);
            color: var(--accent-green);
        }

        .alert-error {
            background: rgba(255, 51, 102, 0.1);
            border: 1px solid var(--accent-red);
            color: var(--accent-red);
        }

        .alert-warning {
            background: rgba(255, 149, 0, 0.1);
            border: 1px solid var(--accent-orange);
            color: var(--accent-orange);
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div class="header-title">
                <h1><i class="fas fa-chart-line"></i> Trading Pro</h1>
                <div class="live-indicator">
                    <div class="live-dot"></div>
                    <span>LIVE</span>
                </div>
            </div>
            <div class="header-stats">
                <div class="stat-item">
                    <div class="stat-label">NIFTY</div>
                    <div class="stat-value" id="niftyValue">-</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">Mode <i class="fas fa-edit" style="font-size: 10px; opacity: 0.7;"></i></div>
                    <div class="stat-value" id="tradingMode" style="cursor: pointer; text-decoration: underline; transition: all 0.2s; padding: 5px 10px; border-radius: 5px;" onclick="showSettingsModal()" onmouseover="this.style.opacity='0.7'; this.style.backgroundColor='rgba(255,255,255,0.1)'" onmouseout="this.style.opacity='1'; this.style.backgroundColor='transparent'" title="Click to change trading mode">PAPER</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">Margin</div>
                    <div class="stat-value" id="availableMargin">₹0</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">Used</div>
                    <div class="stat-value" id="usedMargin">₹0</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">Today's P&L</div>
                    <div class="stat-value" id="todayPnl">₹0</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">Active</div>
                    <div class="stat-value" id="activeStrategies">0</div>
                </div>
            </div>
            <!-- Emergency Stop Button in Header -->
            <button class="btn btn-danger" style="background: #d32f2f; border: 2px solid #ff5252; padding: 8px 16px; font-weight: bold; font-size: 14px; white-space: nowrap;" onclick="emergencyStop()" title="Immediately stop all trading and close all positions">
                <i class="fas fa-exclamation-triangle"></i> EMERGENCY
            </button>
        </div>

        <!-- Alert Container -->
        <div id="alertContainer"></div>

        <!-- Main Grid -->
        <div class="main-grid">
            <!-- Left Column - Strategy Builder -->
            <div>
                <!-- Strategy Configuration -->
                <div class="glass-card">
                    <div class="card-header">
                        <div class="card-title">
                            <i class="fas fa-robot"></i>
                            Strategy Configuration
                        </div>
                    </div>

                    <!-- Strategy Name -->
                    <div class="form-section">
                        <div class="form-group">
                            <label>Strategy Name</label>
                            <input type="text" class="form-control" id="strategyName" placeholder="Enter strategy name">
                        </div>
                    </div>

                    <!-- Signal Selection -->
                    <div class="form-section">
                        <div class="section-label">
                            <i class="fas fa-signal"></i>
                            Signal Selection
                        </div>
                        <div class="signals-grid">
                            <div class="signal-card selected" data-signal="S1" onclick="toggleSignal('S1')">
                                <div class="signal-header">
                                    <span class="signal-name">S1: Bear Trap</span>
                                    <span class="signal-type bullish">Bullish</span>
                                </div>
                                <div class="signal-description">Sell PUT</div>
                            </div>
                            <div class="signal-card selected" data-signal="S2" onclick="toggleSignal('S2')">
                                <div class="signal-header">
                                    <span class="signal-name">S2: Support Hold</span>
                                    <span class="signal-type bullish">Bullish</span>
                                </div>
                                <div class="signal-description">Sell PUT</div>
                            </div>
                            <div class="signal-card selected" data-signal="S3" onclick="toggleSignal('S3')">
                                <div class="signal-header">
                                    <span class="signal-name">S3: Resistance Hold</span>
                                    <span class="signal-type bearish">Bearish</span>
                                </div>
                                <div class="signal-description">Sell CALL</div>
                            </div>
                            <div class="signal-card selected" data-signal="S4" onclick="toggleSignal('S4')">
                                <div class="signal-header">
                                    <span class="signal-name">S4: Bias Failure Bull</span>
                                    <span class="signal-type bullish">Bullish</span>
                                </div>
                                <div class="signal-description">Sell PUT</div>
                            </div>
                            <div class="signal-card selected" data-signal="S5" onclick="toggleSignal('S5')">
                                <div class="signal-header">
                                    <span class="signal-name">S5: Bias Failure Bear</span>
                                    <span class="signal-type bearish">Bearish</span>
                                </div>
                                <div class="signal-description">Sell CALL</div>
                            </div>
                            <div class="signal-card selected" data-signal="S6" onclick="toggleSignal('S6')">
                                <div class="signal-header">
                                    <span class="signal-name">S6: Weakness Confirmed</span>
                                    <span class="signal-type bearish">Bearish</span>
                                </div>
                                <div class="signal-description">Sell CALL</div>
                            </div>
                            <div class="signal-card selected" data-signal="S7" onclick="toggleSignal('S7')">
                                <div class="signal-header">
                                    <span class="signal-name">S7: Breakout Confirmed</span>
                                    <span class="signal-type bullish">Bullish</span>
                                </div>
                                <div class="signal-description">Sell PUT</div>
                            </div>
                            <div class="signal-card selected" data-signal="S8" onclick="toggleSignal('S8')">
                                <div class="signal-header">
                                    <span class="signal-name">S8: Breakdown Confirmed</span>
                                    <span class="signal-type bearish">Bearish</span>
                                </div>
                                <div class="signal-description">Sell CALL</div>
                            </div>
                        </div>
                    </div>

                    <!-- Position Configuration -->
                    <div class="form-section">
                        <div class="section-label">
                            <i class="fas fa-cog"></i>
                            Position Configuration
                        </div>
                        <div class="config-grid">
                            <div class="form-group">
                                <label>Instrument</label>
                                <select class="form-control" id="instrument">
                                    <option value="NIFTY">NIFTY</option>
                                    <option value="BANKNIFTY">BANKNIFTY</option>
                                    <option value="FINNIFTY">FINNIFTY</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Expiry</label>
                                <select class="form-control" id="expiry">
                                    <option value="current">Current Week</option>
                                    <option value="next">Next Week</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Strike Selection</label>
                                <select class="form-control" id="strikeSelection" onchange="updateStrikeInfo()">
                                    <option value="AUTO" selected>Auto (Per Signal)</option>
                                    <option value="ATM">ATM</option>
                                    <option value="OTM1">OTM 1</option>
                                    <option value="OTM2">OTM 2</option>
                                    <option value="ITM1">ITM 1</option>
                                </select>
                                <div id="strikeInfo" style="font-size: 11px; color: var(--accent-blue); margin-top: 5px;"></div>
                            </div>
                            <div class="form-group">
                                <label>Number of Lots</label>
                                <select class="form-control" id="numLots" onchange="calculateAmounts()">
                                    <option value="1">1 lot</option>
                                    <option value="5">5 lots</option>
                                    <option value="10" selected>10 lots</option>
                                    <option value="15">15 lots</option>
                                    <option value="20">20 lots</option>
                                    <option value="25">25 lots</option>
                                    <option value="30">30 lots</option>
                                </select>
                            </div>
                        </div>

                        <!-- Hedge Configuration -->
                        <div class="toggle-container">
                            <label class="toggle-switch">
                                <input type="checkbox" id="enableHedge" checked onchange="toggleHedge()">
                                <span class="toggle-slider"></span>
                            </label>
                            <span>Enable Hedge (1:1 Ratio)</span>
                        </div>
                        <div id="hedgeConfig" style="display: block;">
                            <div class="form-group">
                                <label>Hedge Offset (Points)</label>
                                <input type="number" class="form-control" id="hedgeOffset" value="200" placeholder="200">
                            </div>
                        </div>
                    </div>

                    <!-- Risk Management -->
                    <div class="form-section">
                        <div class="section-label">
                            <i class="fas fa-shield-alt"></i>
                            Risk Management
                        </div>
                        <div class="risk-grid">
                            <!-- Stop Loss -->
                            <div class="risk-card">
                                <div class="risk-header">
                                    <div class="risk-title">
                                        <div class="risk-icon stop-loss">
                                            <i class="fas fa-shield-alt"></i>
                                        </div>
                                        <span>Overall Stop Loss</span>
                                    </div>
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="enableStopLoss" onchange="toggleRisk('stopLoss')">
                                        <span class="toggle-slider"></span>
                                    </label>
                                </div>
                                <div class="risk-inputs" id="stopLossInputs">
                                    <div class="input-group">
                                        <div class="input-field">
                                            <label>Per Lot</label>
                                            <input type="number" id="stopLossPerLot" placeholder="0" oninput="calculateStopLoss()">
                                            <div class="value-display" id="stopLossPerDisplay"></div>
                                        </div>
                                        <div class="input-field">
                                            <label>Total</label>
                                            <input type="number" id="stopLossTotal" placeholder="0" readonly>
                                            <div class="value-display" id="stopLossTotalDisplay"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Target Profit -->
                            <div class="risk-card">
                                <div class="risk-header">
                                    <div class="risk-title">
                                        <div class="risk-icon target">
                                            <i class="fas fa-bullseye"></i>
                                        </div>
                                        <span>Overall Target Profit</span>
                                    </div>
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="enableTarget" onchange="toggleRisk('target')">
                                        <span class="toggle-slider"></span>
                                    </label>
                                </div>
                                <div class="risk-inputs" id="targetInputs">
                                    <div class="input-group">
                                        <div class="input-field">
                                            <label>Per Lot</label>
                                            <input type="number" id="targetPerLot" placeholder="0" oninput="calculateTarget()">
                                            <div class="value-display" id="targetPerDisplay"></div>
                                        </div>
                                        <div class="input-field">
                                            <label>Total</label>
                                            <input type="number" id="targetTotal" placeholder="0" readonly>
                                            <div class="value-display" id="targetTotalDisplay"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Trailing Profit -->
                            <div class="risk-card">
                                <div class="risk-header">
                                    <div class="risk-title">
                                        <div class="risk-icon trailing">
                                            <i class="fas fa-chart-line"></i>
                                        </div>
                                        <span>Trailing Profit</span>
                                    </div>
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="enableTrailing" onchange="toggleRisk('trailing')">
                                        <span class="toggle-slider"></span>
                                    </label>
                                </div>
                                <div class="risk-inputs" id="trailingInputs">
                                    <select class="trail-type-select" id="trailType" onchange="updateTrailFields()">
                                        <option value="lock">Lock Profit</option>
                                        <option value="locktrail">Lock & Trail</option>
                                    </select>
                                    <div class="input-group">
                                        <div class="input-field">
                                            <label>Trigger %</label>
                                            <input type="number" id="triggerPercent" placeholder="0" step="0.1" oninput="calculateTrailing()">
                                            <div class="value-display" id="triggerDisplay"></div>
                                        </div>
                                        <div class="input-field">
                                            <label>Lock %</label>
                                            <input type="number" id="lockPercent" placeholder="0" step="0.1" oninput="calculateTrailing()">
                                            <div class="value-display" id="lockDisplay"></div>
                                        </div>
                                        <div class="input-field" id="trailPercentField" style="display: none;">
                                            <label>Trail %</label>
                                            <input type="number" id="trailPercent" placeholder="0" step="0.1" oninput="calculateTrailing()">
                                            <div class="value-display" id="trailDisplay"></div>
                                        </div>
                                    </div>
                                    <div class="info-box">
                                        <i class="fas fa-info-circle"></i>
                                        <div class="info-text" id="trailDescription">
                                            When profit reaches trigger %, breakeven moves to lock %. If price reverses to lock %, positions close.
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div class="action-buttons">
                        <button class="btn btn-primary" onclick="addStrategy()">
                            <i class="fas fa-plus"></i>
                            Add Strategy
                        </button>
                        <button class="btn btn-warning" onclick="showBacktestModal()">
                            <i class="fas fa-chart-bar"></i>
                            Backtest
                        </button>
                        <button class="btn btn-secondary" onclick="showSettingsModal()">
                            <i class="fas fa-cog"></i>
                            Settings
                        </button>
                    </div>
                </div>

                <!-- Active Strategies -->
                <div class="glass-card">
                    <div class="card-header">
                        <div class="card-title">
                            <i class="fas fa-list"></i>
                            Active Strategies
                        </div>
                        <button class="btn btn-danger" onclick="stopAll()">
                            <i class="fas fa-stop"></i>
                            Stop All
                        </button>
                    </div>

                    <table class="strategies-table">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Signals</th>
                                <th>Lots</th>
                                <th>P&L</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="strategiesTableBody">
                            <tr>
                                <td colspan="6" style="text-align: center; color: var(--text-muted);">
                                    No active strategies
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Right Column - Live Data -->
            <div>
                <!-- Live Positions -->
                <div class="glass-card">
                    <div class="card-header">
                        <div class="card-title">
                            <i class="fas fa-chart-pie"></i>
                            Live Positions
                        </div>
                    </div>

                    <div id="positionsContainer">
                        <table style="width: 100%; color: var(--text-primary);">
                            <tbody id="positionsTableBody">
                                <tr>
                                    <td style="text-align: center; padding: 20px; color: var(--text-muted);">
                                        Loading positions...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Backtest Results -->
                <div class="glass-card" id="backtestResults" style="display: none;">
                    <div class="card-header">
                        <div class="card-title">
                            <i class="fas fa-chart-bar"></i>
                            Backtest Results
                        </div>
                    </div>
                    <div id="backtestContent"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Backtest Modal -->
    <div class="modal" id="backtestModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Backtest Configuration</h3>
                <button class="modal-close" onclick="closeBacktestModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="form-group">
                <label>From Date</label>
                <input type="text" class="form-control" id="backtestFromDate" placeholder="Select date">
            </div>
            <div class="form-group">
                <label>To Date</label>
                <input type="text" class="form-control" id="backtestToDate" placeholder="Select date">
            </div>
            <div class="action-buttons">
                <button class="btn btn-primary" onclick="runBacktest()">
                    <i class="fas fa-play"></i>
                    Run Backtest
                </button>
            </div>
        </div>
    </div>
    
    <!-- Settings Modal -->
    <div class="modal" id="settingsModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Trading Settings</h3>
                <button class="modal-close" onclick="closeSettingsModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="form-group">
                <label style="color: #ff3366; font-weight: 600;">⚠️ Trading Mode</label>
                <select class="form-control" id="tradingModeSelect" onchange="updateTradingMode()">
                    <option value="PAPER" selected>PAPER (Safe - No Real Money)</option>
                    <option value="LIVE">LIVE (Real Money - Caution!)</option>
                </select>
                <small style="color: var(--text-muted); display: block; margin-top: 5px;">LIVE mode will execute real trades with real money</small>
            </div>
            <div class="form-group">
                <label>Trading Capital (₹)</label>
                <input type="number" class="form-control" id="tradingCapitalInput" placeholder="100000" value="100000">
                <small style="color: var(--text-muted); display: block; margin-top: 5px;">Amount available for trading</small>
            </div>
            <div class="action-buttons">
                <button class="btn btn-primary" onclick="saveSettings()">
                    <i class="fas fa-save"></i>
                    Save Settings
                </button>
                <button class="btn btn-secondary" onclick="closeSettingsModal()">
                    Cancel
                </button>
            </div>
        </div>
    </div>

    <script>
        // ============ CONFIGURATION SECTION ============
        // Load settings from localStorage or use defaults
        window.TRADING_MODE = localStorage.getItem('TRADING_MODE') || "PAPER";
        window.TRADING_CAPITAL = parseInt(localStorage.getItem('TRADING_CAPITAL')) || 100000;
        // ============================================
        
        // Global variables
        let selectedSignals = new Set(['S1', 'S2', 'S3', 'S4', 'S5', 'S6', 'S7', 'S8']);
        let strategies = [];
        let strategyIdCounter = 1;
        
        // Make strategies accessible globally for debugging
        window.strategies = strategies;

        // Signal selection
        function toggleSignal(signal) {
            const card = document.querySelector(`[data-signal="${signal}"]`);
            if (selectedSignals.has(signal)) {
                selectedSignals.delete(signal);
                card.classList.remove('selected');
            } else {
                selectedSignals.add(signal);
                card.classList.add('selected');
            }
            updateStrikeInfo();
        }
        
        // Update strike info display
        function updateStrikeInfo() {
            const strikeSelection = document.getElementById('strikeSelection').value;
            const strikeInfoDiv = document.getElementById('strikeInfo');
            
            if (strikeSelection === 'AUTO' && selectedSignals.size > 0) {
                const strikeDetails = Array.from(selectedSignals).map(signal => {
                    const strike = getStrikeForSignal(signal);
                    return `${signal}: ${strike}`;
                }).join(', ');
                strikeInfoDiv.textContent = `Auto strikes: ${strikeDetails}`;
            } else if (strikeSelection === 'AUTO') {
                strikeInfoDiv.textContent = 'Select signals to see auto strike selection';
            } else {
                strikeInfoDiv.textContent = `All signals will use ${strikeSelection} strike`;
            }
        }

        // Toggle functions
        function toggleHedge() {
            const enabled = document.getElementById('enableHedge').checked;
            document.getElementById('hedgeConfig').style.display = enabled ? 'block' : 'none';
        }

        function toggleRisk(type) {
            const enabled = document.getElementById(`enable${type.charAt(0).toUpperCase() + type.slice(1)}`).checked;
            const inputs = document.getElementById(`${type}Inputs`);
            if (enabled) {
                inputs.classList.add('active');
            } else {
                inputs.classList.remove('active');
            }
        }

        // Trail type update
        function updateTrailFields() {
            const trailType = document.getElementById('trailType').value;
            const trailField = document.getElementById('trailPercentField');
            const description = document.getElementById('trailDescription');
            
            if (trailType === 'locktrail') {
                trailField.style.display = 'block';
                description.textContent = 'Locks profit at lock % when trigger % is reached, then trails stop loss by trail % for every trail % profit increase.';
            } else {
                trailField.style.display = 'none';
                description.textContent = 'When profit reaches trigger %, breakeven moves to lock %. If price reverses to lock %, positions close.';
            }
        }

        // Calculations
        function calculateAmounts() {
            calculateStopLoss();
            calculateTarget();
            calculateTrailing();
        }

        function calculateStopLoss() {
            const perLot = parseFloat(document.getElementById('stopLossPerLot').value) || 0;
            const lots = parseInt(document.getElementById('numLots').value) || 1;
            const total = perLot * lots;
            
            document.getElementById('stopLossTotal').value = total;
            document.getElementById('stopLossPerDisplay').textContent = perLot > 0 ? `₹${perLot.toLocaleString('en-IN')}` : '';
            document.getElementById('stopLossTotalDisplay').textContent = total > 0 ? `₹${total.toLocaleString('en-IN')}` : '';
        }

        function calculateTarget() {
            const perLot = parseFloat(document.getElementById('targetPerLot').value) || 0;
            const lots = parseInt(document.getElementById('numLots').value) || 1;
            const total = perLot * lots;
            
            document.getElementById('targetTotal').value = total;
            document.getElementById('targetPerDisplay').textContent = perLot > 0 ? `₹${perLot.toLocaleString('en-IN')}` : '';
            document.getElementById('targetTotalDisplay').textContent = total > 0 ? `₹${total.toLocaleString('en-IN')}` : '';
        }

        function calculateTrailing() {
            const triggerPercent = parseFloat(document.getElementById('triggerPercent').value) || 0;
            const lockPercent = parseFloat(document.getElementById('lockPercent').value) || 0;
            const trailPercent = parseFloat(document.getElementById('trailPercent').value) || 0;
            const lots = parseInt(document.getElementById('numLots').value) || 1;
            const estimatedMax = lots * 75 * 200; // Example calculation
            
            document.getElementById('triggerDisplay').textContent = triggerPercent > 0 ? 
                `Trigger at ₹${((estimatedMax * triggerPercent) / 100).toLocaleString('en-IN')}` : '';
            document.getElementById('lockDisplay').textContent = lockPercent > 0 ? 
                `Lock ₹${((estimatedMax * lockPercent) / 100).toLocaleString('en-IN')}` : '';
            document.getElementById('trailDisplay').textContent = trailPercent > 0 ? 
                `Trail ₹${((estimatedMax * trailPercent) / 100).toLocaleString('en-IN')}` : '';
        }

        // Get strike selection based on signal
        function getStrikeForSignal(signal) {
            // Signal-specific strike selection logic
            const signalStrikeMap = {
                'S1': 'ATM',    // Bear Trap (Bullish) - Usually ATM PUT
                'S2': 'OTM1',   // Support Hold (Bullish) - OTM PUT for safety
                'S3': 'OTM1',   // Resistance Hold (Bearish) - OTM CALL for safety
                'S4': 'ATM',    // Bias Failure Bull (Bullish) - ATM PUT
                'S5': 'ATM',    // Bias Failure Bear (Bearish) - ATM CALL
                'S6': 'OTM1',   // Weakness Confirmed (Bearish) - OTM CALL
                'S7': 'ATM',    // Breakout Confirmed (Bullish) - ATM PUT
                'S8': 'ATM'     // Breakdown Confirmed (Bearish) - ATM CALL
            };
            return signalStrikeMap[signal] || 'ATM';
        }
        
        // Check available margin
        async function checkMargin(requiredLots) {
            // Skip margin check in PAPER mode
            if (window.TRADING_MODE === 'PAPER') {
                return true;
            }
            
            try {
                const response = await fetch(`${API_BASE}/kite/margin`);
                if (response.ok) {
                    const data = await response.json();
                    const availableMargin = data.equity?.available?.live_balance || 0;
                    
                    // Estimate required margin (rough calculation)
                    // Assuming ~15000 per lot for selling options with hedge
                    const requiredMargin = requiredLots * 15000;
                    
                    if (availableMargin < requiredMargin) {
                        showAlert(`❌ Insufficient margin. Required: ₹${requiredMargin.toLocaleString()}, Available: ₹${availableMargin.toLocaleString()}`, 'error');
                        return false;
                    }
                    return true;
                } else {
                    // If margin check fails, allow in PAPER mode
                    console.warn('Margin check failed, continuing anyway');
                    return true;
                }
            } catch (error) {
                console.error('Failed to check margin:', error);
                // Continue anyway in case of error
                return true;
            }
        }
        
        // Add strategy
        async function addStrategy() {
            const name = document.getElementById('strategyName').value || `Strategy ${strategyIdCounter}`;
            const signals = Array.from(selectedSignals);
            
            if (signals.length === 0) {
                showAlert('Please select at least one signal', 'error');
                return;
            }
            
            // Check market hours before adding strategy
            const marketStatus = isMarketOpen();
            if (!marketStatus.open) {
                if (!confirm(`${marketStatus.reason}. Do you still want to add the strategy?`)) {
                    return;
                }
            }
            
            // Check margin only in LIVE mode
            const lots = parseInt(document.getElementById('numLots').value) || 10;
            if (window.TRADING_MODE === 'LIVE') {
                const hasMargin = await checkMargin(lots);
                if (!hasMargin) {
                    return;
                }
            }
            
            const strikeSelection = document.getElementById('strikeSelection').value;
            
            const strategy = {
                id: strategyIdCounter++,
                name: name,
                signals: signals,
                instrument: document.getElementById('instrument').value,
                expiry: document.getElementById('expiry').value,
                strikeSelection: strikeSelection,
                lots: parseInt(document.getElementById('numLots').value) || 10,
                hedgeEnabled: document.getElementById('enableHedge').checked,
                hedgeOffset: parseInt(document.getElementById('hedgeOffset').value) || 200,
                stopLossEnabled: document.getElementById('enableStopLoss').checked,
                stopLossPerLot: parseFloat(document.getElementById('stopLossPerLot').value) || 0,
                targetEnabled: document.getElementById('enableTarget').checked,
                targetPerLot: parseFloat(document.getElementById('targetPerLot').value) || 0,
                trailingEnabled: document.getElementById('enableTrailing').checked,
                trailType: document.getElementById('trailType') ? document.getElementById('trailType').value : 'lock',
                triggerPercent: parseFloat(document.getElementById('triggerPercent').value) || 0,
                lockPercent: parseFloat(document.getElementById('lockPercent').value) || 0,
                trailPercent: parseFloat(document.getElementById('trailPercent').value) || 0,
                status: 'active',
                pnl: 0
            };
            
            // Start live trading if configured
            try {
                // Prepare strike selection for each signal
                const signalConfigs = signals.map(signal => ({
                    signal: signal,
                    strike: strikeSelection === 'AUTO' ? getStrikeForSignal(signal) : strikeSelection
                }));
                
                // Show loading state
                const addBtn = document.querySelector('.btn-primary');
                const originalText = addBtn ? addBtn.textContent : '';
                if (addBtn) {
                    addBtn.disabled = true;
                    addBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Starting...';
                }
                
                const response = await fetch(`${API_BASE}/live-trading/start`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        signals: signals,
                        signal_configs: signalConfigs,
                        strike_selection: strikeSelection,
                        lots: strategy.lots,
                        hedge_enabled: strategy.hedgeEnabled,
                        hedge_offset: strategy.hedgeOffset,
                        stop_loss: strategy.stopLossEnabled ? strategy.stopLossPerLot * strategy.lots : null,
                        target_profit: strategy.targetEnabled ? strategy.targetPerLot * strategy.lots : null,
                        active_signals: signals,
                        capital: window.TRADING_CAPITAL || 100000,  // Default 1 lakh, can be configured
                        mode: window.TRADING_MODE || "PAPER"  // Default PAPER mode for safety
                    })
                });
                
                // Restore button state
                if (addBtn) {
                    addBtn.disabled = false;
                    addBtn.textContent = originalText;
                }
                
                if (response.ok) {
                    const result = await response.json();
                    if (result.status === 'success') {
                        strategy.sessionId = result.session_id || result.timestamp;
                        showAlert('✅ Live trading started successfully', 'success');
                    } else {
                        showAlert(`⚠️ ${result.message || 'Failed to start trading'}`, 'warning');
                    }
                } else {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.message || `Server error: ${response.status}`);
                }
            } catch (error) {
                console.error('Failed to start live trading:', error);
                showAlert(`❌ Failed to start trading: ${error.message}`, 'error');
                // Don't return here - still add to local strategies for tracking
            }
            
            strategies.push(strategy);
            window.strategies = strategies; // Keep window.strategies in sync
            updateStrategiesTable();
            showAlert('Strategy added successfully', 'success');
            resetForm();
        }
        window.addStrategy = addStrategy; // Make available globally

        // Update strategies table
        window.updateStrategiesTable = function updateStrategiesTable() {
            const tbody = document.getElementById('strategiesTableBody');
            // Use window.strategies to ensure we're using the global array
            const currentStrategies = window.strategies || strategies || [];
            
            if (currentStrategies.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: var(--text-muted);">No active strategies</td></tr>';
            } else {
                tbody.innerHTML = currentStrategies.map(strategy => `
                    <tr>
                        <td>${strategy.name}</td>
                        <td>${strategy.signals ? strategy.signals.join(', ') : ''}</td>
                        <td>${strategy.lots || 0}</td>
                        <td class="${strategy.pnl >= 0 ? 'positive' : 'negative'}">
                            ${strategy.pnl >= 0 ? '+' : ''}₹${Math.abs(strategy.pnl || 0).toLocaleString('en-IN')}
                        </td>
                        <td><span class="status-badge ${strategy.status}">${strategy.status}</span></td>
                        <td>
                            <button class="btn btn-danger" onclick="stopStrategy(${strategy.id})">
                                <i class="fas fa-stop"></i>
                            </button>
                        </td>
                    </tr>
                `).join('');
            }
            
            // Update active strategies count in header
            const activeStrategiesCount = currentStrategies.filter(s => s.status === 'active').length;
            const activeElement = document.getElementById('activeStrategies');
            if (activeElement) {
                activeElement.textContent = activeStrategiesCount;
            }
            // Also update old ID for compatibility
            const oldActiveElement = document.getElementById('activeCount');
            if (oldActiveElement) {
                oldActiveElement.textContent = activeStrategiesCount;
            }
        }

        // Stop strategy
        function stopStrategy(id) {
            strategies = strategies.filter(s => s.id !== id);
            updateStrategiesTable();
            showAlert('Strategy stopped', 'warning');
        }

        // Stop all
        function stopAll() {
            strategies = [];
            updateStrategiesTable();
            showAlert('All strategies stopped', 'warning');
        }
        
        // Emergency stop - immediately stop all trading and close all positions
        async function emergencyStop() {
            if (!confirm('⚠️ EMERGENCY STOP: This will immediately stop all trading and close ALL positions. Are you sure?')) {
                return;
            }
            
            showAlert('🚨 EMERGENCY STOP INITIATED - Closing all positions...', 'error');
            
            try {
                // Call emergency stop endpoint
                const response = await fetch(`${API_BASE}/live-trading/emergency-stop`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        reason: 'User initiated emergency stop',
                        close_all_positions: true
                    })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    
                    // Clear all local strategies
                    strategies = [];
                    updateStrategiesTable();
                    
                    // Clear positions display
                    const container = document.getElementById('positionsContainer');
                    if (container) {
                        container.innerHTML = '<div style="text-align: center; padding: 20px; color: var(--text-muted);">All positions closed</div>';
                    }
                    
                    showAlert(`✅ EMERGENCY STOP COMPLETE: ${result.message || 'All trading stopped and positions closed'}`, 'success');
                    
                    // Optionally reload the page after a delay
                    setTimeout(() => {
                        if (confirm('Emergency stop complete. Reload the page?')) {
                            window.location.reload();
                        }
                    }, 3000);
                } else {
                    throw new Error('Failed to execute emergency stop');
                }
            } catch (error) {
                console.error('Emergency stop error:', error);
                showAlert(`❌ EMERGENCY STOP FAILED: ${error.message}. Please manually close all positions!`, 'error');
                
                // Still clear local state
                strategies = [];
                updateStrategiesTable();
            }
        }

        // Reset form
        function resetForm() {
            document.getElementById('strategyName').value = '';
            selectedSignals.clear();
            document.querySelectorAll('.signal-card').forEach(card => {
                card.classList.remove('selected');
            });
            document.getElementById('enableHedge').checked = false;
            document.getElementById('enableStopLoss').checked = false;
            document.getElementById('enableTarget').checked = false;
            document.getElementById('enableTrailing').checked = false;
            toggleHedge();
            toggleRisk('stopLoss');
            toggleRisk('target');
            toggleRisk('trailing');
        }

        // Backtest modal
        function showBacktestModal() {
            document.getElementById('backtestModal').classList.add('active');
            
            // Initialize date pickers
            flatpickr('#backtestFromDate', {
                dateFormat: 'Y-m-d',
                theme: 'dark'
            });
            
            flatpickr('#backtestToDate', {
                dateFormat: 'Y-m-d',
                theme: 'dark'
            });
        }

        function closeBacktestModal() {
            document.getElementById('backtestModal').classList.remove('active');
        }

        // Run backtest
        async function runBacktest() {
            const fromDate = document.getElementById('backtestFromDate').value;
            const toDate = document.getElementById('backtestToDate').value;
            
            if (!fromDate || !toDate) {
                showAlert('Please select date range', 'error');
                return;
            }
            
            const signals = Array.from(selectedSignals);
            if (signals.length === 0) {
                showAlert('Please select at least one signal for backtest', 'error');
                return;
            }
            
            showAlert('Running backtest...', 'success');
            closeBacktestModal();
            
            // Show loading
            const resultsDiv = document.getElementById('backtestResults');
            resultsDiv.style.display = 'block';
            document.getElementById('backtestContent').innerHTML = '<div class="loading"></div> Running backtest...';
            
            try {
                const response = await fetch(`${API_BASE}/backtest`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        from_date: fromDate,
                        to_date: toDate,
                        signals_to_test: signals,
                        lots: parseInt(document.getElementById('numLots').value) || 10,
                        hedge_enabled: document.getElementById('enableHedge').checked,
                        hedge_offset: parseInt(document.getElementById('hedgeOffset').value) || 200
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                
                // Display results
                const totalTrades = data.summary?.total_trades || 0;
                const winRate = data.summary?.win_rate || 0;
                const totalPnl = data.summary?.total_pnl || 0;
                const totalReturn = data.summary?.total_return || 0;
                
                document.getElementById('backtestContent').innerHTML = `
                    <div class="position-card">
                        <div class="position-header">
                            <span>Total Trades</span>
                            <span>${totalTrades}</span>
                        </div>
                    </div>
                    <div class="position-card">
                        <div class="position-header">
                            <span>Win Rate</span>
                            <span class="position-pnl ${winRate >= 50 ? 'profit' : 'loss'}">${winRate.toFixed(1)}%</span>
                        </div>
                    </div>
                    <div class="position-card">
                        <div class="position-header">
                            <span>Total P&L</span>
                            <span class="position-pnl ${totalPnl >= 0 ? 'profit' : 'loss'}">
                                ${totalPnl >= 0 ? '+' : ''}₹${Math.abs(totalPnl).toLocaleString('en-IN')}
                            </span>
                        </div>
                    </div>
                    <div class="position-card">
                        <div class="position-header">
                            <span>Return %</span>
                            <span class="position-pnl ${totalReturn >= 0 ? 'profit' : 'loss'}">
                                ${totalReturn >= 0 ? '+' : ''}${totalReturn.toFixed(2)}%
                            </span>
                        </div>
                    </div>
                `;
                
                // Show detailed trades if available
                if (data.trades && data.trades.length > 0) {
                    const tradesHtml = data.trades.slice(0, 5).map(trade => `
                        <div class="position-card" style="margin-top: 10px;">
                            <div class="position-header">
                                <span>${trade.signal} - ${new Date(trade.entry_time).toLocaleDateString()}</span>
                                <span class="position-pnl ${trade.pnl >= 0 ? 'profit' : 'loss'}">
                                    ${trade.pnl >= 0 ? '+' : ''}₹${Math.abs(trade.pnl).toLocaleString('en-IN')}
                                </span>
                            </div>
                        </div>
                    `).join('');
                    
                    document.getElementById('backtestContent').innerHTML += `
                        <div style="margin-top: 20px;">
                            <h4 style="color: var(--text-secondary); margin-bottom: 10px;">Recent Trades</h4>
                            ${tradesHtml}
                        </div>
                    `;
                }
                
            } catch (error) {
                console.error('Backtest error:', error);
                document.getElementById('backtestContent').innerHTML = `
                    <div class="alert alert-error">
                        <i class="fas fa-exclamation-circle"></i>
                        Failed to run backtest: ${error.message}
                    </div>
                `;
            }
        }

        // Settings modal functions - make them globally accessible
        window.showSettingsModal = function() {
            console.log('Opening settings modal...');
            const modal = document.getElementById('settingsModal');
            if (!modal) {
                console.error('Settings modal not found!');
                return;
            }
            
            // Load current settings into modal
            document.getElementById('tradingModeSelect').value = window.TRADING_MODE;
            document.getElementById('tradingCapitalInput').value = window.TRADING_CAPITAL;
            
            modal.classList.add('active');
            console.log('Settings modal should be visible now');
        }
        
        window.closeSettingsModal = function() {
            document.getElementById('settingsModal').classList.remove('active');
        }
        
        window.updateTradingMode = function() {
            const mode = document.getElementById('tradingModeSelect').value;
            if (mode === 'LIVE') {
                if (!confirm('⚠️ WARNING: Switching to LIVE mode will execute real trades with real money. Are you absolutely sure?')) {
                    document.getElementById('tradingModeSelect').value = 'PAPER';
                    return;
                }
            }
        }
        
        window.saveSettings = function() {
            const newMode = document.getElementById('tradingModeSelect').value;
            const newCapital = parseInt(document.getElementById('tradingCapitalInput').value) || 100000;
            
            // Double confirm for LIVE mode
            if (newMode === 'LIVE' && window.TRADING_MODE !== 'LIVE') {
                if (!confirm('⚠️ FINAL WARNING: You are switching to LIVE trading mode. This will use REAL MONEY. Continue?')) {
                    return;
                }
            }
            
            // Update global settings
            window.TRADING_MODE = newMode;
            window.TRADING_CAPITAL = newCapital;
            
            // Update mode display using the new function
            updateTradingModeDisplay();
            
            // Save to localStorage for persistence
            localStorage.setItem('TRADING_MODE', window.TRADING_MODE);
            localStorage.setItem('TRADING_CAPITAL', window.TRADING_CAPITAL);
            
            showAlert(`Settings saved! Mode: ${window.TRADING_MODE}, Capital: ₹${window.TRADING_CAPITAL.toLocaleString()}`, 'success');
            closeSettingsModal();
            
            // Restart refresh intervals with new settings
            location.reload(); // Reload to apply all settings
        }
        
        // Save template
        function saveTemplate() {
            showAlert('Template saved successfully', 'success');
        }

        // Show alert
        function showAlert(message, type) {
            const alertContainer = document.getElementById('alertContainer');
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.innerHTML = `
                <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'exclamation-triangle'}"></i>
                ${message}
            `;
            alertContainer.appendChild(alert);
            
            setTimeout(() => {
                alert.remove();
            }, 3000);
        }

        // WebSocket connection for real-time NIFTY data
        let niftyWebSocket = null;
        let reconnectInterval = null;
        let lastNiftyPrice = 0;
        
        function connectNiftyWebSocket() {
            // Connect to WebSocket for real-time data (market, positions, P&L, margin)
            try {
                niftyWebSocket = new WebSocket(`ws://${window.location.host}/ws/market`);
                
                niftyWebSocket.onopen = function() {
                    console.log('WebSocket connected for real-time data');
                    // Subscribe to all data types
                    niftyWebSocket.send(JSON.stringify({
                        type: 'subscribe',
                        channels: ['market', 'positions', 'pnl', 'margin']
                    }));
                };
                
                niftyWebSocket.onmessage = function(event) {
                    try {
                        const data = JSON.parse(event.data);
                        
                        // Handle different data types
                        switch(data.type) {
                            case 'market':
                                if (data.symbol === 'NIFTY' && data.ltp) {
                                    updateNiftyPrice(data.ltp);
                                    lastNiftyPrice = data.ltp;
                                }
                                break;
                                
                            case 'positions':
                                updatePositions(data.positions || []);
                                break;
                                
                            case 'pnl':
                                updatePnL(data.pnl || 0);
                                break;
                                
                            case 'margin':
                                updateMarginDisplay(data);
                                if (data.balance) updateBalance(data.balance);
                                break;
                                
                            default:
                                // Legacy format support
                                if (data.symbol === 'NIFTY' && data.ltp) {
                                    updateNiftyPrice(data.ltp);
                                    lastNiftyPrice = data.ltp;
                                }
                        }
                    } catch (e) {
                        console.error('Error parsing WebSocket data:', e);
                    }
                };
                
                niftyWebSocket.onerror = function(error) {
                    console.error('WebSocket error:', error);
                };
                
                niftyWebSocket.onclose = function() {
                    console.log('WebSocket disconnected, will reconnect...');
                    // Reconnect after 5 seconds
                    if (!reconnectInterval) {
                        reconnectInterval = setTimeout(() => {
                            reconnectInterval = null;
                            connectNiftyWebSocket();
                        }, 5000);
                    }
                };
            } catch (error) {
                console.error('Failed to connect WebSocket:', error);
                // Fall back to showing static data
                showStaticNiftyData();
            }
        }
        
        function updateNiftyPrice(price) {
            const niftyValue = document.getElementById('niftyValue');
            if (niftyValue) {
                const change = lastNiftyPrice ? price - lastNiftyPrice : 0;
                niftyValue.textContent = price.toFixed(2);
                niftyValue.className = `stat-value ${change >= 0 ? 'positive' : 'negative'}`;
                if (change !== 0) {
                    niftyValue.title = `Change: ${change >= 0 ? '+' : ''}${change.toFixed(2)}`;
                }
            }
        }
        
        function showStaticNiftyData() {
            const niftyValue = document.getElementById('niftyValue');
            if (niftyValue) {
                const now = new Date();
                const hour = now.getHours();
                const day = now.getDay();
                
                if (day === 0 || day === 6) {
                    niftyValue.textContent = 'Weekend';
                    niftyValue.className = 'stat-value';
                } else if (hour < 9 || hour >= 16) {
                    niftyValue.textContent = 'Closed';
                    niftyValue.className = 'stat-value';
                } else {
                    // Fetch real data from Breeze API instead of showing dummy value
                    fetchRealNiftyPrice();
                }
            }
        }
        
        // Fetch real NIFTY price from Breeze API
        async function fetchRealNiftyPrice() {
            try {
                console.log('Fetching real NIFTY price from Breeze API...');
                const response = await fetch(`${API_BASE}/option-chain/fast?symbol=NIFTY&strikes=1`);
                if (response.ok) {
                    const data = await response.json();
                    if (data.status === 'success' && data.data?.spot_price) {
                        const spotPrice = data.data.spot_price;
                        const niftyValue = document.querySelector('.stat-value');
                        if (niftyValue) {
                            niftyValue.textContent = spotPrice.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ',');
                            niftyValue.className = 'stat-value success';
                            niftyValue.title = `Real-time from ${data.data.source || 'BREEZE_REAL'}`;
                            console.log('NIFTY price updated from Breeze API:', spotPrice);
                        }
                    }
                }
            } catch (error) {
                console.error('Error fetching NIFTY price:', error);
                const niftyValue = document.querySelector('.stat-value');
                if (niftyValue) {
                    niftyValue.textContent = 'API Error';
                    niftyValue.className = 'stat-value danger';
                }
            }
        }
        
        // Keep fetchMarketData as fallback
        async function fetchMarketData() {
            // This is now just a fallback if WebSocket fails
            if (!niftyWebSocket || niftyWebSocket.readyState !== WebSocket.OPEN) {
                showStaticNiftyData();
            }
        }
        
        // Fetch live positions
        async function fetchLivePositions() {
            try {
                const response = await fetch(`${API_BASE}/live-trading/positions`);
                if (response.ok) {
                    const data = await response.json();
                    // Handle both direct array and object with positions property
                    const positions = Array.isArray(data) ? data : (data.positions || []);
                    updatePositionsDisplay(positions);
                }
            } catch (error) {
                console.error('Failed to fetch positions:', error);
            }
        }
        
        // Update positions display
        function updatePositionsDisplay(positions) {
            const container = document.getElementById('positionsContainer');
            if (!container) return;
            
            if (!positions || positions.length === 0) {
                container.innerHTML = '<div style="text-align: center; padding: 20px; color: var(--text-muted);">No active positions</div>';
                return;
            }
            
            container.innerHTML = positions.map(pos => {
                const pnl = pos.unrealized_pnl || pos.pnl || 0;
                const symbol = pos.symbol || pos.trading_symbol || 'Unknown';
                const qty = pos.quantity || pos.qty || 0;
                const avgPrice = pos.average_price || pos.buy_price || 0;
                const ltp = pos.ltp || pos.last_price || 0;
                
                return `
                    <div class="position-card">
                        <div class="position-header">
                            <span class="position-symbol">${symbol}</span>
                            <span class="position-pnl ${pnl >= 0 ? 'profit' : 'loss'}">
                                ${pnl >= 0 ? '+' : ''}₹${Math.abs(pnl).toLocaleString('en-IN')}
                            </span>
                        </div>
                        <div class="position-details">
                            <div class="position-detail">
                                <div class="position-detail-label">Qty</div>
                                <div class="position-detail-value">${qty}</div>
                            </div>
                            <div class="position-detail">
                                <div class="position-detail-label">Avg</div>
                                <div class="position-detail-value">₹${avgPrice.toFixed(2)}</div>
                            </div>
                            <div class="position-detail">
                                <div class="position-detail-label">LTP</div>
                                <div class="position-detail-value">₹${ltp.toFixed(2)}</div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            // Update total P&L in header
            const totalPnl = positions.reduce((sum, pos) => sum + (pos.unrealized_pnl || 0), 0);
            const pnlElement = document.getElementById('todayPnl');
            if (pnlElement) {
                pnlElement.textContent = `${totalPnl >= 0 ? '+' : ''}₹${Math.abs(totalPnl).toLocaleString('en-IN')}`;
                pnlElement.className = `stat-value ${totalPnl >= 0 ? 'positive' : 'negative'}`;
            }
            
            // Update active positions count
            const activeElement = document.getElementById('activeCount');
            if (activeElement) {
                activeElement.textContent = positions.length;
            }
        }
        
        // Close position
        async function closePosition(symbol, quantity) {
            if (!confirm(`Close position for ${symbol}?`)) return;
            
            try {
                const response = await fetch(`${API_BASE}/live-trading/close-position`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        symbol: symbol,
                        quantity: quantity
                    })
                });
                
                if (response.ok) {
                    showAlert('Position closed successfully', 'success');
                    fetchLivePositions(); // Refresh positions
                } else {
                    showAlert('Failed to close position', 'error');
                }
            } catch (error) {
                console.error('Failed to close position:', error);
                showAlert('Error closing position', 'error');
            }
        }
        
        // Stop strategy
        async function stopStrategy(id) {
            const strategy = strategies.find(s => s.id === id);
            if (!strategy) return;
            
            if (strategy.sessionId) {
                try {
                    await fetch(`${API_BASE}/live-trading/stop`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            session_id: strategy.sessionId
                        })
                    });
                } catch (error) {
                    console.error('Failed to stop live trading:', error);
                }
            }
            
            strategies = strategies.filter(s => s.id !== id);
            updateStrategiesTable();
            showAlert('Strategy stopped', 'warning');
        }
        
        // Check broker authentication status
        async function checkAuthStatus(showLoginPrompt = false) {
            try {
                // First try the token validation endpoint which is more reliable
                const tokenResponse = await fetch(`${API_BASE}/auth/kite/validate-token`);
                if (tokenResponse.ok) {
                    const tokenData = await tokenResponse.json();
                    if (tokenData.is_valid) {
                        // Token is valid, we're authenticated
                        updateBrokerStatus('KITE');
                        // Try to get balance from live auth status
                        try {
                            const statusResponse = await fetch(`${API_BASE}/live/auth/status`);
                            if (statusResponse.ok) {
                                const statusData = await statusResponse.json();
                                if (statusData.balance !== undefined) {
                                    updateBalance(statusData.balance);
                                }
                            }
                        } catch (e) {
                            console.log('Could not fetch balance:', e);
                        }
                        return true;
                    }
                }
                
                // If token validation failed or returned invalid, check live auth status as fallback
                const response = await fetch(`${API_BASE}/live/auth/status`);
                if (response.ok) {
                    const data = await response.json();
                    // Check for authenticated field
                    if (!data.authenticated && !data.is_authenticated) {
                        // Update status to show disconnected
                        updateBrokerStatus('DISCONNECTED');
                        if (showLoginPrompt) {
                            // Show custom login modal
                            showBrokerLoginModal();
                        }
                        return false;
                    }
                    // Update broker status in header to show connected
                    updateBrokerStatus('KITE');
                    // Update balance if available
                    if (data.balance !== undefined) {
                        updateBalance(data.balance);
                    }
                    return true;
                }
            } catch (error) {
                console.error('Failed to check auth status:', error);
                updateBrokerStatus('ERROR');
                return false;
            }
        }
        
        // Update broker status in header
        function updateBrokerStatus(status) {
            // Add a broker status to the header if it doesn't exist
            let brokerStat = document.getElementById('brokerStatus');
            if (!brokerStat) {
                // Create broker status element in header
                const headerStats = document.querySelector('.header-stats');
                if (headerStats) {
                    const brokerDiv = document.createElement('div');
                    brokerDiv.className = 'stat-item';
                    brokerDiv.innerHTML = `
                        <div class="stat-label">Broker</div>
                        <div class="stat-value" id="brokerStatus">-</div>
                    `;
                    headerStats.appendChild(brokerDiv);
                    brokerStat = document.getElementById('brokerStatus');
                }
            }
            
            if (brokerStat) {
                brokerStat.textContent = status;
                // Set color based on status
                if (status === 'KITE' || status === 'CONNECTED') {
                    brokerStat.style.color = '#00ff88'; // Green for connected
                    brokerStat.classList.add('positive');
                    brokerStat.classList.remove('negative');
                } else if (status === 'DISCONNECTED' || status === 'ERROR') {
                    brokerStat.style.color = '#ff3366'; // Red for disconnected
                    brokerStat.classList.add('negative');
                    brokerStat.classList.remove('positive');
                } else {
                    brokerStat.style.color = '#ffa726'; // Orange for unknown
                }
            }
        }
        
        // Fetch and update margin details
        async function fetchMarginDetails() {
            try {
                // Try the live/funds endpoint which is more standard
                const response = await fetch(`${API_BASE}/live/funds`);
                if (response.ok) {
                    const data = await response.json();
                    console.log('Funds data received:', data);
                    
                    // Convert to margin display format
                    const marginData = {
                        available: {
                            live_balance: data.available_margin || data.available_cash || 0,
                            cash: data.available_cash || 0
                        },
                        utilised: {
                            span: data.span || 0,
                            exposure: data.exposure || 0,
                            m2m_realised: data.pnl || 0
                        },
                        pnl: data.pnl || 0
                    };
                    
                    updateMarginDisplay(marginData);
                    
                    // Also update balance if available
                    if (data.available_margin > 0) {
                        updateBalance(data.available_margin);
                    }
                } else {
                    // Fallback to kite/margin endpoint
                    const kiteResponse = await fetch(`${API_BASE}/kite/margin`);
                    if (kiteResponse.ok) {
                        const data = await kiteResponse.json();
                        updateMarginDisplay(data);
                    }
                }
            } catch (error) {
                console.log('Could not fetch margin details:', error);
            }
        }
        
        // Update margin display in header
        function updateMarginDisplay(marginData) {
            if (!marginData) return;
            
            // Extract real values from Kite margin response
            let availableAmount = 0;
            let usedAmount = 0;
            let pnlAmount = 0;
            
            // Handle different response formats from /kite/margin
            if (marginData.available) {
                // Direct format from /kite/margin
                availableAmount = marginData.available.live_balance || marginData.available.cash || 0;
                if (marginData.utilised) {
                    usedAmount = (marginData.utilised.span || 0) + (marginData.utilised.exposure || 0);
                    pnlAmount = marginData.utilised.m2m_realised || 0;
                }
            } else if (marginData.equity) {
                // Full margin format with equity
                availableAmount = marginData.equity.available?.live_balance || marginData.equity.available?.cash || 0;
                usedAmount = (marginData.equity.utilised?.span || 0) + (marginData.equity.utilised?.exposure || 0);
                pnlAmount = marginData.equity.utilised?.m2m_realised || 0;
            } else if (marginData.available_margin !== undefined) {
                // Simplified format (fallback)
                availableAmount = marginData.available_margin;
                usedAmount = marginData.used_margin || 0;
                pnlAmount = marginData.pnl || 0;
            }
            
            console.log('Margin data received:', { availableAmount, usedAmount, pnlAmount });
            
            const availableMargin = document.getElementById('availableMargin');
            const usedMargin = document.getElementById('usedMargin');
            
            if (availableMargin) {
                availableMargin.textContent = new Intl.NumberFormat('en-IN', {
                    style: 'currency',
                    currency: 'INR',
                    minimumFractionDigits: 0,
                    maximumFractionDigits: 0
                }).format(availableAmount);
                
                availableMargin.className = availableAmount > 0 ? 'stat-value positive' : 'stat-value';
            }
            
            if (usedMargin) {
                usedMargin.textContent = new Intl.NumberFormat('en-IN', {
                    style: 'currency',
                    currency: 'INR',
                    minimumFractionDigits: 0,
                    maximumFractionDigits: 0
                }).format(usedAmount);
                
                usedMargin.className = usedAmount > 0 ? 'stat-value negative' : 'stat-value';
            }
            
            // Update P&L if available
            if (pnlAmount !== 0 || marginData.pnl !== undefined) {
                const todayPnl = document.getElementById('todayPnl');
                if (todayPnl) {
                    const finalPnl = pnlAmount || marginData.pnl || 0;
                    todayPnl.textContent = new Intl.NumberFormat('en-IN', {
                        style: 'currency',
                        currency: 'INR',
                        minimumFractionDigits: 0,
                        maximumFractionDigits: 0
                    }).format(finalPnl);
                    
                    todayPnl.className = finalPnl >= 0 ? 'stat-value positive' : 'stat-value negative';
                }
            }
        }
        
        // Update P&L via WebSocket
        function updatePnL(pnl) {
            const todayPnl = document.getElementById('todayPnl');
            if (todayPnl) {
                todayPnl.textContent = new Intl.NumberFormat('en-IN', {
                    style: 'currency',
                    currency: 'INR',
                    minimumFractionDigits: 0,
                    maximumFractionDigits: 0
                }).format(pnl || 0);
                
                todayPnl.className = pnl >= 0 ? 'stat-value positive' : 'stat-value negative';
            }
        }
        
        // Update positions via WebSocket
        function updatePositions(positions) {
            const container = document.getElementById('livePositionsContainer');
            if (!container) return;
            
            if (!positions || positions.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-inbox" style="font-size: 48px; color: var(--text-muted); margin-bottom: 15px;"></i>
                        <p style="color: var(--text-muted); font-size: 14px;">No open positions</p>
                    </div>
                `;
                return;
            }
            
            // Display positions
            container.innerHTML = positions.map(pos => `
                <div class="position-card">
                    <div class="position-header">
                        <span class="position-symbol">${pos.tradingsymbol || pos.symbol}</span>
                        <span class="position-type ${pos.pnl >= 0 ? 'profit' : 'loss'}">
                            ${pos.pnl >= 0 ? '▲' : '▼'} ${Math.abs(pos.pnl).toFixed(2)}
                        </span>
                    </div>
                    <div class="position-details">
                        <div class="detail-row">
                            <span>Qty: ${pos.quantity}</span>
                            <span>Avg: ₹${pos.average_price || 0}</span>
                        </div>
                        <div class="detail-row">
                            <span>LTP: ₹${pos.last_price || 0}</span>
                            <span class="${pos.pnl >= 0 ? 'profit' : 'loss'}">
                                P&L: ₹${pos.pnl || 0}
                            </span>
                        </div>
                    </div>
                </div>
            `).join('');
        }
        
        // Update balance in header
        function updateBalance(balance) {
            let balanceStat = document.getElementById('balanceValue');
            if (!balanceStat) {
                // Create balance element if it doesn't exist
                const headerStats = document.querySelector('.header-stats');
                if (headerStats) {
                    const balanceDiv = document.createElement('div');
                    balanceDiv.className = 'stat-item';
                    balanceDiv.innerHTML = `
                        <div class="stat-label">Balance</div>
                        <div class="stat-value" id="balanceValue">₹0</div>
                    `;
                    headerStats.appendChild(balanceDiv);
                    balanceStat = document.getElementById('balanceValue');
                }
            }
            
            if (balanceStat) {
                const formattedBalance = new Intl.NumberFormat('en-IN', {
                    style: 'currency',
                    currency: 'INR',
                    minimumFractionDigits: 0,
                    maximumFractionDigits: 0
                }).format(balance);
                balanceStat.textContent = formattedBalance;
                
                // Set color based on balance
                if (balance > 0) {
                    balanceStat.classList.add('positive');
                    balanceStat.classList.remove('negative');
                } else if (balance < 0) {
                    balanceStat.classList.add('negative');
                    balanceStat.classList.remove('positive');
                }
            }
        }
        
        // Show broker login modal
        function showBrokerLoginModal() {
            const modal = document.getElementById('brokerLoginModal');
            if (modal) {
                modal.classList.add('active');
            } else {
                // Create modal if it doesn't exist
                createBrokerLoginModal();
            }
        }
        
        // Close broker login modal
        function closeBrokerLoginModal() {
            const modal = document.getElementById('brokerLoginModal');
            if (modal) {
                modal.classList.remove('active');
            }
        }
        
        // Handle broker login
        async function handleBrokerLogin() {
            try {
                closeBrokerLoginModal();
                showAlert('🔄 Initiating Kite login...', 'info');
                
                // Call the auto login API with headless mode
                const response = await fetch(`${API_BASE}/auth/auto-login/kite`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ headless: true })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    showAlert('✅ Kite login initiated. Please wait while authenticating...', 'success');
                    
                    // Check status periodically
                    let checkCount = 0;
                    const checkInterval = setInterval(async () => {
                        checkCount++;
                        const authenticated = await checkAuthStatus(false);
                        if (authenticated) {
                            clearInterval(checkInterval);
                            showAlert('✅ Kite broker connected successfully!', 'success');
                            // Update UI
                            updateBrokerStatus('KITE');
                        } else if (checkCount > 20) {  // Stop checking after ~30 seconds
                            clearInterval(checkInterval);
                            showAlert('⚠️ Login timeout. Please try again or check the login window.', 'warning');
                        }
                    }, 1500);  // Check every 1.5 seconds
                } else {
                    const errorData = await response.json();
                    showAlert(`❌ Failed to initiate login: ${errorData.detail || 'Unknown error'}`, 'error');
                }
            } catch (error) {
                console.error('Login failed:', error);
                showAlert('❌ Failed to initiate login. Please check if API is running.', 'error');
            }
        }
        
        // Create broker login modal dynamically
        function createBrokerLoginModal() {
            const modalHtml = `
                <div class="modal" id="brokerLoginModal">
                    <div class="modal-overlay" onclick="closeBrokerLoginModal()"></div>
                    <div class="modal-content" style="max-width: 500px;">
                        <h3 class="modal-title">Broker Authentication Required</h3>
                        <button class="modal-close" onclick="closeBrokerLoginModal()">×</button>
                        
                        <div style="padding: 20px; text-align: center;">
                            <div style="margin-bottom: 20px;">
                                <i class="fas fa-exclamation-triangle" style="font-size: 48px; color: #ffa726;"></i>
                            </div>
                            <h4 style="color: #fff; margin-bottom: 10px;">Kite Broker Not Connected</h4>
                            <p style="color: #999; margin-bottom: 30px;">
                                You need to authenticate with your broker to start trading.
                                Click the button below to login automatically.
                            </p>
                            
                            <div style="display: flex; gap: 15px; justify-content: center;">
                                <button class="btn btn-primary" onclick="handleBrokerLogin()" style="min-width: 150px;">
                                    <i class="fas fa-sign-in-alt"></i> Auto Login
                                </button>
                                <button class="btn btn-secondary" onclick="closeBrokerLoginModal()" style="min-width: 150px;">
                                    Cancel
                                </button>
                            </div>
                            
                            <p style="color: #666; font-size: 12px; margin-top: 20px;">
                                Note: Auto login will open a browser window for Kite authentication
                            </p>
                        </div>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            
            // Show the modal immediately
            setTimeout(() => {
                document.getElementById('brokerLoginModal').classList.add('active');
            }, 100);
        }
        
        // NSE Holidays for 2025
        const NSE_HOLIDAYS_2025 = [
            '2025-01-26', // Republic Day (Sunday)
            '2025-03-14', // Holi
            '2025-03-31', // Ram Navami
            '2025-04-10', // Mahavir Jayanti
            '2025-04-18', // Good Friday
            '2025-05-01', // Maharashtra Day
            '2025-06-30', // Bakri Id
            '2025-08-15', // Independence Day
            '2025-08-27', // Ganesh Chaturthi
            '2025-10-02', // Gandhi Jayanti
            '2025-10-20', // Dussehra
            '2025-11-01', // Diwali (Saturday)
            '2025-11-02', // Diwali Balipratipada (Sunday)
            '2025-11-14', // Guru Nanak Jayanti
            '2025-12-25', // Christmas
        ];
        
        // Check if today is a holiday
        function isHoliday() {
            const today = new Date();
            const dateStr = today.toISOString().split('T')[0];
            return NSE_HOLIDAYS_2025.includes(dateStr);
        }
        
        // Check market hours
        function isMarketOpen() {
            const now = new Date();
            const day = now.getDay();
            const hours = now.getHours();
            const minutes = now.getMinutes();
            const time = hours * 100 + minutes;
            
            // Check if holiday
            if (isHoliday()) {
                return { open: false, reason: 'NSE Holiday - Markets closed' };
            }
            
            // Check if weekend
            if (day === 0 || day === 6) {
                return { open: false, reason: 'Weekend - Markets closed' };
            }
            
            // Check market hours (9:15 AM to 3:30 PM)
            if (time < 915) {
                return { open: false, reason: 'Pre-market - Opens at 9:15 AM' };
            }
            if (time > 1530) {
                return { open: false, reason: 'After-market - Closed at 3:30 PM' };
            }
            
            return { open: true, reason: 'Market Open' };
        }
        
        // Update trading mode display
        function updateTradingModeDisplay() {
            const modeDisplay = document.getElementById('tradingMode');
            if (modeDisplay) {
                modeDisplay.textContent = window.TRADING_MODE;
                modeDisplay.className = window.TRADING_MODE === 'LIVE' ? 'stat-value negative' : 'stat-value positive';
                modeDisplay.style.cursor = 'pointer';
                modeDisplay.style.textDecoration = 'underline';
                modeDisplay.style.transition = 'opacity 0.2s';
                modeDisplay.title = 'Click to change trading mode';
                
                // Add back the hover effect
                modeDisplay.onmouseover = function() { this.style.opacity = '0.7'; };
                modeDisplay.onmouseout = function() { this.style.opacity = '1'; };
            }
        }
        
        // Initialize
        document.addEventListener('DOMContentLoaded', async function() {
            // Set default values
            document.getElementById('numLots').value = '10';
            calculateAmounts();
            updateStrikeInfo();
            
            // Update mode display
            updateTradingModeDisplay();
            
            // Fetch real NIFTY price immediately and set up periodic updates
            fetchRealNiftyPrice();
            setInterval(fetchRealNiftyPrice, 5000); // Update every 5 seconds
            
            // Check authentication and show login modal once if not authenticated
            const isAuthenticated = await checkAuthStatus(true);
            
            // Set up periodic status check every 10 seconds
            setInterval(async () => {
                await checkAuthStatus(false);  // Check silently without showing modal
            }, 10000);
            
            // Check market hours
            const marketStatus = isMarketOpen();
            if (!marketStatus.open) {
                showAlert(`⏰ ${marketStatus.reason}`, 'warning');
            }
            
            // Update header with broker status
            const headerStats = document.querySelector('.header-stats');
            if (headerStats) {
                // Add broker status
                const statusDiv = document.createElement('div');
                statusDiv.className = 'stat-item';
                statusDiv.innerHTML = `
                    <div class="stat-label">Broker</div>
                    <div class="stat-value ${isAuthenticated ? 'positive' : 'negative'}">
                        ${isAuthenticated ? 'Connected' : 'Disconnected'}
                    </div>
                `;
                headerStats.appendChild(statusDiv);
            }
            
            // Connect WebSocket for real-time NIFTY data
            connectNiftyWebSocket();
            
            // Fetch market data as fallback
            fetchMarketData();
            
            // Market data now handled via WebSocket
            
            // If authenticated, fetch additional data
            if (isAuthenticated) {
                // Fetch margin details
                fetchMarginDetails();
                
                // Fetch live positions
                fetchLivePositions();
                
                // Set up auto-refresh
                // Initial fetch (real-time updates via WebSocket)
                fetchMarginDetails();
                fetchLivePositions();
            } else {
                // Not authenticated - margin will show as 0 naturally
                console.log('Not authenticated - margin data not available');
            }
        });
    </script>
</body>
</html>
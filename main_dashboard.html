<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live Trading Dashboard</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            padding: 20px;
        }
        
        .dashboard-container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .dashboard-header {
            background: white;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .welcome-text h1 {
            font-size: 28px;
            color: #333;
            margin-bottom: 8px;
        }
        
        .welcome-text p {
            color: #666;
            font-size: 16px;
        }
        
        .header-stats {
            display: flex;
            gap: 30px;
        }
        
        .stat-item {
            text-align: center;
        }
        
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #667eea;
        }
        
        .stat-label {
            font-size: 12px;
            color: #999;
            text-transform: uppercase;
            margin-top: 4px;
        }
        
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 24px;
        }
        
        .card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            transition: transform 0.3s, box-shadow 0.3s;
        }
        
        .card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 16px rgba(0,0,0,0.15);
        }
        
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }
        
        .card-title {
            font-size: 18px;
            font-weight: 600;
            color: #333;
        }
        
        .card-icon {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }
        
        .icon-primary { background: rgba(102, 126, 234, 0.1); color: #667eea; }
        .icon-success { background: rgba(16, 185, 129, 0.1); color: #10b981; }
        .icon-danger { background: rgba(239, 68, 68, 0.1); color: #ef4444; }
        .icon-warning { background: rgba(245, 158, 11, 0.1); color: #f59e0b; }
        
        .metric-value {
            font-size: 32px;
            font-weight: bold;
            margin: 8px 0;
        }
        
        .metric-change {
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .positive { color: #10b981; }
        .negative { color: #ef4444; }
        
        .quick-actions {
            background: white;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 24px;
        }
        
        .actions-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-top: 16px;
        }
        
        .action-btn {
            padding: 16px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: transform 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .action-btn:hover {
            transform: scale(1.05);
        }
        
        .positions-table {
            background: white;
            border-radius: 12px;
            padding: 24px;
            overflow-x: auto;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th {
            text-align: left;
            padding: 12px;
            border-bottom: 2px solid #f0f0f0;
            color: #666;
            font-weight: 500;
            font-size: 14px;
        }
        
        td {
            padding: 12px;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
        }
        
        .badge-ce { background: #e0f2fe; color: #0369a1; }
        .badge-pe { background: #fef3c7; color: #d97706; }
        .badge-buy { background: #d1fae5; color: #065f46; }
        .badge-sell { background: #fee2e2; color: #991b1b; }
        
        .market-status {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: white;
            padding: 12px 20px;
            border-radius: 24px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }
        
        .status-open { background: #10b981; }
        .status-closed { background: #ef4444; }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }
        
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .refresh-btn {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            border: none;
            padding: 10px;
            border-radius: 50%;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            cursor: pointer;
            color: #667eea;
            font-size: 18px;
            transition: transform 0.3s;
        }
        
        .refresh-btn:hover {
            transform: rotate(180deg);
        }
        
        .no-data {
            text-align: center;
            padding: 40px;
            color: #999;
        }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <!-- Refresh Button -->
        <button class="refresh-btn" onclick="loadAllData()" title="Refresh Data">
            <i class="fas fa-sync"></i>
        </button>
        
        <!-- Header -->
        <div class="dashboard-header">
            <div class="header-content">
                <div class="welcome-text">
                    <h1>Live Trading Dashboard</h1>
                    <p>Real-time portfolio from Kite & Breeze APIs</p>
                </div>
                <div class="header-stats">
                    <div class="stat-item">
                        <div class="stat-value" id="total-capital">₹0</div>
                        <div class="stat-label">Total Capital</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="available-margin">₹0</div>
                        <div class="stat-label">Available Margin</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="current-time">00:00:00</div>
                        <div class="stat-label">Current Time</div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Metrics Cards -->
        <div class="grid">
            <div class="card">
                <div class="card-header">
                    <span class="card-title">Today's P&L</span>
                    <div class="card-icon icon-primary">
                        <i class="fas fa-chart-line"></i>
                    </div>
                </div>
                <div class="metric-value" id="todays-pnl">
                    <div class="spinner"></div>
                </div>
                <div class="metric-change" id="pnl-change">
                    <span>Loading...</span>
                </div>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <span class="card-title">Open Positions</span>
                    <div class="card-icon icon-warning">
                        <i class="fas fa-briefcase"></i>
                    </div>
                </div>
                <div class="metric-value" id="open-positions">0</div>
                <div class="metric-change" id="position-types">
                    <span>Loading...</span>
                </div>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <span class="card-title">Realized P&L</span>
                    <div class="card-icon icon-success">
                        <i class="fas fa-check-circle"></i>
                    </div>
                </div>
                <div class="metric-value" id="realized-pnl">₹0</div>
                <div class="metric-change">
                    <span>Today's closed trades</span>
                </div>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <span class="card-title">Unrealized P&L</span>
                    <div class="card-icon icon-danger">
                        <i class="fas fa-exclamation-circle"></i>
                    </div>
                </div>
                <div class="metric-value" id="unrealized-pnl">₹0</div>
                <div class="metric-change">
                    <span>Open positions MTM</span>
                </div>
            </div>
        </div>
        
        <!-- Quick Actions -->
        <div class="quick-actions">
            <h2 class="card-title">Quick Actions</h2>
            <div class="actions-grid">
                <button class="action-btn" onclick="parent.loadPage(parent.document.querySelector('[data-page=\"live_trading.html\"]'))">
                    <i class="fas fa-play"></i>
                    Start Trading
                </button>
                <button class="action-btn" onclick="parent.loadPage(parent.document.querySelector('[data-page=\"option_chain.html\"]'))">
                    <i class="fas fa-th"></i>
                    Option Chain
                </button>
                <button class="action-btn" onclick="parent.loadPage(parent.document.querySelector('[data-page=\"positions.html\"]'))">
                    <i class="fas fa-wallet"></i>
                    View Positions
                </button>
                <button class="action-btn" onclick="parent.loadPage(parent.document.querySelector('[data-page=\"signals.html\"]'))">
                    <i class="fas fa-signal"></i>
                    View Signals
                </button>
            </div>
        </div>
        
        <!-- Live Positions -->
        <div class="positions-table">
            <h2 class="card-title" style="margin-bottom: 16px;">Live Positions</h2>
            <div id="positions-content">
                <div class="loading">
                    <div class="spinner"></div>
                    <p>Loading positions...</p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Market Status -->
    <div class="market-status">
        <span class="status-dot" id="market-dot"></span>
        <span id="market-status-text">Market Status</span>
    </div>
    
    <script>
        // Update time and market status
        function updateTime() {
            const now = new Date();
            document.getElementById('current-time').textContent = now.toLocaleTimeString();
            
            const hours = now.getHours();
            const minutes = now.getMinutes();
            const day = now.getDay();
            
            let marketStatus = 'Market Closed';
            let statusClass = 'status-closed';
            
            if (day >= 1 && day <= 5) {
                if ((hours === 9 && minutes >= 15) || (hours > 9 && hours < 15) || (hours === 15 && minutes <= 30)) {
                    marketStatus = 'Market Open';
                    statusClass = 'status-open';
                } else if (hours === 9 && minutes < 15) {
                    marketStatus = 'Pre-Market';
                }
            }
            
            document.getElementById('market-status-text').textContent = marketStatus;
            document.getElementById('market-dot').className = 'status-dot ' + statusClass;
        }
        
        // Load live positions from API
        async function loadPositions() {
            try {
                const response = await fetch('http://localhost:8000/live/positions');
                if (response.ok) {
                    const data = await response.json();
                    
                    // Update position count
                    const openCount = data.positions ? data.positions.length : 0;
                    document.getElementById('open-positions').textContent = openCount;
                    
                    // Count position types
                    let ceCount = 0, peCount = 0;
                    
                    if (data.positions && data.positions.length > 0) {
                        let tableHTML = `
                            <table>
                                <thead>
                                    <tr>
                                        <th>Symbol</th>
                                        <th>Type</th>
                                        <th>Strike</th>
                                        <th>Side</th>
                                        <th>Quantity</th>
                                        <th>Avg Price</th>
                                        <th>LTP</th>
                                        <th>P&L</th>
                                    </tr>
                                </thead>
                                <tbody>
                        `;
                        
                        data.positions.forEach(pos => {
                            // Determine if it's CE or PE
                            const optionType = pos.tradingsymbol?.includes('CE') ? 'CE' : 
                                             pos.tradingsymbol?.includes('PE') ? 'PE' : 'FUT';
                            
                            if (optionType === 'CE') ceCount++;
                            if (optionType === 'PE') peCount++;
                            
                            const pnl = pos.pnl || 0;
                            const pnlClass = pnl >= 0 ? 'positive' : 'negative';
                            const side = pos.quantity > 0 ? 'BUY' : 'SELL';
                            
                            tableHTML += `
                                <tr>
                                    <td>${pos.tradingsymbol || pos.symbol || 'N/A'}</td>
                                    <td><span class="badge badge-${optionType.toLowerCase()}">${optionType}</span></td>
                                    <td>${pos.strike || '-'}</td>
                                    <td><span class="badge badge-${side.toLowerCase()}">${side}</span></td>
                                    <td>${Math.abs(pos.quantity || 0)}</td>
                                    <td>₹${(pos.average_price || pos.buy_price || 0).toFixed(2)}</td>
                                    <td>₹${(pos.last_price || pos.ltp || 0).toFixed(2)}</td>
                                    <td class="${pnlClass}">${pnl >= 0 ? '+' : ''}₹${Math.abs(pnl).toFixed(2)}</td>
                                </tr>
                            `;
                        });
                        
                        tableHTML += '</tbody></table>';
                        document.getElementById('positions-content').innerHTML = tableHTML;
                        
                        // Update position types
                        document.getElementById('position-types').innerHTML = 
                            `<span>${ceCount} Calls, ${peCount} Puts</span>`;
                        
                    } else {
                        document.getElementById('positions-content').innerHTML = 
                            '<div class="no-data"><i class="fas fa-inbox" style="font-size: 48px; margin-bottom: 16px;"></i><p>No open positions</p></div>';
                        document.getElementById('position-types').innerHTML = '<span>No positions</span>';
                    }
                    
                } else {
                    throw new Error('Failed to fetch positions');
                }
            } catch (error) {
                console.error('Error loading positions:', error);
                document.getElementById('positions-content').innerHTML = 
                    '<div class="no-data"><i class="fas fa-exclamation-triangle" style="font-size: 48px; margin-bottom: 16px; color: #f59e0b;"></i><p>Unable to load positions. Please check API connection.</p></div>';
            }
        }
        
        // Load P&L data from API
        async function loadPnL() {
            try {
                const response = await fetch('http://localhost:8000/live/pnl');
                if (response.ok) {
                    const data = await response.json();
                    
                    // Update P&L values
                    const totalPnl = data.total_pnl || 0;
                    const realizedPnl = data.realized_pnl || 0;
                    const unrealizedPnl = data.unrealized_pnl || 0;
                    
                    // Update Today's P&L
                    const pnlElement = document.getElementById('todays-pnl');
                    pnlElement.textContent = `${totalPnl >= 0 ? '+' : ''}₹${Math.abs(totalPnl).toFixed(2)}`;
                    pnlElement.className = totalPnl >= 0 ? 'metric-value positive' : 'metric-value negative';
                    
                    // Update P&L change
                    const changeElement = document.getElementById('pnl-change');
                    if (totalPnl >= 0) {
                        changeElement.innerHTML = '<i class="fas fa-arrow-up"></i><span>Profit today</span>';
                        changeElement.className = 'metric-change positive';
                    } else {
                        changeElement.innerHTML = '<i class="fas fa-arrow-down"></i><span>Loss today</span>';
                        changeElement.className = 'metric-change negative';
                    }
                    
                    // Update Realized P&L
                    const realizedElement = document.getElementById('realized-pnl');
                    realizedElement.textContent = `${realizedPnl >= 0 ? '+' : ''}₹${Math.abs(realizedPnl).toFixed(2)}`;
                    realizedElement.className = realizedPnl >= 0 ? 'metric-value positive' : 'metric-value negative';
                    
                    // Update Unrealized P&L
                    const unrealizedElement = document.getElementById('unrealized-pnl');
                    unrealizedElement.textContent = `${unrealizedPnl >= 0 ? '+' : ''}₹${Math.abs(unrealizedPnl).toFixed(2)}`;
                    unrealizedElement.className = unrealizedPnl >= 0 ? 'metric-value positive' : 'metric-value negative';
                    
                    // Update capital and margin if available
                    if (data.capital) {
                        document.getElementById('total-capital').textContent = `₹${data.capital.toFixed(2)}`;
                    }
                    if (data.available_margin) {
                        document.getElementById('available-margin').textContent = `₹${data.available_margin.toFixed(2)}`;
                    }
                    
                } else {
                    throw new Error('Failed to fetch P&L');
                }
            } catch (error) {
                console.error('Error loading P&L:', error);
                document.getElementById('todays-pnl').innerHTML = '<span style="font-size: 16px; color: #999;">API Offline</span>';
                document.getElementById('pnl-change').innerHTML = '<span>Unable to load</span>';
            }
        }
        
        // Load all data
        async function loadAllData() {
            await Promise.all([
                loadPositions(),
                loadPnL()
            ]);
        }
        
        // Initialize
        setInterval(updateTime, 1000);
        updateTime();
        
        // Load data on page load
        loadAllData();
        
        // Auto-refresh every 10 seconds during market hours
        setInterval(() => {
            const now = new Date();
            const hours = now.getHours();
            const day = now.getDay();
            
            // Only refresh during market hours (weekdays 9 AM to 4 PM)
            if (day >= 1 && day <= 5 && hours >= 9 && hours <= 16) {
                loadAllData();
            }
        }, 10000);
    </script>
</body>
</html>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trading Performance Analytics</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/date-fns@2.29.3/index.min.js"></script>
    <style>
        :root {
            --bg-primary: #0a0e27;
            --bg-secondary: #151935;
            --bg-card: #1a1f3a;
            --text-primary: #ffffff;
            --text-secondary: #8892b0;
            --accent-green: #00ff88;
            --accent-red: #ff3366;
            --accent-blue: #00d4ff;
            --accent-yellow: #ffcc00;
            --border-color: #2a3456;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            padding: 20px;
        }

        .container {
            max-width: 1800px;
            margin: 0 auto;
        }

        .header {
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .title {
            font-size: 32px;
            font-weight: 700;
        }

        .date-range-selector {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .date-range-selector select, .date-range-selector input {
            padding: 10px 15px;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-primary);
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .metric-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
        }

        .metric-label {
            color: var(--text-secondary);
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 10px;
        }

        .metric-value {
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .metric-change {
            font-size: 14px;
        }

        .positive { color: var(--accent-green); }
        .negative { color: var(--accent-red); }
        .neutral { color: var(--accent-blue); }

        .charts-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        .chart-container {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 20px;
        }

        .chart-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 20px;
            color: var(--text-primary);
        }

        .chart-canvas {
            position: relative;
            height: 300px;
        }

        .signal-performance {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
        }

        .signal-card {
            background: var(--bg-secondary);
            border-radius: 8px;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .signal-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 20px rgba(0, 212, 255, 0.2);
        }

        .signal-name {
            font-size: 24px;
            font-weight: 700;
            color: var(--accent-blue);
            margin-bottom: 5px;
        }

        .signal-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 10px;
        }

        .signal-stat-label {
            font-size: 11px;
            color: var(--text-secondary);
        }

        .signal-stat-value {
            font-size: 16px;
            font-weight: 600;
        }

        .trades-table {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 20px;
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            background: var(--bg-secondary);
            padding: 12px;
            text-align: left;
            font-weight: 600;
            color: var(--text-secondary);
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        td {
            padding: 12px;
            border-top: 1px solid var(--border-color);
        }

        tr:hover {
            background: rgba(0, 212, 255, 0.05);
        }

        .risk-metrics {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin-bottom: 30px;
        }

        .risk-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 20px;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: var(--bg-secondary);
            border-radius: 4px;
            overflow: hidden;
            margin-top: 10px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--accent-blue), var(--accent-green));
            border-radius: 4px;
            transition: width 0.5s ease;
        }

        .time-analysis {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 10px;
            padding: 20px;
            background: var(--bg-card);
            border-radius: 12px;
        }

        .hour-block {
            text-align: center;
            padding: 15px 10px;
            background: var(--bg-secondary);
            border-radius: 8px;
            cursor: pointer;
        }

        .hour-block:hover {
            background: var(--bg-primary);
        }

        .hour-time {
            font-size: 14px;
            color: var(--text-secondary);
            margin-bottom: 5px;
        }

        .hour-pnl {
            font-size: 18px;
            font-weight: 600;
        }

        .hour-trades {
            font-size: 11px;
            color: var(--text-secondary);
            margin-top: 5px;
        }

        .filter-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .filter-btn {
            padding: 8px 16px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-primary);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .filter-btn.active {
            background: var(--accent-blue);
            border-color: var(--accent-blue);
        }

        .filter-btn:hover {
            transform: translateY(-2px);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1 class="title">ðŸ“ˆ Performance Analytics</h1>
            <div class="date-range-selector">
                <select id="periodSelect">
                    <option value="today">Today</option>
                    <option value="week">This Week</option>
                    <option value="month" selected>This Month</option>
                    <option value="year">This Year</option>
                    <option value="custom">Custom Range</option>
                </select>
                <input type="date" id="startDate" style="display:none;">
                <input type="date" id="endDate" style="display:none;">
                <button onclick="refreshAnalytics()" style="padding: 10px 20px; background: var(--accent-blue); border: none; border-radius: 8px; color: white; cursor: pointer;">
                    Refresh
                </button>
            </div>
        </div>

        <!-- Key Metrics -->
        <div class="metrics-grid">
            <div class="metric-card">
                <div class="metric-label">Total P&L</div>
                <div class="metric-value" id="totalPnl">â‚¹0</div>
                <div class="metric-change" id="pnlChange">0%</div>
            </div>
            <div class="metric-card">
                <div class="metric-label">Win Rate</div>
                <div class="metric-value" id="winRate">0%</div>
                <div class="metric-change" id="winCount">0/0 trades</div>
            </div>
            <div class="metric-card">
                <div class="metric-label">Avg Win</div>
                <div class="metric-value positive" id="avgWin">â‚¹0</div>
                <div class="metric-change">Per winning trade</div>
            </div>
            <div class="metric-card">
                <div class="metric-label">Avg Loss</div>
                <div class="metric-value negative" id="avgLoss">â‚¹0</div>
                <div class="metric-change">Per losing trade</div>
            </div>
            <div class="metric-card">
                <div class="metric-label">Risk/Reward</div>
                <div class="metric-value neutral" id="riskReward">0</div>
                <div class="metric-change">Ratio</div>
            </div>
            <div class="metric-card">
                <div class="metric-label">Sharpe Ratio</div>
                <div class="metric-value neutral" id="sharpeRatio">0</div>
                <div class="metric-change">Risk-adjusted return</div>
            </div>
            <div class="metric-card">
                <div class="metric-label">Max Drawdown</div>
                <div class="metric-value negative" id="maxDrawdown">0%</div>
                <div class="metric-change" id="drawdownDate">-</div>
            </div>
            <div class="metric-card">
                <div class="metric-label">Profit Factor</div>
                <div class="metric-value neutral" id="profitFactor">0</div>
                <div class="metric-change">Gross profit/loss</div>
            </div>
        </div>

        <!-- Main Charts -->
        <div class="charts-grid">
            <div class="chart-container">
                <h3 class="chart-title">Cumulative P&L</h3>
                <div class="chart-canvas">
                    <canvas id="pnlChart"></canvas>
                </div>
            </div>
            <div class="chart-container">
                <h3 class="chart-title">Daily P&L Distribution</h3>
                <div class="chart-canvas">
                    <canvas id="dailyPnlChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Signal Performance -->
        <div class="chart-container">
            <h3 class="chart-title">Performance by Signal</h3>
            <div class="signal-performance" id="signalPerformance">
                <!-- Signal cards will be generated here -->
            </div>
        </div>

        <!-- Time Analysis -->
        <div class="chart-container">
            <h3 class="chart-title">Performance by Hour</h3>
            <div class="time-analysis" id="timeAnalysis">
                <!-- Hour blocks will be generated here -->
            </div>
        </div>

        <!-- Risk Metrics -->
        <div class="risk-metrics">
            <div class="risk-card">
                <div class="metric-label">Daily VaR (95%)</div>
                <div class="metric-value" id="dailyVar">â‚¹0</div>
                <div class="progress-bar">
                    <div class="progress-fill" id="varProgress" style="width: 0%"></div>
                </div>
            </div>
            <div class="risk-card">
                <div class="metric-label">Capital Utilized</div>
                <div class="metric-value" id="capitalUsed">â‚¹0</div>
                <div class="progress-bar">
                    <div class="progress-fill" id="capitalProgress" style="width: 0%"></div>
                </div>
            </div>
            <div class="risk-card">
                <div class="metric-label">Recovery Factor</div>
                <div class="metric-value" id="recoveryFactor">0</div>
                <div class="progress-bar">
                    <div class="progress-fill" id="recoveryProgress" style="width: 0%"></div>
                </div>
            </div>
        </div>

        <!-- Recent Trades Table -->
        <div class="trades-table">
            <h3 class="chart-title">Recent Trades</h3>
            <div class="filter-buttons">
                <button class="filter-btn active" onclick="filterTrades('all')">All</button>
                <button class="filter-btn" onclick="filterTrades('winners')">Winners</button>
                <button class="filter-btn" onclick="filterTrades('losers')">Losers</button>
                <button class="filter-btn" onclick="filterTrades('open')">Open</button>
            </div>
            <table>
                <thead>
                    <tr>
                        <th>Time</th>
                        <th>Signal</th>
                        <th>Strike</th>
                        <th>Type</th>
                        <th>Entry</th>
                        <th>Exit</th>
                        <th>Quantity</th>
                        <th>P&L</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody id="tradesTableBody">
                    <!-- Trades will be populated here -->
                </tbody>
            </table>
        </div>
    </div>

    <script>
        const API_BASE = window.location.protocol === 'file:' ? 'http://localhost:8000' : '';
        let analyticsData = null;
        let charts = {};

        // Initialize charts
        function initCharts() {
            // Cumulative P&L Chart
            const pnlCtx = document.getElementById('pnlChart').getContext('2d');
            charts.pnl = new Chart(pnlCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Cumulative P&L',
                        data: [],
                        borderColor: '#00ff88',
                        backgroundColor: 'rgba(0, 255, 136, 0.1)',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            grid: { color: '#2a3456' },
                            ticks: { color: '#8892b0' }
                        },
                        x: {
                            grid: { color: '#2a3456' },
                            ticks: { color: '#8892b0' }
                        }
                    }
                }
            });

            // Daily P&L Distribution
            const dailyCtx = document.getElementById('dailyPnlChart').getContext('2d');
            charts.daily = new Chart(dailyCtx, {
                type: 'bar',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Daily P&L',
                        data: [],
                        backgroundColor: []
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            grid: { color: '#2a3456' },
                            ticks: { color: '#8892b0' }
                        },
                        x: {
                            grid: { color: '#2a3456' },
                            ticks: { color: '#8892b0' }
                        }
                    }
                }
            });
        }

        // Load analytics data
        async function loadAnalytics() {
            try {
                const period = document.getElementById('periodSelect').value;
                let url = `${API_BASE}/api/analytics/performance?period=${period}`;
                
                if (period === 'custom') {
                    const start = document.getElementById('startDate').value;
                    const end = document.getElementById('endDate').value;
                    url += `&start=${start}&end=${end}`;
                }

                const response = await fetch(url);
                analyticsData = await response.json();
                
                updateMetrics();
                updateCharts();
                updateSignalPerformance();
                updateTimeAnalysis();
                updateTradesTable();
                
            } catch (error) {
                console.error('Error loading analytics:', error);
                // Use dummy data for now
                generateDummyData();
            }
        }

        // Generate dummy data for demonstration
        function generateDummyData() {
            const days = 30;
            const trades = [];
            const signals = ['S1', 'S2', 'S3', 'S4', 'S5', 'S6', 'S7', 'S8'];
            
            let cumulativePnl = 0;
            const dailyPnl = [];
            const cumulativePnlData = [];
            
            for (let i = 0; i < days; i++) {
                const date = new Date();
                date.setDate(date.getDate() - (days - i));
                
                const numTrades = Math.floor(Math.random() * 5) + 1;
                let dayPnl = 0;
                
                for (let j = 0; j < numTrades; j++) {
                    const signal = signals[Math.floor(Math.random() * signals.length)];
                    const pnl = (Math.random() - 0.45) * 5000;
                    dayPnl += pnl;
                    
                    trades.push({
                        date: date.toISOString(),
                        signal: signal,
                        strike: 25000 + (Math.floor(Math.random() * 10) * 50),
                        type: Math.random() > 0.5 ? 'CE' : 'PE',
                        entry: 100 + Math.random() * 50,
                        exit: 100 + Math.random() * 50,
                        quantity: 750,
                        pnl: pnl,
                        status: pnl > 0 ? 'Winner' : 'Loser'
                    });
                }
                
                cumulativePnl += dayPnl;
                dailyPnl.push(dayPnl);
                cumulativePnlData.push(cumulativePnl);
            }
            
            analyticsData = {
                trades: trades,
                dailyPnl: dailyPnl,
                cumulativePnl: cumulativePnlData,
                metrics: calculateMetrics(trades)
            };
            
            updateMetrics();
            updateCharts();
            updateSignalPerformance();
            updateTimeAnalysis();
            updateTradesTable();
        }

        // Calculate metrics from trades
        function calculateMetrics(trades) {
            const winners = trades.filter(t => t.pnl > 0);
            const losers = trades.filter(t => t.pnl < 0);
            const totalPnl = trades.reduce((sum, t) => sum + t.pnl, 0);
            
            return {
                totalPnl: totalPnl,
                winRate: (winners.length / trades.length) * 100,
                avgWin: winners.length > 0 ? winners.reduce((sum, t) => sum + t.pnl, 0) / winners.length : 0,
                avgLoss: losers.length > 0 ? Math.abs(losers.reduce((sum, t) => sum + t.pnl, 0) / losers.length) : 0,
                totalTrades: trades.length,
                winningTrades: winners.length,
                losingTrades: losers.length
            };
        }

        // Update metrics display
        function updateMetrics() {
            if (!analyticsData || !analyticsData.metrics) return;
            
            const m = analyticsData.metrics;
            
            document.getElementById('totalPnl').textContent = `â‚¹${m.totalPnl.toFixed(0)}`;
            document.getElementById('totalPnl').className = `metric-value ${m.totalPnl >= 0 ? 'positive' : 'negative'}`;
            document.getElementById('pnlChange').textContent = `${((m.totalPnl / 500000) * 100).toFixed(2)}%`;
            document.getElementById('pnlChange').className = `metric-change ${m.totalPnl >= 0 ? 'positive' : 'negative'}`;
            
            document.getElementById('winRate').textContent = `${m.winRate.toFixed(1)}%`;
            document.getElementById('winCount').textContent = `${m.winningTrades}/${m.totalTrades} trades`;
            
            document.getElementById('avgWin').textContent = `â‚¹${m.avgWin.toFixed(0)}`;
            document.getElementById('avgLoss').textContent = `â‚¹${m.avgLoss.toFixed(0)}`;
            
            const riskReward = m.avgLoss > 0 ? (m.avgWin / m.avgLoss).toFixed(2) : 0;
            document.getElementById('riskReward').textContent = riskReward;
            
            // Calculate additional metrics
            const sharpe = calculateSharpeRatio(analyticsData.dailyPnl);
            document.getElementById('sharpeRatio').textContent = sharpe.toFixed(2);
            
            const maxDD = calculateMaxDrawdown(analyticsData.cumulativePnl);
            document.getElementById('maxDrawdown').textContent = `${maxDD.value.toFixed(1)}%`;
            
            const profitFactor = Math.abs(m.avgWin * m.winningTrades) / Math.abs(m.avgLoss * m.losingTrades) || 0;
            document.getElementById('profitFactor').textContent = profitFactor.toFixed(2);
        }

        // Calculate Sharpe Ratio
        function calculateSharpeRatio(returns) {
            if (!returns || returns.length === 0) return 0;
            const avg = returns.reduce((a, b) => a + b, 0) / returns.length;
            const stdDev = Math.sqrt(returns.reduce((sq, n) => sq + Math.pow(n - avg, 2), 0) / returns.length);
            return stdDev > 0 ? (avg / stdDev) * Math.sqrt(252) : 0; // Annualized
        }

        // Calculate Maximum Drawdown
        function calculateMaxDrawdown(cumulative) {
            if (!cumulative || cumulative.length === 0) return { value: 0, date: null };
            
            let maxDrawdown = 0;
            let peak = cumulative[0];
            
            for (let i = 1; i < cumulative.length; i++) {
                if (cumulative[i] > peak) {
                    peak = cumulative[i];
                }
                const drawdown = ((peak - cumulative[i]) / peak) * 100;
                if (drawdown > maxDrawdown) {
                    maxDrawdown = drawdown;
                }
            }
            
            return { value: maxDrawdown };
        }

        // Update charts
        function updateCharts() {
            if (!analyticsData) return;
            
            // Update cumulative P&L chart
            const dates = analyticsData.trades.map(t => new Date(t.date).toLocaleDateString());
            const uniqueDates = [...new Set(dates)];
            
            charts.pnl.data.labels = uniqueDates;
            charts.pnl.data.datasets[0].data = analyticsData.cumulativePnl;
            charts.pnl.update();
            
            // Update daily P&L chart
            charts.daily.data.labels = uniqueDates;
            charts.daily.data.datasets[0].data = analyticsData.dailyPnl;
            charts.daily.data.datasets[0].backgroundColor = analyticsData.dailyPnl.map(v => 
                v >= 0 ? 'rgba(0, 255, 136, 0.6)' : 'rgba(255, 51, 102, 0.6)'
            );
            charts.daily.update();
        }

        // Update signal performance
        function updateSignalPerformance() {
            const container = document.getElementById('signalPerformance');
            container.innerHTML = '';
            
            const signals = ['S1', 'S2', 'S3', 'S4', 'S5', 'S6', 'S7', 'S8'];
            
            signals.forEach(signal => {
                const signalTrades = analyticsData.trades.filter(t => t.signal === signal);
                const signalPnl = signalTrades.reduce((sum, t) => sum + t.pnl, 0);
                const winRate = signalTrades.length > 0 ? 
                    (signalTrades.filter(t => t.pnl > 0).length / signalTrades.length * 100) : 0;
                
                const card = document.createElement('div');
                card.className = 'signal-card';
                card.innerHTML = `
                    <div class="signal-name">${signal}</div>
                    <div class="signal-stats">
                        <div>
                            <div class="signal-stat-label">Trades</div>
                            <div class="signal-stat-value">${signalTrades.length}</div>
                        </div>
                        <div>
                            <div class="signal-stat-label">Win %</div>
                            <div class="signal-stat-value">${winRate.toFixed(0)}%</div>
                        </div>
                        <div>
                            <div class="signal-stat-label">P&L</div>
                            <div class="signal-stat-value ${signalPnl >= 0 ? 'positive' : 'negative'}">
                                â‚¹${signalPnl.toFixed(0)}
                            </div>
                        </div>
                        <div>
                            <div class="signal-stat-label">Avg</div>
                            <div class="signal-stat-value">
                                â‚¹${signalTrades.length > 0 ? (signalPnl/signalTrades.length).toFixed(0) : 0}
                            </div>
                        </div>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        // Update time analysis
        function updateTimeAnalysis() {
            const container = document.getElementById('timeAnalysis');
            container.innerHTML = '';
            
            const hours = ['09:15', '10:15', '11:15', '12:15', '13:15', '14:15'];
            
            hours.forEach(hour => {
                const hourTrades = analyticsData.trades.filter(t => {
                    const tradeHour = new Date(t.date).getHours();
                    const targetHour = parseInt(hour.split(':')[0]);
                    return tradeHour === targetHour;
                });
                
                const hourPnl = hourTrades.reduce((sum, t) => sum + t.pnl, 0);
                
                const block = document.createElement('div');
                block.className = 'hour-block';
                block.innerHTML = `
                    <div class="hour-time">${hour}</div>
                    <div class="hour-pnl ${hourPnl >= 0 ? 'positive' : 'negative'}">
                        â‚¹${hourPnl.toFixed(0)}
                    </div>
                    <div class="hour-trades">${hourTrades.length} trades</div>
                `;
                container.appendChild(block);
            });
        }

        // Update trades table
        function updateTradesTable() {
            const tbody = document.getElementById('tradesTableBody');
            tbody.innerHTML = '';
            
            const recentTrades = analyticsData.trades.slice(-20).reverse();
            
            recentTrades.forEach(trade => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${new Date(trade.date).toLocaleString()}</td>
                    <td><span class="signal-badge">${trade.signal}</span></td>
                    <td>${trade.strike}</td>
                    <td>${trade.type}</td>
                    <td>â‚¹${trade.entry.toFixed(2)}</td>
                    <td>â‚¹${trade.exit.toFixed(2)}</td>
                    <td>${trade.quantity}</td>
                    <td class="${trade.pnl >= 0 ? 'positive' : 'negative'}">â‚¹${trade.pnl.toFixed(0)}</td>
                    <td>${trade.status}</td>
                `;
                tbody.appendChild(row);
            });
        }

        // Filter trades
        function filterTrades(type) {
            // Update filter buttons
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // Filter table based on type
            // Implementation would filter the trades table
        }

        // Handle period change
        document.getElementById('periodSelect').addEventListener('change', function() {
            const isCustom = this.value === 'custom';
            document.getElementById('startDate').style.display = isCustom ? 'block' : 'none';
            document.getElementById('endDate').style.display = isCustom ? 'block' : 'none';
            
            if (!isCustom) {
                loadAnalytics();
            }
        });

        // Refresh analytics
        function refreshAnalytics() {
            loadAnalytics();
        }

        // Initialize
        window.onload = function() {
            initCharts();
            loadAnalytics();
            
            // Auto-refresh every 5 minutes
            setInterval(loadAnalytics, 300000);
        };
    </script>
</body>
</html>
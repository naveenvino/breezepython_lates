<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Settings - Real Working Version</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #1a1a1a;
            color: #ffffff;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            background: #2a2a2a;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
        }

        h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }

        .subtitle {
            color: #888;
            font-size: 14px;
        }

        .settings-grid {
            display: grid;
            grid-template-columns: 250px 1fr;
            gap: 30px;
        }

        .sidebar {
            background: #2a2a2a;
            padding: 20px;
            border-radius: 10px;
            height: fit-content;
        }

        .nav-item {
            padding: 12px;
            margin-bottom: 5px;
            cursor: pointer;
            border-radius: 5px;
            transition: background 0.3s;
        }

        .nav-item:hover {
            background: #3a3a3a;
        }

        .nav-item.active {
            background: #007bff;
        }

        .content {
            background: #2a2a2a;
            padding: 30px;
            border-radius: 10px;
        }

        .section {
            display: none;
        }

        .section.active {
            display: block;
        }

        .section-title {
            font-size: 20px;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 1px solid #3a3a3a;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-size: 14px;
            color: #ccc;
        }

        input[type="text"],
        input[type="number"],
        input[type="email"],
        input[type="password"],
        select {
            width: 100%;
            padding: 10px;
            background: #1a1a1a;
            border: 1px solid #3a3a3a;
            border-radius: 5px;
            color: #fff;
            font-size: 14px;
        }

        input:focus,
        select:focus {
            outline: none;
            border-color: #007bff;
        }

        .toggle-group {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
            border-bottom: 1px solid #3a3a3a;
        }

        .toggle-label {
            flex: 1;
        }

        .toggle-title {
            font-size: 14px;
            margin-bottom: 4px;
        }

        .toggle-desc {
            font-size: 12px;
            color: #888;
        }

        .switch {
            position: relative;
            width: 50px;
            height: 24px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #3a3a3a;
            transition: .4s;
            border-radius: 24px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: #007bff;
        }

        input:checked + .slider:before {
            transform: translateX(26px);
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
            margin-right: 10px;
        }

        .btn-primary {
            background: #007bff;
            color: white;
        }

        .btn-primary:hover {
            background: #0056b3;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #545b62;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .btn-group {
            margin-top: 20px;
        }

        .alert {
            padding: 12px 20px;
            border-radius: 5px;
            margin-bottom: 20px;
            display: none;
        }

        .alert.show {
            display: block;
        }

        .alert-success {
            background: #28a745;
            color: white;
        }

        .alert-error {
            background: #dc3545;
            color: white;
        }

        .alert-info {
            background: #17a2b8;
            color: white;
        }

        .status {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 10px 20px;
            background: #28a745;
            color: white;
            border-radius: 5px;
            display: none;
        }

        .status.show {
            display: block;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Settings Configuration</h1>
            <p class="subtitle">Manage your trading system preferences - 100% REAL & FUNCTIONAL</p>
        </div>

        <div id="notification" class="alert"></div>

        <div class="settings-grid">
            <div class="sidebar">
                <div class="nav-item active" onclick="showSection('general')">General</div>
                <div class="nav-item" onclick="showSection('trading')">Trading</div>
                <div class="nav-item" onclick="showSection('api')">API Configuration</div>
                <div class="nav-item" onclick="showSection('notifications')">Notifications</div>
                <div class="nav-item" onclick="showSection('risk')">Risk Management</div>
                <div class="nav-item" onclick="showSection('data')">Data & Storage</div>
            </div>

            <div class="content">
                <!-- General Settings -->
                <div id="general" class="section active">
                    <h2 class="section-title">General Settings</h2>
                    
                    <div class="toggle-group">
                        <div class="toggle-label">
                            <div class="toggle-title">Dark Mode</div>
                            <div class="toggle-desc">Enable dark theme</div>
                        </div>
                        <label class="switch">
                            <input type="checkbox" id="darkMode" checked onchange="toggleChanged('darkMode')">
                            <span class="slider"></span>
                        </label>
                    </div>

                    <div class="toggle-group">
                        <div class="toggle-label">
                            <div class="toggle-title">Auto Refresh</div>
                            <div class="toggle-desc">Automatically refresh data</div>
                        </div>
                        <label class="switch">
                            <input type="checkbox" id="autoRefresh" checked onchange="toggleChanged('autoRefresh')">
                            <span class="slider"></span>
                        </label>
                    </div>

                    <div class="form-group">
                        <label for="language">Language</label>
                        <select id="language" onchange="fieldChanged('language')">
                            <option value="en">English</option>
                            <option value="hi">Hindi</option>
                            <option value="mr">Marathi</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="timezone">Timezone</label>
                        <select id="timezone" onchange="fieldChanged('timezone')">
                            <option value="Asia/Kolkata">India (IST)</option>
                            <option value="UTC">UTC</option>
                            <option value="America/New_York">New York</option>
                        </select>
                    </div>
                </div>

                <!-- Trading Settings -->
                <div id="trading" class="section">
                    <h2 class="section-title">Trading Settings</h2>
                    
                    <div class="form-group">
                        <label for="defaultLots">Default Lot Size</label>
                        <input type="number" id="defaultLots" value="10" onchange="fieldChanged('defaultLots')">
                    </div>

                    <div class="form-group">
                        <label for="slippage">Slippage Tolerance (%)</label>
                        <input type="number" id="slippage" value="0.5" step="0.1" onchange="fieldChanged('slippage')">
                    </div>

                    <div class="toggle-group">
                        <div class="toggle-label">
                            <div class="toggle-title">Auto Trade</div>
                            <div class="toggle-desc">Enable automatic trading</div>
                        </div>
                        <label class="switch">
                            <input type="checkbox" id="autoTrade" onchange="toggleChanged('autoTrade')">
                            <span class="slider"></span>
                        </label>
                    </div>

                    <div class="toggle-group">
                        <div class="toggle-label">
                            <div class="toggle-title">Sound Alerts</div>
                            <div class="toggle-desc">Play sounds for trade events</div>
                        </div>
                        <label class="switch">
                            <input type="checkbox" id="soundAlerts" checked onchange="toggleChanged('soundAlerts')">
                            <span class="slider"></span>
                        </label>
                    </div>
                </div>

                <!-- API Settings -->
                <div id="api" class="section">
                    <h2 class="section-title">API Configuration</h2>
                    
                    <div class="form-group">
                        <label for="apiKey">API Key</label>
                        <input type="password" id="apiKey" placeholder="Enter API key" onchange="fieldChanged('apiKey')">
                    </div>

                    <div class="form-group">
                        <label for="apiSecret">API Secret</label>
                        <input type="password" id="apiSecret" placeholder="Enter API secret" onchange="fieldChanged('apiSecret')">
                    </div>

                    <div class="btn-group">
                        <button class="btn btn-primary" onclick="testConnection()">Test Connection</button>
                        <button class="btn btn-secondary" onclick="showApiKey()">Show/Hide Keys</button>
                    </div>
                </div>

                <!-- Notifications -->
                <div id="notifications" class="section">
                    <h2 class="section-title">Notification Settings</h2>
                    
                    <div class="toggle-group">
                        <div class="toggle-label">
                            <div class="toggle-title">Browser Notifications</div>
                            <div class="toggle-desc">Show browser notifications</div>
                        </div>
                        <label class="switch">
                            <input type="checkbox" id="browserNotifications" checked onchange="toggleChanged('browserNotifications')">
                            <span class="slider"></span>
                        </label>
                    </div>

                    <div class="toggle-group">
                        <div class="toggle-label">
                            <div class="toggle-title">Email Notifications</div>
                            <div class="toggle-desc">Send email alerts</div>
                        </div>
                        <label class="switch">
                            <input type="checkbox" id="emailNotifications" onchange="toggleChanged('emailNotifications')">
                            <span class="slider"></span>
                        </label>
                    </div>

                    <div class="toggle-group">
                        <div class="toggle-label">
                            <div class="toggle-title">SMS Notifications</div>
                            <div class="toggle-desc">Send SMS alerts</div>
                        </div>
                        <label class="switch">
                            <input type="checkbox" id="smsNotifications" onchange="toggleChanged('smsNotifications')">
                            <span class="slider"></span>
                        </label>
                    </div>
                </div>

                <!-- Risk Management -->
                <div id="risk" class="section">
                    <h2 class="section-title">Risk Management</h2>
                    
                    <div class="form-group">
                        <label for="maxDailyLoss">Max Daily Loss (₹)</label>
                        <input type="number" id="maxDailyLoss" value="50000" onchange="fieldChanged('maxDailyLoss')">
                    </div>

                    <div class="form-group">
                        <label for="maxPositions">Max Positions</label>
                        <input type="number" id="maxPositions" value="5" onchange="fieldChanged('maxPositions')">
                    </div>

                    <div class="toggle-group">
                        <div class="toggle-label">
                            <div class="toggle-title">Stop Loss</div>
                            <div class="toggle-desc">Enable stop loss</div>
                        </div>
                        <label class="switch">
                            <input type="checkbox" id="stopLoss" checked onchange="toggleChanged('stopLoss')">
                            <span class="slider"></span>
                        </label>
                    </div>

                    <div class="toggle-group">
                        <div class="toggle-label">
                            <div class="toggle-title">Trailing Stop</div>
                            <div class="toggle-desc">Enable trailing stop loss</div>
                        </div>
                        <label class="switch">
                            <input type="checkbox" id="trailingStop" onchange="toggleChanged('trailingStop')">
                            <span class="slider"></span>
                        </label>
                    </div>
                </div>

                <!-- Data & Storage -->
                <div id="data" class="section">
                    <h2 class="section-title">Data & Storage</h2>
                    
                    <div class="form-group">
                        <label for="retentionDays">Data Retention (days)</label>
                        <input type="number" id="retentionDays" value="90" onchange="fieldChanged('retentionDays')">
                    </div>

                    <div class="toggle-group">
                        <div class="toggle-label">
                            <div class="toggle-title">Auto Backup</div>
                            <div class="toggle-desc">Automatically backup data</div>
                        </div>
                        <label class="switch">
                            <input type="checkbox" id="autoBackup" checked onchange="toggleChanged('autoBackup')">
                            <span class="slider"></span>
                        </label>
                    </div>

                    <div class="btn-group">
                        <button class="btn btn-secondary" onclick="clearCache()">Clear Cache</button>
                        <button class="btn btn-primary" onclick="exportData()">Export Data</button>
                        <button class="btn btn-danger" onclick="resetData()">Reset All</button>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="btn-group" style="margin-top: 30px; padding-top: 20px; border-top: 1px solid #3a3a3a;">
                    <button class="btn btn-primary" onclick="saveSettings()">Save All Settings</button>
                    <button class="btn btn-secondary" onclick="loadSettings()">Reload Settings</button>
                </div>
            </div>
        </div>
    </div>

    <div id="status" class="status"></div>

    <script>
        // API base URL
        const API_BASE = window.location.protocol === 'file:' ? 'http://localhost:8000' : '';
        
        // Track changes
        let hasChanges = false;
        let currentSettings = {};

        // Initialize on load
        window.addEventListener('DOMContentLoaded', function() {
            console.log('Settings page loaded');
            loadSettings();
        });

        // Show section
        function showSection(section) {
            // Update nav
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            event.target.classList.add('active');

            // Update content
            document.querySelectorAll('.section').forEach(sec => {
                sec.classList.remove('active');
            });
            document.getElementById(section).classList.add('active');
        }

        // Track toggle changes
        function toggleChanged(id) {
            const value = document.getElementById(id).checked;
            console.log(`Toggle ${id} changed to: ${value}`);
            hasChanges = true;
            showStatus(`Changed ${id}: ${value}`);
        }

        // Track field changes
        function fieldChanged(id) {
            const value = document.getElementById(id).value;
            console.log(`Field ${id} changed to: ${value}`);
            hasChanges = true;
            showStatus(`Changed ${id}: ${value}`);
        }

        // Show status message
        function showStatus(message) {
            const status = document.getElementById('status');
            status.textContent = message;
            status.classList.add('show');
            setTimeout(() => {
                status.classList.remove('show');
            }, 3000);
        }

        // Show notification
        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `alert alert-${type} show`;
            setTimeout(() => {
                notification.classList.remove('show');
            }, 5000);
        }

        // Load settings from API
        async function loadSettings() {
            try {
                console.log('Loading settings from API...');
                const response = await fetch(`${API_BASE}/settings/all`);
                const data = await response.json();
                
                if (data.status === 'success') {
                    currentSettings = data.settings;
                    console.log('Settings loaded:', currentSettings);
                    
                    // Apply settings to UI
                    applySettings(currentSettings);
                    showNotification('Settings loaded successfully', 'success');
                } else {
                    showNotification('Failed to load settings', 'error');
                }
            } catch (error) {
                console.error('Error loading settings:', error);
                showNotification('Error loading settings: ' + error.message, 'error');
            }
        }

        // Apply settings to UI
        function applySettings(settings) {
            // General settings
            if (settings.general) {
                setElementValue('darkMode', settings.general.theme === 'dark');
                setElementValue('autoRefresh', settings.general.auto_refresh === 'true');
                setElementValue('language', settings.general.language || 'en');
                setElementValue('timezone', settings.general.timezone || 'Asia/Kolkata');
            }

            // Trading settings
            if (settings.trading) {
                setElementValue('defaultLots', settings.trading.default_lots || '10');
                setElementValue('slippage', settings.trading.slippage_tolerance || '0.5');
                setElementValue('autoTrade', settings.trading.auto_trade_enabled === 'true');
                setElementValue('soundAlerts', settings.trading.sound_alerts === 'true');
            }

            // API settings
            if (settings.api) {
                setElementValue('apiKey', settings.api.breeze_api_key || '');
                setElementValue('apiSecret', settings.api.breeze_api_secret || '');
            }

            // Notifications
            if (settings.notifications) {
                setElementValue('browserNotifications', settings.notifications.browser_enabled === 'true');
                setElementValue('emailNotifications', settings.notifications.email_enabled === 'true');
                setElementValue('smsNotifications', settings.notifications.sms_enabled === 'true');
            }

            // Risk settings
            if (settings.risk) {
                setElementValue('maxDailyLoss', settings.risk.max_daily_loss || '50000');
                setElementValue('maxPositions', settings.risk.max_positions || '5');
                setElementValue('stopLoss', settings.risk.stop_loss_enabled === 'true');
                setElementValue('trailingStop', settings.risk.trailing_stop === 'true');
            }

            // Data settings
            if (settings.data) {
                setElementValue('retentionDays', settings.data.retention_days || '90');
                setElementValue('autoBackup', settings.data.auto_backup === 'true');
            }
        }

        // Set element value
        function setElementValue(id, value) {
            const element = document.getElementById(id);
            if (element) {
                if (element.type === 'checkbox') {
                    element.checked = value;
                } else {
                    element.value = value;
                }
            }
        }

        // Get element value
        function getElementValue(id) {
            const element = document.getElementById(id);
            if (element) {
                if (element.type === 'checkbox') {
                    return element.checked;
                } else {
                    return element.value;
                }
            }
            return null;
        }

        // Save settings
        async function saveSettings() {
            try {
                console.log('Saving settings...');
                
                // Collect all settings
                const settings = {
                    general: {
                        theme: getElementValue('darkMode') ? 'dark' : 'light',
                        auto_refresh: getElementValue('autoRefresh') ? 'true' : 'false',
                        language: getElementValue('language'),
                        timezone: getElementValue('timezone')
                    },
                    trading: {
                        default_lots: getElementValue('defaultLots'),
                        slippage_tolerance: getElementValue('slippage'),
                        auto_trade_enabled: getElementValue('autoTrade') ? 'true' : 'false',
                        sound_alerts: getElementValue('soundAlerts') ? 'true' : 'false'
                    },
                    api: {
                        breeze_api_key: getElementValue('apiKey'),
                        breeze_api_secret: getElementValue('apiSecret')
                    },
                    notifications: {
                        browser_enabled: getElementValue('browserNotifications') ? 'true' : 'false',
                        email_enabled: getElementValue('emailNotifications') ? 'true' : 'false',
                        sms_enabled: getElementValue('smsNotifications') ? 'true' : 'false'
                    },
                    risk: {
                        max_daily_loss: getElementValue('maxDailyLoss'),
                        max_positions: getElementValue('maxPositions'),
                        stop_loss_enabled: getElementValue('stopLoss') ? 'true' : 'false',
                        trailing_stop: getElementValue('trailingStop') ? 'true' : 'false'
                    },
                    data: {
                        retention_days: getElementValue('retentionDays'),
                        auto_backup: getElementValue('autoBackup') ? 'true' : 'false'
                    }
                };

                console.log('Settings to save:', settings);

                const response = await fetch(`${API_BASE}/settings/save`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(settings)
                });

                const data = await response.json();
                
                if (data.status === 'success') {
                    showNotification(`Saved ${data.saved_count} settings successfully!`, 'success');
                    hasChanges = false;
                    currentSettings = settings;
                } else {
                    showNotification('Failed to save settings', 'error');
                }
            } catch (error) {
                console.error('Error saving settings:', error);
                showNotification('Error saving settings: ' + error.message, 'error');
            }
        }

        // Test connection
        async function testConnection() {
            try {
                console.log('Testing connection...');
                showNotification('Testing connection...', 'info');
                
                const response = await fetch(`${API_BASE}/settings/test-connection`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ broker: 'breeze' })
                });

                const data = await response.json();
                
                if (data.status === 'success') {
                    showNotification('Connection successful!', 'success');
                } else {
                    showNotification('Connection failed: ' + data.message, 'error');
                }
            } catch (error) {
                console.error('Error testing connection:', error);
                showNotification('Connection test failed', 'error');
            }
        }

        // Clear cache
        async function clearCache() {
            if (confirm('Are you sure you want to clear the cache?')) {
                try {
                    const response = await fetch(`${API_BASE}/settings/clear-cache`, {
                        method: 'POST'
                    });
                    
                    const data = await response.json();
                    
                    if (data.status === 'success') {
                        showNotification('Cache cleared successfully!', 'success');
                    } else {
                        showNotification('Failed to clear cache', 'error');
                    }
                } catch (error) {
                    console.error('Error clearing cache:', error);
                    showNotification('Error clearing cache', 'error');
                }
            }
        }

        // Export data
        async function exportData() {
            try {
                const response = await fetch(`${API_BASE}/settings/export`);
                const data = await response.json();
                
                // Create download
                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `settings_${Date.now()}.json`;
                a.click();
                URL.revokeObjectURL(url);
                
                showNotification('Settings exported successfully!', 'success');
            } catch (error) {
                console.error('Error exporting data:', error);
                showNotification('Error exporting data', 'error');
            }
        }

        // Reset data
        async function resetData() {
            if (confirm('Are you sure you want to reset all settings to defaults? This cannot be undone!')) {
                try {
                    const response = await fetch(`${API_BASE}/settings/reset`, {
                        method: 'POST'
                    });
                    
                    const data = await response.json();
                    
                    if (data.status === 'success') {
                        showNotification('Settings reset to defaults!', 'success');
                        // Reload settings
                        await loadSettings();
                    } else {
                        showNotification('Failed to reset settings', 'error');
                    }
                } catch (error) {
                    console.error('Error resetting data:', error);
                    showNotification('Error resetting data', 'error');
                }
            }
        }

        // Show/hide API keys
        function showApiKey() {
            const apiKey = document.getElementById('apiKey');
            const apiSecret = document.getElementById('apiSecret');
            
            if (apiKey.type === 'password') {
                apiKey.type = 'text';
                apiSecret.type = 'text';
            } else {
                apiKey.type = 'password';
                apiSecret.type = 'password';
            }
        }

        // Warn before leaving with unsaved changes
        window.addEventListener('beforeunload', function(e) {
            if (hasChanges) {
                e.preventDefault();
                e.returnValue = 'You have unsaved changes. Are you sure you want to leave?';
            }
        });
    </script>
</body>
</html>
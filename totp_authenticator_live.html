<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trading TOTP Authenticator - Live</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            width: 100%;
            max-width: 500px;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 32px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
        }

        .header .subtitle {
            font-size: 16px;
            opacity: 0.9;
        }

        .authenticator-card {
            background: white;
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            margin-bottom: 20px;
            transition: transform 0.3s ease;
        }

        .authenticator-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 25px 70px rgba(0, 0, 0, 0.35);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .broker-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .broker-logo {
            width: 50px;
            height: 50px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            font-weight: bold;
            color: white;
        }

        .kite-logo {
            background: linear-gradient(135deg, #ff5722 0%, #ff9800 100%);
        }

        .breeze-logo {
            background: linear-gradient(135deg, #2196F3 0%, #00BCD4 100%);
        }

        .broker-details h2 {
            font-size: 20px;
            color: #333;
            margin-bottom: 5px;
        }

        .broker-details .account {
            font-size: 14px;
            color: #666;
        }

        .time-indicator {
            position: relative;
            width: 40px;
            height: 40px;
        }

        .circular-progress {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: conic-gradient(#4CAF50 var(--progress), #e0e0e0 var(--progress));
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
            color: #333;
            transition: all 0.5s;
        }

        .totp-display {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 20px;
            text-align: center;
        }

        .totp-codes {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
        }

        .totp-code-group {
            flex: 1;
        }

        .totp-label {
            font-size: 12px;
            color: #999;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 8px;
        }

        .totp-code {
            font-size: 32px;
            font-weight: 700;
            letter-spacing: 5px;
            color: #333;
            font-family: 'Courier New', monospace;
            user-select: all;
            cursor: pointer;
            transition: all 0.3s;
            min-height: 45px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .totp-code:hover {
            color: #667eea;
            transform: scale(1.05);
        }

        .totp-code.loading {
            color: #999;
            font-size: 20px;
            letter-spacing: normal;
        }

        .copy-button {
            padding: 8px 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .copy-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .copy-button.copied {
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
        }

        .status-bar {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            color: #666;
        }

        .status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #4CAF50;
            animation: pulse 2s infinite;
        }

        .status-indicator.error {
            background: #f44336;
            animation: none;
        }

        @keyframes pulse {
            0% {
                box-shadow: 0 0 0 0 rgba(76, 175, 80, 0.7);
            }
            70% {
                box-shadow: 0 0 0 10px rgba(76, 175, 80, 0);
            }
            100% {
                box-shadow: 0 0 0 0 rgba(76, 175, 80, 0);
            }
        }

        .refresh-animation {
            animation: rotate 0.5s ease;
        }

        @keyframes rotate {
            from {
                transform: rotate(0deg);
            }
            to {
                transform: rotate(360deg);
            }
        }

        @keyframes fadeIn {
            from { opacity: 0.3; }
            to { opacity: 1; }
        }

        .toast {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            background: #333;
            color: white;
            padding: 12px 24px;
            border-radius: 50px;
            font-size: 14px;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s;
        }

        .toast.show {
            opacity: 1;
            visibility: visible;
        }

        .api-controls {
            position: fixed;
            top: 20px;
            right: 20px;
            display: flex;
            gap: 10px;
        }

        .control-button {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .control-button:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .control-button.refresh:hover {
            transform: rotate(180deg);
        }

        .error-message {
            color: #f44336;
            font-size: 12px;
            margin-top: 10px;
            text-align: center;
        }

        @media (max-width: 480px) {
            .totp-code {
                font-size: 24px;
                letter-spacing: 3px;
            }
            
            .totp-codes {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>
                <i class="fas fa-shield-alt"></i>
                Trading Authenticator
            </h1>
            <p class="subtitle">Live 2FA Codes for Kite & Breeze</p>
        </div>

        <!-- Kite Card -->
        <div class="authenticator-card">
            <div class="card-header">
                <div class="broker-info">
                    <div class="broker-logo kite-logo">K</div>
                    <div class="broker-details">
                        <h2>Kite (Zerodha)</h2>
                        <span class="account">Trading Account</span>
                    </div>
                </div>
                <div class="time-indicator">
                    <div class="circular-progress" id="kiteProgress">30</div>
                </div>
            </div>
            <div class="totp-display">
                <div class="totp-codes">
                    <div class="totp-code-group">
                        <div class="totp-label">Standard</div>
                        <div class="totp-code" id="kiteCode" onclick="copyCode('kiteCode')">Loading...</div>
                    </div>
                    <div class="totp-code-group">
                        <div class="totp-label">+60s Offset</div>
                        <div class="totp-code" id="kiteCodeOffset" onclick="copyCode('kiteCodeOffset')">Loading...</div>
                    </div>
                </div>
                <button class="copy-button" id="kiteCopyBtn" onclick="copyKiteCode()">
                    <i class="fas fa-copy"></i>
                    Copy Standard
                </button>
                <div class="error-message" id="kiteError"></div>
            </div>
        </div>

        <!-- Breeze Card -->
        <div class="authenticator-card">
            <div class="card-header">
                <div class="broker-info">
                    <div class="broker-logo breeze-logo">B</div>
                    <div class="broker-details">
                        <h2>Breeze (ICICI)</h2>
                        <span class="account">Trading Account</span>
                    </div>
                </div>
                <div class="time-indicator">
                    <div class="circular-progress" id="breezeProgress">30</div>
                </div>
            </div>
            <div class="totp-display">
                <div class="totp-codes">
                    <div class="totp-code-group">
                        <div class="totp-label">Standard</div>
                        <div class="totp-code" id="breezeCode" onclick="copyCode('breezeCode')">Loading...</div>
                    </div>
                    <div class="totp-code-group">
                        <div class="totp-label">+60s Offset</div>
                        <div class="totp-code" id="breezeCodeOffset" onclick="copyCode('breezeCodeOffset')">Loading...</div>
                    </div>
                </div>
                <button class="copy-button" id="breezeCopyBtn" onclick="copyBreezeCode()">
                    <i class="fas fa-copy"></i>
                    Copy +60s (Recommended)
                </button>
                <div class="error-message" id="breezeError"></div>
            </div>
        </div>

        <!-- Status Bar -->
        <div class="status-bar">
            <div class="status-item">
                <span class="status-indicator" id="statusIndicator"></span>
                <span id="statusText">Connecting...</span>
            </div>
            <div class="status-item">
                <i class="fas fa-clock"></i>
                <span id="currentTime">00:00:00</span>
            </div>
        </div>
    </div>

    <!-- API Controls -->
    <div class="api-controls">
        <div class="control-button refresh" onclick="manualRefresh()" title="Manual Refresh">
            <i class="fas fa-sync-alt"></i>
        </div>
        <div class="control-button" onclick="toggleAutoRefresh()" title="Toggle Auto-refresh">
            <i class="fas fa-play" id="autoRefreshIcon"></i>
        </div>
    </div>

    <!-- Toast Notification -->
    <div class="toast" id="toast">Code copied!</div>

    <script>
        // Configuration
        const API_URL = 'http://localhost:8000';
        let autoRefreshEnabled = true;
        let lastFetchTime = 0;

        // Fetch TOTP codes from API
        async function fetchTOTPCodes() {
            try {
                const response = await fetch(`${API_URL}/totp/all`, {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json',
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                lastFetchTime = Date.now();
                return data;
            } catch (error) {
                console.error('Error fetching TOTP codes:', error);
                updateStatus(false, error.message);
                return null;
            }
        }

        // Update codes display
        async function updateCodes() {
            const data = await fetchTOTPCodes();
            
            if (data) {
                // Update Kite codes
                if (data.kite && data.kite.codes) {
                    // Use 'behind' code as primary for Kite (system is 52s behind)
                    document.getElementById('kiteCode').textContent = data.kite.codes.behind || data.kite.codes.standard || '------';
                    document.getElementById('kiteCodeOffset').textContent = data.kite.codes.offset || '------';
                    document.getElementById('kiteError').textContent = '';
                    
                    // Update server timer
                    if (data.kite.codes.time_remaining) {
                        serverTimeRemaining = data.kite.codes.time_remaining;
                        lastServerUpdate = Date.now();
                        isInitialized = true;
                    }
                    
                    // Add animation
                    animateCodeUpdate('kiteCode');
                    animateCodeUpdate('kiteCodeOffset');
                } else {
                    document.getElementById('kiteError').textContent = 'Failed to fetch Kite codes';
                }
                
                // Update Breeze codes
                if (data.breeze && data.breeze.codes) {
                    document.getElementById('breezeCode').textContent = data.breeze.codes.standard || '------';
                    document.getElementById('breezeCodeOffset').textContent = data.breeze.codes.offset || '------';
                    document.getElementById('breezeError').textContent = '';
                    
                    // Add animation
                    animateCodeUpdate('breezeCode');
                    animateCodeUpdate('breezeCodeOffset');
                } else {
                    document.getElementById('breezeError').textContent = 'Failed to fetch Breeze codes';
                }
                
                updateStatus(true, 'Connected');
            } else {
                // Show error state
                document.getElementById('kiteCode').textContent = 'ERROR';
                document.getElementById('kiteCodeOffset').textContent = 'ERROR';
                document.getElementById('breezeCode').textContent = 'ERROR';
                document.getElementById('breezeCodeOffset').textContent = 'ERROR';
                
                document.getElementById('kiteError').textContent = 'API connection failed';
                document.getElementById('breezeError').textContent = 'API connection failed';
                
                updateStatus(false, 'API not running. Start totp_api.py');
            }
        }

        // Animate code update
        function animateCodeUpdate(elementId) {
            const element = document.getElementById(elementId);
            element.style.animation = 'none';
            setTimeout(() => {
                element.style.animation = 'fadeIn 0.5s';
            }, 10);
        }

        // Store server-provided timer
        let serverTimeRemaining = 30;
        let lastServerUpdate = Date.now();
        let isInitialized = false;
        
        // Update progress and time remaining
        function updateProgress() {
            // Don't update timer until we get initial server value
            if (!isInitialized) {
                return;
            }
            
            // Calculate elapsed time since last server update
            const elapsed = Math.floor((Date.now() - lastServerUpdate) / 1000);
            
            // Calculate current time remaining based on server's value
            let timeRemaining = Math.max(1, serverTimeRemaining - elapsed);
            
            // Handle wraparound
            if (timeRemaining <= 1 && elapsed > serverTimeRemaining) {
                // Timer expired, refresh codes
                timeRemaining = 1;
                updateCodes();
            }
            
            const progress = (timeRemaining / 30) * 100;
            
            // Update progress circles
            document.getElementById('kiteProgress').textContent = timeRemaining;
            document.getElementById('kiteProgress').style.setProperty('--progress', progress + '%');
            
            document.getElementById('breezeProgress').textContent = timeRemaining;
            document.getElementById('breezeProgress').style.setProperty('--progress', progress + '%');
            
            // Update codes when timer resets or every 30 seconds
            if (timeRemaining === 30 || (autoRefreshEnabled && timeRemaining === 29)) {
                updateCodes();
            }
        }

        // Update status indicator
        function updateStatus(connected, message) {
            const indicator = document.getElementById('statusIndicator');
            const text = document.getElementById('statusText');
            
            if (connected) {
                indicator.classList.remove('error');
                text.textContent = message || 'Connected';
            } else {
                indicator.classList.add('error');
                text.textContent = message || 'Disconnected';
            }
        }

        // Copy code function
        function copyCode(elementId) {
            const codeElement = document.getElementById(elementId);
            const code = codeElement.textContent;
            
            if (code && code !== 'ERROR' && code !== 'Loading...' && code !== '------') {
                navigator.clipboard.writeText(code).then(() => {
                    showToast('Code copied: ' + code);
                    codeElement.style.animation = 'pulse 0.5s';
                    setTimeout(() => {
                        codeElement.style.animation = '';
                    }, 500);
                });
            }
        }

        // Copy Kite code
        function copyKiteCode() {
            const code = document.getElementById('kiteCode').textContent;
            if (code && code !== 'ERROR' && code !== 'Loading...' && code !== '------') {
                navigator.clipboard.writeText(code).then(() => {
                    const btn = document.getElementById('kiteCopyBtn');
                    btn.classList.add('copied');
                    btn.innerHTML = '<i class="fas fa-check"></i> Copied!';
                    showToast('Kite code copied: ' + code);
                    
                    setTimeout(() => {
                        btn.classList.remove('copied');
                        btn.innerHTML = '<i class="fas fa-copy"></i> Copy Standard';
                    }, 2000);
                });
            }
        }

        // Copy Breeze code
        function copyBreezeCode() {
            const code = document.getElementById('breezeCodeOffset').textContent;
            if (code && code !== 'ERROR' && code !== 'Loading...' && code !== '------') {
                navigator.clipboard.writeText(code).then(() => {
                    const btn = document.getElementById('breezeCopyBtn');
                    btn.classList.add('copied');
                    btn.innerHTML = '<i class="fas fa-check"></i> Copied!';
                    showToast('Breeze code copied: ' + code);
                    
                    setTimeout(() => {
                        btn.classList.remove('copied');
                        btn.innerHTML = '<i class="fas fa-copy"></i> Copy +60s (Recommended)';
                    }, 2000);
                });
            }
        }

        // Show toast notification
        function showToast(message) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.classList.add('show');
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        // Update current time
        function updateCurrentTime() {
            const now = new Date();
            const timeString = now.toLocaleTimeString('en-US', { hour12: false });
            document.getElementById('currentTime').textContent = timeString;
        }

        // Manual refresh
        function manualRefresh() {
            const icon = document.querySelector('.refresh i');
            icon.classList.add('refresh-animation');
            updateCodes();
            showToast('Codes refreshed');
            setTimeout(() => {
                icon.classList.remove('refresh-animation');
            }, 500);
        }

        // Toggle auto-refresh
        function toggleAutoRefresh() {
            autoRefreshEnabled = !autoRefreshEnabled;
            const icon = document.getElementById('autoRefreshIcon');
            
            if (autoRefreshEnabled) {
                icon.className = 'fas fa-pause';
                showToast('Auto-refresh enabled');
            } else {
                icon.className = 'fas fa-play';
                showToast('Auto-refresh disabled');
            }
        }

        // Initialize
        async function init() {
            // Initial load
            await updateCodes();
            updateProgress();
            updateCurrentTime();
            
            // Update progress every second
            setInterval(updateProgress, 1000);
            
            // Update time every second
            setInterval(updateCurrentTime, 1000);
            
            // Check API connectivity every 10 seconds
            setInterval(async () => {
                if (Date.now() - lastFetchTime > 60000) {
                    // If no successful fetch in last minute, try to reconnect
                    await updateCodes();
                }
            }, 10000);
        }

        // Start when page loads
        window.addEventListener('load', init);
    </script>
</body>
</html>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trade Journey Analysis - 5-Minute P&L Tracking</title>
    
    <!-- Chart.js for visualization -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/date-fns@2.29.3/index.min.js"></script>
    
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        .header h1 {
            color: #333;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .header h1 i {
            color: #667eea;
        }

        .subtitle {
            color: #666;
            font-size: 16px;
        }

        .tabs-container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 0;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 2px solid #e5e7eb;
        }

        .tab {
            flex: 1;
            padding: 18px 20px;
            background: none;
            border: none;
            color: #666;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
            text-align: center;
        }

        .tab:hover {
            background: rgba(102, 126, 234, 0.05);
        }

        .tab.active {
            color: #667eea;
            background: white;
        }

        .tab.active::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            right: 0;
            height: 2px;
            background: #667eea;
        }

        .tab i {
            margin-right: 8px;
        }

        .tab-content {
            display: none;
            padding: 25px;
        }

        .tab-content.active {
            display: block;
        }

        .controls {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        .control-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            color: #555;
            font-weight: 600;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .form-group input, .form-group select {
            padding: 10px 15px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s;
        }

        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 15px;
            display: inline-flex;
            align-items: center;
            gap: 10px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 10px;
        }

        .checkbox-group input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .checkbox-group label {
            cursor: pointer;
            color: #555;
            font-weight: 500;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 40px;
            background: white;
            border-radius: 15px;
            margin-bottom: 30px;
        }

        .loading.active {
            display: block;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .results-container {
            display: none;
        }

        .results-container.active {
            display: block;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .positions-selector {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        .position-pills {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 15px;
        }

        .position-pill {
            padding: 8px 16px;
            border-radius: 20px;
            background: #f0f2f5;
            border: 2px solid transparent;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 14px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .position-pill:hover {
            background: #e5e7eb;
        }

        .position-pill.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-color: #667eea;
        }

        .position-pill .badge {
            background: rgba(255, 255, 255, 0.3);
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 11px;
        }

        .position-pill.profit {
            border-color: #10b981;
        }

        .position-pill.loss {
            border-color: #ef4444;
        }

        .position-summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .position-card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
            border-left: 4px solid #667eea;
            transition: transform 0.3s;
        }

        .position-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.12);
        }

        .position-card.profit {
            border-left-color: #10b981;
        }

        .position-card.loss {
            border-left-color: #ef4444;
        }

        .position-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .position-symbol {
            font-size: 16px;
            font-weight: 600;
            color: #333;
        }

        .position-metrics {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-top: 15px;
        }

        .metric-item {
            display: flex;
            flex-direction: column;
        }

        .metric-label {
            font-size: 11px;
            color: #999;
            text-transform: uppercase;
            margin-bottom: 4px;
        }

        .metric-value {
            font-size: 16px;
            font-weight: 600;
            color: #333;
        }

        .comparison-view {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        .results-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            font-size: 14px;
        }

        .results-table thead {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .results-table th {
            padding: 12px 10px;
            text-align: left;
            font-weight: 600;
            white-space: nowrap;
            position: sticky;
            top: 0;
            z-index: 10;
            cursor: pointer;
            user-select: none;
        }

        .results-table th:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .results-table th i {
            margin-left: 5px;
            font-size: 12px;
            opacity: 0.7;
        }

        .results-table tbody tr {
            border-bottom: 1px solid #f0f0f0;
            transition: background 0.2s;
        }

        .results-table tbody tr:hover {
            background: #f8f9fa;
        }

        .results-table td {
            padding: 10px;
            white-space: nowrap;
        }

        .results-table .profit-cell {
            color: #10b981;
            font-weight: 600;
        }

        .results-table .loss-cell {
            color: #ef4444;
            font-weight: 600;
        }

        .results-table .neutral-cell {
            color: #666;
        }

        .status-badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
        }

        .status-win {
            background: #d1fae5;
            color: #065f46;
        }

        .status-loss {
            background: #fee2e2;
            color: #991b1b;
        }

        .status-breakeven {
            background: #f3f4f6;
            color: #374151;
        }

        .summary-row {
            background: #f8f9fa;
            font-weight: 600;
            border-top: 2px solid #e5e7eb;
        }

        .summary-row td {
            padding: 15px 10px;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        .stat-card h3 {
            color: #999;
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 10px;
            font-weight: 600;
        }

        .stat-value {
            font-size: 32px;
            font-weight: 700;
            color: #333;
            margin-bottom: 8px;
        }

        .stat-value.profit {
            color: #10b981;
        }

        .stat-value.loss {
            color: #ef4444;
        }

        .stat-detail {
            color: #666;
            font-size: 14px;
        }

        .chart-container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        .chart-container h2 {
            color: #333;
            margin-bottom: 20px;
            font-size: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .chart-container h2 i {
            color: #667eea;
            font-size: 18px;
        }

        .insights-container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        .insights-container h2 {
            color: #333;
            margin-bottom: 20px;
            font-size: 20px;
        }

        .insight-item {
            background: #f8f9fa;
            border-left: 4px solid #667eea;
            padding: 15px 20px;
            margin-bottom: 15px;
            border-radius: 8px;
        }

        .insight-item h4 {
            color: #333;
            margin-bottom: 8px;
            font-size: 16px;
        }

        .insight-item p {
            color: #666;
            font-size: 14px;
            line-height: 1.6;
        }

        .trade-details {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        .trade-details h2 {
            color: #333;
            margin-bottom: 20px;
            font-size: 20px;
        }

        .trade-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
        }

        .trade-info-item {
            display: flex;
            flex-direction: column;
        }

        .trade-info-item label {
            color: #999;
            font-size: 12px;
            text-transform: uppercase;
            margin-bottom: 5px;
            font-weight: 600;
        }

        .trade-info-item span {
            color: #333;
            font-size: 16px;
            font-weight: 600;
        }

        .error-message {
            background: #fee;
            color: #c33;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
        }

        .error-message.active {
            display: block;
        }

        .breakeven-recommendation {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
        }

        .breakeven-recommendation h4 {
            margin-bottom: 10px;
            font-size: 18px;
        }

        .breakeven-recommendation p {
            font-size: 14px;
            opacity: 0.95;
            line-height: 1.6;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>
                <i class="fas fa-chart-line"></i>
                Trade Journey Analysis
            </h1>
            <p class="subtitle">Track P&L every 5 minutes to understand risk exposure and optimize strategies</p>
        </div>

        <!-- Tabs Container -->
        <div class="tabs-container">
            <div class="tabs">
                <button class="tab active" onclick="switchTab('overview')">
                    <i class="fas fa-chart-line"></i>
                    Journey Overview
                </button>
                <button class="tab" onclick="switchTab('detailed')">
                    <i class="fas fa-microscope"></i>
                    Detailed Analysis
                </button>
                <button class="tab" onclick="switchTab('results')">
                    <i class="fas fa-table"></i>
                    Detailed Results
                </button>
            </div>
            
            <!-- Tab Content: Overview -->
            <div id="overview-tab" class="tab-content active">
                <!-- Controls -->
                <div class="controls" style="background: transparent; box-shadow: none; padding: 0;">
                    <div class="control-group">
                        <div class="form-group">
                            <label for="fromDate">From Date</label>
                            <input type="date" id="fromDate" value="2025-07-13">
                        </div>
                        <div class="form-group">
                            <label for="toDate">To Date</label>
                            <input type="date" id="toDate" value="2025-07-13">
                        </div>
                        <div class="form-group">
                            <label for="signal">Signal Type (Optional)</label>
                            <select id="signal">
                                <option value="">All Signals</option>
                                <option value="S1">S1 - Bear Trap</option>
                                <option value="S2">S2 - Support Hold</option>
                                <option value="S3">S3 - Resistance Hold</option>
                                <option value="S4">S4 - Bias Failure Bull</option>
                                <option value="S5">S5 - Bias Failure Bear</option>
                                <option value="S6">S6 - Weakness Confirmed</option>
                                <option value="S7">S7 - Breakout Confirmed</option>
                                <option value="S8">S8 - Breakdown Confirmed</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="checkbox-group">
                        <input type="checkbox" id="trackJourney" checked>
                        <label for="trackJourney">Enable 5-Minute P&L Tracking</label>
                    </div>

                    <div style="margin-top: 20px;">
                        <button class="btn btn-primary" onclick="runAnalysis()">
                            <i class="fas fa-play"></i>
                            Run Trade Journey Analysis
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Tab Content: Detailed Analysis -->
            <div id="detailed-tab" class="tab-content">
                <div class="detailed-analysis-content">
                    <h3 style="color: #333; margin-bottom: 20px;">
                        <i class="fas fa-microscope" style="color: #667eea;"></i>
                        Minute-by-Minute Analysis
                    </h3>
                    <div id="detailed-table-container">
                        <p style="color: #999; text-align: center; padding: 40px;">
                            Run analysis to see minute-by-minute P&L breakdown
                        </p>
                    </div>
                </div>
            </div>
            
            
            <!-- Tab Content: Detailed Results -->
            <div id="results-tab" class="tab-content">
                <div class="results-table-content">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h3 style="color: #333;">
                            <i class="fas fa-table" style="color: #667eea;"></i>
                            Backtest-Style Results Table
                        </h3>
                        <div style="display: flex; gap: 10px;">
                            <button class="btn btn-primary" onclick="exportToCSV()" style="padding: 8px 16px;">
                                <i class="fas fa-download"></i>
                                Export CSV
                            </button>
                            <select id="resultFilter" onchange="filterResults()" style="
                                padding: 8px 15px;
                                border: 2px solid #e5e7eb;
                                border-radius: 8px;
                                font-size: 14px;
                            ">
                                <option value="all">All Trades</option>
                                <option value="profit">Profitable Only</option>
                                <option value="loss">Loss Only</option>
                            </select>
                        </div>
                    </div>
                    <div id="results-table-container" style="overflow-x: auto;">
                        <p style="color: #999; text-align: center; padding: 40px;">
                            Run analysis to see detailed results table
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Loading -->
        <div class="loading" id="loading">
            <div class="spinner"></div>
            <p>Analyzing trade journeys...</p>
            <p style="color: #999; font-size: 14px; margin-top: 10px;">Tracking P&L at 5-minute intervals</p>
        </div>

        <!-- Error Message -->
        <div class="error-message" id="errorMessage"></div>

        <!-- Results Container -->
        <div class="results-container" id="results">
            <!-- Position Selector -->
            <div class="positions-selector" id="positionsSelector" style="display: none;">
                <h3 style="color: #333; margin-bottom: 10px;">
                    <i class="fas fa-list" style="color: #667eea;"></i>
                    Select Position to Analyze
                </h3>
                <div class="position-pills" id="positionPills"></div>
            </div>

            <!-- Overall Summary -->
            <div class="stats-grid" id="statsGrid"></div>

            <!-- Position Summary Cards -->
            <div class="position-summary-cards" id="positionCards" style="display: none;"></div>

            <!-- Trade Details -->
            <div class="trade-details" id="tradeDetails"></div>

            <!-- P&L Journey Chart -->
            <div class="chart-container">
                <h2>
                    <i class="fas fa-chart-area"></i> 
                    <span id="chartTitle">5-Minute P&L Journey</span>
                </h2>
                <canvas id="journeyChart"></canvas>
            </div>

            <!-- Comparison View -->
            <div class="comparison-view" id="comparisonView" style="display: none;">
                <h2 style="color: #333; margin-bottom: 20px;">
                    <i class="fas fa-balance-scale" style="color: #667eea;"></i>
                    Position Comparison
                </h2>
                <canvas id="comparisonChart"></canvas>
            </div>

            <!-- Insights -->
            <div class="insights-container" id="insights"></div>
        </div>
    </div>

    <script>
        let journeyChart = null;
        let comparisonChart = null;
        const CACHE_KEY = 'tradeJourney_state';
        const CACHE_DURATION = 5 * 60 * 1000; // 5 minutes
        let currentData = null; // Store data for tab switching
        let allTrades = []; // Store all trades
        let selectedPosition = 'all'; // Currently selected position
        
        // Function to destroy all charts
        function destroyAllCharts() {
            if (journeyChart) {
                journeyChart.destroy();
                journeyChart = null;
            }
            if (comparisonChart) {
                comparisonChart.destroy();
                comparisonChart = null;
            }
        }

        // Tab switching function
        function switchTab(tabName) {
            // Destroy charts before switching tabs to prevent accumulation
            destroyAllCharts();
            
            // Update tab buttons
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // Update tab content
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(`${tabName}-tab`).classList.add('active');
            
            // If we have data, update the specific tab content
            if (currentData) {
                if (tabName === 'detailed') {
                    displayDetailedAnalysis(currentData);
                } else if (tabName === 'results') {
                    displayResultsTable(currentData);
                }
            }
        }

        // Select position function
        function selectPosition(position) {
            selectedPosition = position;
            
            // Destroy existing charts before switching positions
            destroyAllCharts();
            
            // Update pill styles
            document.querySelectorAll('.position-pill').forEach(pill => {
                pill.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // Update displays based on selection
            if (position === 'all') {
                displayAllPositions();
            } else {
                displaySinglePosition(position);
            }
        }

        // Save state to localStorage
        function saveState(params, data) {
            const state = {
                params: params,
                data: data,
                timestamp: Date.now()
            };
            try {
                localStorage.setItem(CACHE_KEY, JSON.stringify(state));
                showCacheIndicator();
            } catch (e) {
                console.warn('Could not save to localStorage:', e);
            }
        }

        // Load state from localStorage
        function loadState() {
            try {
                const saved = localStorage.getItem(CACHE_KEY);
                if (saved) {
                    const state = JSON.parse(saved);
                    const age = Date.now() - state.timestamp;
                    
                    if (age < CACHE_DURATION) {
                        return state;
                    } else {
                        // Clear expired cache
                        localStorage.removeItem(CACHE_KEY);
                    }
                }
            } catch (e) {
                console.warn('Could not load from localStorage:', e);
            }
            return null;
        }

        // Clear cached state
        function clearCache() {
            localStorage.removeItem(CACHE_KEY);
            location.reload();
        }

        // Show cache indicator
        function showCacheIndicator() {
            const existing = document.getElementById('cacheIndicator');
            if (existing) existing.remove();
            
            const indicator = document.createElement('div');
            indicator.id = 'cacheIndicator';
            indicator.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: #10b981;
                color: white;
                padding: 10px 20px;
                border-radius: 8px;
                box-shadow: 0 4px 6px rgba(0,0,0,0.1);
                z-index: 1000;
                display: flex;
                align-items: center;
                gap: 10px;
                font-size: 14px;
            `;
            
            const state = loadState();
            const age = state ? Math.floor((Date.now() - state.timestamp) / 1000) : 0;
            const timeAgo = age < 60 ? `${age}s ago` : `${Math.floor(age/60)}m ago`;
            
            indicator.innerHTML = `
                <i class="fas fa-database"></i>
                <span>Showing cached results from ${timeAgo}</span>
                <button onclick="clearCache()" style="
                    background: white;
                    color: #10b981;
                    border: none;
                    padding: 4px 8px;
                    border-radius: 4px;
                    cursor: pointer;
                    font-size: 12px;
                ">Clear & Refresh</button>
            `;
            
            document.body.appendChild(indicator);
            
            // Auto-hide after 5 seconds
            setTimeout(() => {
                if (indicator.parentNode) {
                    indicator.style.transition = 'opacity 0.5s';
                    indicator.style.opacity = '0';
                    setTimeout(() => indicator.remove(), 500);
                }
            }, 5000);
        }

        async function runAnalysis() {
            // Destroy any existing charts before running new analysis
            destroyAllCharts();
            
            const fromDate = document.getElementById('fromDate').value;
            const toDate = document.getElementById('toDate').value;
            const trackJourney = document.getElementById('trackJourney').checked;
            
            if (!fromDate || !toDate) {
                showError('Please select both from and to dates');
                return;
            }

            const params = { fromDate, toDate, trackJourney };

            // Show loading
            document.getElementById('loading').classList.add('active');
            document.getElementById('results').classList.remove('active');
            document.getElementById('errorMessage').classList.remove('active');

            try {
                // Add cache buster to prevent stale data
                const response = await fetch('http://localhost:8000/ml/validate?t=' + Date.now(), {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Cache-Control': 'no-cache'
                    },
                    body: JSON.stringify({
                        from_date: fromDate,
                        to_date: toDate,
                        track_trade_journey: trackJourney
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                
                // Save state after successful fetch
                saveState(params, data);
                
                displayResults(data);
            } catch (error) {
                showError(`Error: ${error.message}`);
            } finally {
                document.getElementById('loading').classList.remove('active');
            }
        }

        function displayResults(data) {
            currentData = data; // Store for tab switching
            
            // Safe access with error handling
            if (!data || !data.trade_journey_analysis) {
                showStatus('No trade journey data available', 'error');
                return;
            }
            
            const journey = data.trade_journey_analysis;
            const summary = journey.summary || {};
            const metrics = summary.average_metrics || {
                max_profit: 0,
                max_drawdown: 0,
                time_to_max_profit_minutes: 0,
                time_to_max_drawdown_minutes: 0,
                risk_reward_actual: 0,
                risk_reward_potential: 0
            };
            const trades = journey.trades || [];
            allTrades = trades; // Store all trades
            
            // Display position selector if multiple trades
            if (trades.length > 1) {
                displayPositionSelector(trades);
                displayPositionCards(trades);
                displayComparisonChart(trades);
            } else {
                document.getElementById('positionsSelector').style.display = 'none';
                document.getElementById('positionCards').style.display = 'none';
                document.getElementById('comparisonView').style.display = 'none';
            }
            
            // Display Stats
            displayStats(metrics, summary);
            
            // Display Trade Details
            if (trades.length > 0) {
                if (selectedPosition === 'all' && trades.length > 1) {
                    displayAllPositions();
                } else {
                    displayTradeDetails(trades[0]);
                    displayPnLChart(trades[0]);
                }
            }
            
            // Display Insights
            displayInsights(summary, data.risk_profile);
            
            // Populate other tabs if they're active
            const activeTab = document.querySelector('.tab.active');
            if (activeTab && activeTab.textContent.includes('Detailed')) {
                displayDetailedAnalysis(data);
            }
            
            // Show results
            document.getElementById('results').classList.add('active');
        }

        // Display position selector pills
        function displayPositionSelector(trades) {
            const container = document.getElementById('positionsSelector');
            container.style.display = 'block';
            
            let pillsHTML = `
                <div class="position-pill active" onclick="selectPosition('all')">
                    <i class="fas fa-layer-group"></i>
                    All Positions
                    <span class="badge">${trades.length}</span>
                </div>
            `;
            
            trades.forEach((trade, index) => {
                const pnl = trade.exit_pnl || trade.net_pnl || 0;
                const pnlClass = pnl >= 0 ? 'profit' : 'loss';
                const signal = trade.signal_type || trade.signal || `Trade ${index + 1}`;
                const strike = trade.main_strike || '';
                const optionType = trade.option_type || '';
                const symbol = strike ? `${strike} ${optionType}` : 'NIFTY';
                
                pillsHTML += `
                    <div class="position-pill ${pnlClass}" onclick="selectPosition(${index})">
                        <i class="fas fa-chart-line"></i>
                        ${signal} - ${symbol}
                        <span class="badge">${pnl >= 0 ? '+' : ''}₹${formatNumber(pnl)}</span>
                    </div>
                `;
            });
            
            document.getElementById('positionPills').innerHTML = pillsHTML;
        }

        // Display position summary cards
        function displayPositionCards(trades) {
            const container = document.getElementById('positionCards');
            container.style.display = 'grid';
            
            let cardsHTML = '';
            
            trades.forEach((trade, index) => {
                const pnl = trade.exit_pnl || trade.net_pnl || 0;
                const cardClass = pnl >= 0 ? 'profit' : 'loss';
                const signal = trade.signal_type || trade.signal || `Trade ${index + 1}`;
                const entryTime = trade.entry_time || 'N/A';
                const exitTime = trade.exit_time || 'N/A';
                const maxProfit = trade.highest_profit?.amount || 0;
                const maxLoss = trade.highest_loss?.amount || 0;
                const strike = trade.main_strike || '';
                const optionType = trade.option_type || '';
                const hedgeStrike = trade.hedge_strike || '';
                
                cardsHTML += `
                    <div class="position-card ${cardClass}">
                        <div class="position-header">
                            <div>
                                <div class="position-symbol">${signal}</div>
                                <div style="font-size: 13px; color: #666; margin-top: 4px;">
                                    ${strike ? `${strike} ${optionType}` : ''}
                                    ${hedgeStrike ? ` | Hedge: ${hedgeStrike} ${optionType}` : ''}
                                </div>
                            </div>
                            <div style="color: ${pnl >= 0 ? '#10b981' : '#ef4444'}; font-size: 20px; font-weight: bold;">
                                ${pnl >= 0 ? '+' : ''}₹${formatNumber(pnl)}
                            </div>
                        </div>
                        <div class="position-metrics">
                            <div class="metric-item">
                                <span class="metric-label">Entry Time</span>
                                <span class="metric-value">${entryTime}</span>
                            </div>
                            <div class="metric-item">
                                <span class="metric-label">Exit Time</span>
                                <span class="metric-value">${exitTime}</span>
                            </div>
                            <div class="metric-item">
                                <span class="metric-label">Max Profit</span>
                                <span class="metric-value" style="color: #10b981;">₹${formatNumber(maxProfit)}</span>
                            </div>
                            <div class="metric-item">
                                <span class="metric-label">Max Loss</span>
                                <span class="metric-value" style="color: #ef4444;">₹${formatNumber(maxLoss)}</span>
                            </div>
                        </div>
                        <button class="btn btn-primary" style="width: 100%; margin-top: 15px;" onclick="selectPosition(${index})">
                            <i class="fas fa-search"></i> View Details
                        </button>
                    </div>
                `;
            });
            
            container.innerHTML = cardsHTML;
        }

        // Display single position details
        function displaySinglePosition(index) {
            const trade = allTrades[index];
            if (!trade) return;
            
            // Destroy existing charts before displaying new position
            destroyAllCharts();
            
            const signal = trade.signal_type || trade.signal || 'Trade';
            const strike = trade.main_strike || '';
            const optionType = trade.option_type || '';
            const optionDetails = strike ? ` (${strike} ${optionType})` : '';
            
            // Update chart title
            document.getElementById('chartTitle').textContent = `${signal}${optionDetails} - 5-Minute P&L Journey`;
            
            // Hide comparison view, show individual views
            document.getElementById('comparisonView').style.display = 'none';
            document.getElementById('positionCards').style.display = 'none';
            
            // Display individual trade details
            displayTradeDetails(trade);
            displayPnLChart(trade);
        }

        // Display all positions overview
        function displayAllPositions() {
            // Destroy existing charts before displaying all positions
            destroyAllCharts();
            
            // Update chart title
            document.getElementById('chartTitle').textContent = 'All Positions - Combined P&L Journey';
            
            // Show comparison and cards
            document.getElementById('comparisonView').style.display = 'block';
            document.getElementById('positionCards').style.display = 'grid';
            
            // Display combined chart
            displayCombinedPnLChart(allTrades);
        }

        // Display combined P&L chart for all positions
        function displayCombinedPnLChart(trades) {
            const ctx = document.getElementById('journeyChart').getContext('2d');
            
            if (journeyChart) {
                journeyChart.destroy();
            }
            
            // Prepare datasets for each trade
            const datasets = trades.map((trade, index) => {
                const chartData = trade.pnl_chart || [];
                const signal = trade.signal_type || trade.signal || `Trade ${index + 1}`;
                const strike = trade.main_strike || '';
                const optionType = trade.option_type || '';
                const label = strike ? `${signal} (${strike} ${optionType})` : signal;
                const colors = ['#667eea', '#10b981', '#f59e0b', '#ef4444', '#3b82f6', '#8b5cf6'];
                const color = colors[index % colors.length];
                
                return {
                    label: label,
                    data: chartData.map(p => p.pnl),
                    borderColor: color,
                    backgroundColor: `${color}20`,
                    tension: 0.2,
                    fill: false,
                    pointRadius: 2,
                };
            });
            
            // Get common time labels
            const timeLabels = trades[0]?.pnl_chart?.map(p => p.time) || [];
            
            // Destroy existing chart before creating new one
            if (journeyChart) {
                journeyChart.destroy();
                journeyChart = null;
            }
            
            journeyChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: timeLabels,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `${context.dataset.label}: ₹${formatNumber(context.parsed.y)}`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)'
                            },
                            ticks: {
                                callback: function(value) {
                                    return '₹' + formatNumber(value);
                                }
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            }
                        }
                    }
                }
            });
            
            ctx.canvas.style.height = '400px';
        }

        // Display comparison chart
        function displayComparisonChart(trades) {
            const ctx = document.getElementById('comparisonChart')?.getContext('2d');
            if (!ctx) return;
            
            if (comparisonChart) {
                comparisonChart.destroy();
            }
            
            const labels = trades.map((t, i) => t.signal_type || t.signal || `Trade ${i + 1}`);
            const finalPnL = trades.map(t => t.exit_pnl || t.net_pnl || 0);
            const maxProfit = trades.map(t => t.highest_profit?.amount || 0);
            const maxLoss = trades.map(t => Math.abs(t.highest_loss?.amount || 0));
            
            // Destroy existing comparison chart before creating new one
            if (comparisonChart) {
                comparisonChart.destroy();
                comparisonChart = null;
            }
            
            comparisonChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Final P&L',
                            data: finalPnL,
                            backgroundColor: finalPnL.map(v => v >= 0 ? '#10b98180' : '#ef444480'),
                            borderColor: finalPnL.map(v => v >= 0 ? '#10b981' : '#ef4444'),
                            borderWidth: 2
                        },
                        {
                            label: 'Max Profit',
                            data: maxProfit,
                            backgroundColor: '#10b98130',
                            borderColor: '#10b981',
                            borderWidth: 1
                        },
                        {
                            label: 'Max Drawdown',
                            data: maxLoss,
                            backgroundColor: '#ef444430',
                            borderColor: '#ef4444',
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '₹' + formatNumber(Math.abs(value));
                                }
                            }
                        }
                    }
                }
            });
            
            ctx.canvas.style.height = '300px';
        }

        // Display detailed minute-by-minute analysis
        function displayDetailedAnalysis(data) {
            if (!data || !data.trade_journey_analysis) return;
            
            const trades = data.trade_journey_analysis.trades || [];
            if (trades.length === 0) {
                document.getElementById('detailed-table-container').innerHTML = 
                    '<p style="color: #999; text-align: center; padding: 40px;">No trade data available</p>';
                return;
            }
            
            // If multiple trades, show selector
            if (trades.length > 1) {
                let selectorHTML = `
                    <div style="margin-bottom: 20px;">
                        <label style="color: #666; font-weight: 600; margin-right: 10px;">Select Position:</label>
                        <select id="detailedPositionSelect" onchange="updateDetailedTable()" style="
                            padding: 8px 15px;
                            border: 2px solid #e5e7eb;
                            border-radius: 8px;
                            font-size: 14px;
                            cursor: pointer;
                        ">
                `;
                
                trades.forEach((trade, index) => {
                    const signal = trade.signal || `Trade ${index + 1}`;
                    selectorHTML += `<option value="${index}">${signal}</option>`;
                });
                
                selectorHTML += `
                        </select>
                    </div>
                    <div id="detailedTableContent"></div>
                `;
                
                document.getElementById('detailed-table-container').innerHTML = selectorHTML;
                updateDetailedTable();
            } else {
                // Single trade
                displayDetailedTableForTrade(trades[0], 'detailed-table-container');
            }
        }

        // Update detailed table based on selection
        function updateDetailedTable() {
            const select = document.getElementById('detailedPositionSelect');
            if (!select) return;
            
            const index = parseInt(select.value);
            const trade = allTrades[index];
            if (!trade) return;
            
            displayDetailedTableForTrade(trade, 'detailedTableContent');
        }

        // Display detailed table for a specific trade
        function displayDetailedTableForTrade(trade, containerId) {
            const chartData = trade.pnl_chart || trade.pnl_journey || [];
            
            // Filter out non-market hours and 0 entries after trade exit
            const exitTime = trade.exit_time;
            const filteredData = chartData.filter(point => {
                // Get time from datetime or time field
                const timeStr = point.datetime || point.time || '';
                if (!timeStr) return false;
                
                // Skip 0 entries after first non-zero
                if (point.pnl === 0 && chartData.findIndex(p => p.pnl !== 0) < chartData.indexOf(point)) {
                    return false;
                }
                
                return true;
            });
            
            let tableHTML = `
                <div style="overflow-x: auto; max-height: 600px;">
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead style="position: sticky; top: 0; background: white; z-index: 10;">
                            <tr style="background: #f8f9fa;">
                                <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e5e7eb;">Time</th>
                                <th style="padding: 12px; text-align: right; border-bottom: 2px solid #e5e7eb;">P&L</th>
                                <th style="padding: 12px; text-align: right; border-bottom: 2px solid #e5e7eb;">Change</th>
                                <th style="padding: 12px; text-align: right; border-bottom: 2px solid #e5e7eb;">% from Entry</th>
                                <th style="padding: 12px; text-align: center; border-bottom: 2px solid #e5e7eb;">Status</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            let prevPnl = 0;
            filteredData.forEach((point, index) => {
                const change = index > 0 ? point.pnl - prevPnl : 0;
                const percentFromEntry = point.pnl ? ((point.pnl / 750) * 100).toFixed(2) : '0.00';
                const status = point.pnl > 0 ? 'Profit' : point.pnl < 0 ? 'Loss' : 'Breakeven';
                const statusColor = point.pnl > 0 ? '#10b981' : point.pnl < 0 ? '#ef4444' : '#666';
                
                // Get display time
                const displayTime = point.datetime || point.time || 'N/A';
                
                tableHTML += `
                    <tr style="border-bottom: 1px solid #f0f0f0;">
                        <td style="padding: 10px;">${displayTime}</td>
                        <td style="padding: 10px; text-align: right; color: ${statusColor}; font-weight: 600;">
                            ₹${formatNumber(point.pnl)}
                        </td>
                        <td style="padding: 10px; text-align: right; color: ${change >= 0 ? '#10b981' : '#ef4444'};">
                            ${change >= 0 ? '+' : ''}₹${formatNumber(change)}
                        </td>
                        <td style="padding: 10px; text-align: right;">${percentFromEntry}%</td>
                        <td style="padding: 10px; text-align: center;">
                            <span style="padding: 4px 8px; border-radius: 4px; font-size: 12px; background: ${statusColor}20; color: ${statusColor};">
                                ${status}
                            </span>
                        </td>
                    </tr>
                `;
                prevPnl = point.pnl;
            });
            
            tableHTML += `
                        </tbody>
                    </table>
                </div>
            `;
            
            document.getElementById(containerId).innerHTML = tableHTML;
        }


        function displayStats(metrics, summary) {
            // Get risk metrics from first trade if available
            const firstTrade = allTrades && allTrades.length > 0 ? allTrades[0] : null;
            const riskMetrics = firstTrade?.risk_metrics || {};
            
            const statsHTML = `
                <div class="stat-card">
                    <h3>Maximum Profit</h3>
                    <div class="stat-value profit">₹${formatNumber(metrics.max_profit)}</div>
                    <div class="stat-detail">At ${metrics.time_to_max_profit_minutes} minutes</div>
                </div>
                <div class="stat-card">
                    <h3>Maximum Drawdown</h3>
                    <div class="stat-value loss">₹${formatNumber(metrics.max_drawdown)}</div>
                    <div class="stat-detail">At ${metrics.time_to_max_drawdown_minutes} minutes</div>
                </div>
                <div class="stat-card">
                    <h3>Risk-Reward Actual</h3>
                    <div class="stat-value">${riskMetrics.actual_risk_reward ? riskMetrics.actual_risk_reward.toFixed(2) : '0.00'}x</div>
                    <div class="stat-detail">What actually happened</div>
                </div>
                <div class="stat-card">
                    <h3>Risk-Reward Potential</h3>
                    <div class="stat-value">${riskMetrics.potential_risk_reward ? riskMetrics.potential_risk_reward.toFixed(2) : '0.00'}x</div>
                    <div class="stat-detail">Best possible outcome</div>
                </div>
                <div class="stat-card">
                    <h3>Profit Capture</h3>
                    <div class="stat-value">${summary.risk_insights?.profit_capture_efficiency || 0}%</div>
                    <div class="stat-detail">Of maximum potential</div>
                </div>
                <div class="stat-card">
                    <h3>Trades Analyzed</h3>
                    <div class="stat-value">${summary.total_trades}</div>
                    <div class="stat-detail">With 5-min tracking</div>
                </div>
            `;
            document.getElementById('statsGrid').innerHTML = statsHTML;
        }

        function displayTradeDetails(trade) {
            const signal = trade.signal_type || trade.signal || 'N/A';
            const mainStrike = trade.main_strike || 'N/A';
            const hedgeStrike = trade.hedge_strike || 'None';
            const optionType = trade.option_type || '';
            const entryPrice = trade.entry_price || 0;
            const exitPrice = trade.exit_price || 0;
            const quantity = trade.quantity || 750;
            const finalPnL = trade.exit_pnl || trade.net_pnl || 0;
            
            const html = `
                <h2>Trade Journey Details</h2>
                <div class="trade-info">
                    <div class="trade-info-item">
                        <label>Signal</label>
                        <span style="font-weight: 600; color: #667eea;">${signal}</span>
                    </div>
                    <div class="trade-info-item">
                        <label>Main Option</label>
                        <span>${mainStrike} ${optionType}</span>
                    </div>
                    <div class="trade-info-item">
                        <label>Hedge Option</label>
                        <span>${hedgeStrike} ${hedgeStrike !== 'None' ? optionType : ''}</span>
                    </div>
                    <div class="trade-info-item">
                        <label>Quantity</label>
                        <span>${quantity}</span>
                    </div>
                    <div class="trade-info-item">
                        <label>Entry Time</label>
                        <span>${trade.entry_time || 'N/A'}</span>
                    </div>
                    <div class="trade-info-item">
                        <label>Entry Price</label>
                        <span>₹${(entryPrice || 0).toFixed(2)}</span>
                    </div>
                    <div class="trade-info-item">
                        <label>Exit Time</label>
                        <span>${trade.exit_time || 'N/A'}</span>
                    </div>
                    <div class="trade-info-item">
                        <label>Exit Price</label>
                        <span>₹${(exitPrice || 0).toFixed(2)}</span>
                    </div>
                    <div class="trade-info-item">
                        <label>Highest Profit</label>
                        <span style="color: #10b981;">₹${formatNumber(trade.highest_profit?.amount || 0)}</span>
                    </div>
                    <div class="trade-info-item">
                        <label>Profit Time</label>
                        <span>
                            ${trade.highest_profit?.day || ''} ${trade.highest_profit?.datetime || 'N/A'}
                            <div style="font-size: 11px; color: #999; margin-top: 2px;">
                                Main: ₹${formatNumber(trade.highest_profit?.main_pnl || 0)} | 
                                Hedge: ₹${formatNumber(trade.highest_profit?.hedge_pnl || 0)}
                            </div>
                        </span>
                    </div>
                    <div class="trade-info-item">
                        <label>Highest Loss</label>
                        <span style="color: #ef4444;">₹${formatNumber(trade.highest_loss?.amount || 0)}</span>
                    </div>
                    <div class="trade-info-item">
                        <label>Loss Time</label>
                        <span>
                            ${trade.highest_loss?.day || ''} ${trade.highest_loss?.datetime || 'N/A'}
                            <div style="font-size: 11px; color: #999; margin-top: 2px;">
                                Main: ₹${formatNumber(trade.highest_loss?.main_pnl || 0)} | 
                                Hedge: ₹${formatNumber(trade.highest_loss?.hedge_pnl || 0)}
                            </div>
                        </span>
                    </div>
                    <div class="trade-info-item" style="grid-column: span 2;">
                        <label>Final P&L</label>
                        <span style="font-size: 20px; font-weight: 600; color: ${finalPnL >= 0 ? '#10b981' : '#ef4444'};">
                            ${finalPnL >= 0 ? '+' : ''}₹${formatNumber(finalPnL)}
                        </span>
                    </div>
                </div>
            `;
            document.getElementById('tradeDetails').innerHTML = html;
        }

        function displayPnLChart(trade) {
            const ctx = document.getElementById('journeyChart').getContext('2d');
            
            // Destroy existing chart if any
            if (journeyChart) {
                journeyChart.destroy();
                journeyChart = null;
            }
            
            const chartData = trade.pnl_chart || trade.pnl_journey || [];
            
            // Verify data quality
            if (chartData.length > 0) {
                const pnls = chartData.map(p => p.pnl);
                let ups = 0, downs = 0;
                for (let i = 1; i < pnls.length; i++) {
                    if (pnls[i] > pnls[i-1]) ups++;
                    else if (pnls[i] < pnls[i-1]) downs++;
                }
                console.log(`P&L Data: ${chartData.length} points, ${ups} ups, ${downs} downs`);
                console.log(`Range: ${Math.min(...pnls)} to ${Math.max(...pnls)}`);
            }
            
            journeyChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: chartData.map(p => p.date ? `${p.date} ${p.time}` : p.time),
                    datasets: [{
                        label: 'P&L Journey',
                        data: chartData.map(p => p.pnl),
                        borderColor: 'rgb(102, 126, 234)',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        tension: 0.2,
                        fill: true,
                        pointRadius: 3,
                        pointBackgroundColor: chartData.map(p => p.pnl >= 0 ? '#10b981' : '#ef4444'),
                        pointBorderColor: chartData.map(p => p.pnl >= 0 ? '#10b981' : '#ef4444'),
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                title: function(context) {
                                    const point = chartData[context[0].dataIndex];
                                    return point.datetime || `${point.date || ''} ${point.time}`;
                                },
                                label: function(context) {
                                    const value = context.parsed.y;
                                    const point = chartData[context.dataIndex];
                                    return `P&L: ₹${formatNumber(value)}`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)'
                            },
                            ticks: {
                                callback: function(value) {
                                    return '₹' + formatNumber(value);
                                }
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            }
                        }
                    }
                }
            });
            
            // Set chart height
            ctx.canvas.style.height = '400px';
        }

        function displayInsights(summary, riskProfile) {
            let html = '<h2>Trade Analysis Results</h2>';
            
            // Only show ACTUAL data from real trades
            if (riskProfile && riskProfile.per_trade_risk) {
                const risk = riskProfile.per_trade_risk;
                html += `
                    <div class="insight-item">
                        <h4><i class="fas fa-chart-bar"></i> Actual Performance Metrics</h4>
                        <p>Based on ${risk.data_points || 0} actual trades analyzed:</p>
                        <p style="margin-top: 10px;">
                            <strong>Average Maximum Profit:</strong> ₹${formatNumber(risk.average_max_profit)}<br>
                            <strong>Average Maximum Loss:</strong> ₹${formatNumber(risk.average_max_loss)}<br>
                            <strong>Time to Peak Profit:</strong> ${risk.time_to_max_profit_minutes} minutes<br>
                            <strong>Time to Maximum Drawdown:</strong> ${risk.time_to_max_loss_minutes} minutes
                        </p>
                    </div>
                `;
            } else if (summary && summary.total_trades > 0) {
                // Show basic summary if available
                const metrics = summary.average_metrics || {};
                html += `
                    <div class="insight-item">
                        <h4><i class="fas fa-chart-bar"></i> Trade Summary</h4>
                        <p>Total trades analyzed: ${summary.total_trades}</p>
                        <p style="margin-top: 10px;">
                            <strong>Average Max Profit:</strong> ₹${formatNumber(metrics.max_profit || 0)}<br>
                            <strong>Average Max Drawdown:</strong> ₹${formatNumber(metrics.max_drawdown || 0)}<br>
                            <strong>Time to Max Profit:</strong> ${metrics.time_to_max_profit_minutes || 0} minutes<br>
                            <strong>Time to Max Drawdown:</strong> ${metrics.time_to_max_drawdown_minutes || 0} minutes
                        </p>
                    </div>
                `;
            } else {
                html += `
                    <div class="insight-item">
                        <p style="color: #999;">No trade data available for analysis</p>
                    </div>
                `;
            }
            
            document.getElementById('insights').innerHTML = html;
        }

        // Display results table
        function displayResultsTable(data) {
            if (!data || !data.trade_journey_analysis) return;
            
            const trades = data.trade_journey_analysis.trades || [];
            if (trades.length === 0) {
                document.getElementById('results-table-container').innerHTML = 
                    '<p style="color: #999; text-align: center; padding: 40px;">No trade data available</p>';
                return;
            }
            
            let tableHTML = `
                <table class="results-table" id="resultsDataTable">
                    <thead>
                        <tr>
                            <th onclick="sortTable(0)">Trade # <i class="fas fa-sort"></i></th>
                            <th onclick="sortTable(1)">Signal <i class="fas fa-sort"></i></th>
                            <th onclick="sortTable(2)">Entry Time <i class="fas fa-sort"></i></th>
                            <th onclick="sortTable(3)">Entry Price <i class="fas fa-sort"></i></th>
                            <th onclick="sortTable(4)">Exit Time <i class="fas fa-sort"></i></th>
                            <th onclick="sortTable(5)">Exit Price <i class="fas fa-sort"></i></th>
                            <th onclick="sortTable(6)">Main Option <i class="fas fa-sort"></i></th>
                            <th onclick="sortTable(7)">Hedge Option <i class="fas fa-sort"></i></th>
                            <th onclick="sortTable(8)">Quantity <i class="fas fa-sort"></i></th>
                            <th onclick="sortTable(9)">Max Profit <i class="fas fa-sort"></i></th>
                            <th onclick="sortTable(10)">Max Profit Time <i class="fas fa-sort"></i></th>
                            <th onclick="sortTable(11)">Max Loss <i class="fas fa-sort"></i></th>
                            <th onclick="sortTable(12)">Max Loss Time <i class="fas fa-sort"></i></th>
                            <th onclick="sortTable(13)">Wed P&L <i class="fas fa-sort"></i></th>
                            <th onclick="sortTable(14)">Final P&L <i class="fas fa-sort"></i></th>
                            <th onclick="sortTable(15)">Status <i class="fas fa-sort"></i></th>
                            <th onclick="sortTable(16)">Duration <i class="fas fa-sort"></i></th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            let totalPnL = 0;
            let totalWins = 0;
            let totalLosses = 0;
            let totalMaxProfit = 0;
            let totalMaxLoss = 0;
            
            trades.forEach((trade, index) => {
                const tradeNum = index + 1;
                const signal = trade.signal_type || trade.signal || `Trade ${tradeNum}`;
                const entryTime = trade.entry_time || 'N/A';
                const entryPrice = trade.entry_price || 0;
                const exitTime = trade.exit_time || 'N/A';
                const exitPrice = trade.exit_price || 0;
                const mainOption = trade.main_strike ? `${trade.main_strike} ${trade.option_type || 'CE'}` : 'N/A';
                const hedgeOption = trade.hedge_strike ? `${trade.hedge_strike} ${trade.option_type || 'CE'}` : 'None';
                const quantity = trade.quantity || 750;
                const maxProfit = trade.highest_profit?.amount || 0;
                const maxProfitDay = trade.highest_profit?.day || '';
                const maxProfitTime = trade.highest_profit?.datetime || 'N/A';
                const maxProfitMain = trade.highest_profit?.main_pnl || 0;
                const maxProfitHedge = trade.highest_profit?.hedge_pnl || 0;
                
                const maxLoss = Math.abs(trade.highest_loss?.amount || 0);
                const maxLossDay = trade.highest_loss?.day || '';
                const maxLossTime = trade.highest_loss?.datetime || 'N/A';
                const maxLossMain = trade.highest_loss?.main_pnl || 0;
                const maxLossHedge = trade.highest_loss?.hedge_pnl || 0;
                const wednesdayPnL = trade.wednesday_pnl?.amount || null;
                const wednesdayTime = trade.wednesday_pnl?.datetime || null;
                const finalPnL = trade.exit_pnl || trade.net_pnl || 0;
                
                // Calculate duration
                let duration = 'N/A';
                if (entryTime !== 'N/A' && exitTime !== 'N/A') {
                    // Handle both formats: "11:15:00" and "2025-07-14 11:15"
                    let entryDate, exitDate;
                    
                    if (entryTime.includes(' ')) {
                        // Full datetime format
                        entryDate = new Date(entryTime);
                        exitDate = new Date(exitTime);
                    } else {
                        // Time only format - use same day
                        entryDate = new Date(`2025-01-01 ${entryTime}`);
                        exitDate = new Date(`2025-01-01 ${exitTime}`);
                    }
                    
                    const diffMs = exitDate - entryDate;
                    if (!isNaN(diffMs) && diffMs >= 0) {
                        const totalMinutes = Math.floor(diffMs / 60000);
                        const days = Math.floor(totalMinutes / 1440);
                        const hours = Math.floor((totalMinutes % 1440) / 60);
                        const minutes = totalMinutes % 60;
                        
                        if (days > 0) {
                            duration = `${days}d ${hours}h ${minutes}m`;
                        } else {
                            duration = `${hours}h ${minutes}m`;
                        }
                    }
                }
                
                const status = finalPnL > 0 ? 'Win' : finalPnL < 0 ? 'Loss' : 'Breakeven';
                const statusClass = finalPnL > 0 ? 'status-win' : finalPnL < 0 ? 'status-loss' : 'status-breakeven';
                const pnlClass = finalPnL >= 0 ? 'profit-cell' : 'loss-cell';
                
                // Update totals
                totalPnL += finalPnL;
                if (finalPnL > 0) totalWins++;
                else if (finalPnL < 0) totalLosses++;
                totalMaxProfit += maxProfit;
                totalMaxLoss += maxLoss;
                
                tableHTML += `
                    <tr data-status="${status.toLowerCase()}">
                        <td>${tradeNum}</td>
                        <td>${signal}</td>
                        <td>${entryTime}</td>
                        <td>₹${(entryPrice || 0).toFixed(2)}</td>
                        <td>${exitTime}</td>
                        <td>₹${(exitPrice || 0).toFixed(2)}</td>
                        <td>${mainOption}</td>
                        <td>${hedgeOption}</td>
                        <td>${quantity}</td>
                        <td class="profit-cell" title="Main: ₹${formatNumber(maxProfitMain)} | Hedge: ₹${formatNumber(maxProfitHedge)}">
                            ₹${formatNumber(maxProfit)}
                        </td>
                        <td title="${maxProfitDay}">${maxProfitTime}</td>
                        <td class="loss-cell" title="Main: ₹${formatNumber(maxLossMain)} | Hedge: ₹${formatNumber(maxLossHedge)}">
                            ₹${formatNumber(maxLoss)}
                        </td>
                        <td title="${maxLossDay}">${maxLossTime}</td>
                        <td class="${wednesdayPnL !== null ? (wednesdayPnL >= 0 ? 'profit-cell' : 'loss-cell') : ''}" title="${wednesdayTime || 'No Wednesday data'}">
                            ${wednesdayPnL !== null ? (wednesdayPnL >= 0 ? '+' : '') + '₹' + formatNumber(Math.abs(wednesdayPnL)) : 'N/A'}
                        </td>
                        <td class="${pnlClass}">${finalPnL >= 0 ? '+' : ''}₹${formatNumber(finalPnL)}</td>
                        <td><span class="status-badge ${statusClass}">${status}</span></td>
                        <td>${duration}</td>
                    </tr>
                `;
            });
            
            // Add summary row
            const winRate = trades.length > 0 ? ((totalWins / trades.length) * 100).toFixed(1) : '0.0';
            tableHTML += `
                    </tbody>
                    <tfoot>
                        <tr class="summary-row">
                            <td colspan="9"><strong>TOTAL</strong></td>
                            <td class="profit-cell">₹${formatNumber(totalMaxProfit)}</td>
                            <td>-</td>
                            <td class="loss-cell">₹${formatNumber(totalMaxLoss)}</td>
                            <td>-</td>
                            <td>-</td>
                            <td class="${totalPnL >= 0 ? 'profit-cell' : 'loss-cell'}">
                                ${totalPnL >= 0 ? '+' : ''}₹${formatNumber(totalPnL)}
                            </td>
                            <td colspan="2">
                                Win Rate: ${winRate}% (${totalWins}W/${totalLosses}L)
                            </td>
                        </tr>
                    </tfoot>
                </table>
            `;
            
            document.getElementById('results-table-container').innerHTML = tableHTML;
        }

        // Sort table function
        function sortTable(columnIndex) {
            const table = document.getElementById('resultsDataTable');
            if (!table) return;
            
            const tbody = table.querySelector('tbody');
            const rows = Array.from(tbody.querySelectorAll('tr'));
            
            // Determine sort order
            const th = table.querySelectorAll('th')[columnIndex];
            const isAscending = th.classList.contains('sort-asc');
            
            // Remove all sort indicators
            table.querySelectorAll('th').forEach(header => {
                header.classList.remove('sort-asc', 'sort-desc');
            });
            
            // Sort rows
            rows.sort((a, b) => {
                const aValue = a.cells[columnIndex].textContent.replace(/[₹,+]/g, '');
                const bValue = b.cells[columnIndex].textContent.replace(/[₹,+]/g, '');
                
                // Handle numeric vs text sorting
                const aNum = parseFloat(aValue);
                const bNum = parseFloat(bValue);
                
                if (!isNaN(aNum) && !isNaN(bNum)) {
                    return isAscending ? bNum - aNum : aNum - bNum;
                } else {
                    return isAscending 
                        ? bValue.localeCompare(aValue)
                        : aValue.localeCompare(bValue);
                }
            });
            
            // Update sort indicator
            th.classList.add(isAscending ? 'sort-desc' : 'sort-asc');
            
            // Re-append sorted rows
            rows.forEach(row => tbody.appendChild(row));
        }

        // Filter results function
        function filterResults() {
            const filter = document.getElementById('resultFilter').value;
            const table = document.getElementById('resultsDataTable');
            if (!table) return;
            
            const rows = table.querySelectorAll('tbody tr');
            
            rows.forEach(row => {
                const status = row.dataset.status;
                
                if (filter === 'all') {
                    row.style.display = '';
                } else if (filter === 'profit' && status === 'win') {
                    row.style.display = '';
                } else if (filter === 'loss' && status === 'loss') {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        }

        // Export to CSV function
        function exportToCSV() {
            const table = document.getElementById('resultsDataTable');
            if (!table) {
                alert('No data to export');
                return;
            }
            
            let csv = [];
            
            // Get headers
            const headers = Array.from(table.querySelectorAll('thead th'))
                .map(th => th.textContent.replace(/\s*\uf0dc/g, ''));
            csv.push(headers.join(','));
            
            // Get data rows
            const rows = table.querySelectorAll('tbody tr');
            rows.forEach(row => {
                const rowData = Array.from(row.cells)
                    .map(cell => {
                        let text = cell.textContent.trim();
                        // Remove currency symbols and clean up
                        text = text.replace(/[₹]/g, '').replace(/^\+/, '');
                        // Wrap in quotes if contains comma
                        if (text.includes(',')) {
                            text = `"${text}"`;
                        }
                        return text;
                    });
                csv.push(rowData.join(','));
            });
            
            // Create download
            const csvContent = csv.join('\n');
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `trade_journey_results_${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        }

        function formatNumber(num) {
            return Math.abs(num).toLocaleString('en-IN', { maximumFractionDigits: 0 });
        }

        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.textContent = message;
            errorDiv.classList.add('active');
        }

        // Auto-run on page load with default dates
        window.addEventListener('load', () => {
            // Try to restore from cache first
            const savedState = loadState();
            
            if (savedState) {
                // Restore form values
                document.getElementById('fromDate').value = savedState.params.fromDate;
                document.getElementById('toDate').value = savedState.params.toDate;
                document.getElementById('trackJourney').checked = savedState.params.trackJourney;
                
                // Display cached results immediately
                displayResults(savedState.data);
                
                // Show cache indicator
                showCacheIndicator();
            } else {
                // Set default dates if no cache
                const today = new Date();
                const oneMonthAgo = new Date(today);
                oneMonthAgo.setMonth(today.getMonth() - 1);
                
                document.getElementById('fromDate').value = oneMonthAgo.toISOString().split('T')[0];
                document.getElementById('toDate').value = today.toISOString().split('T')[0];
            }
        });
    </script>
</body>
</html>